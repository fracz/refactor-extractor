	function walk_tokens(&$tokens, $string_action, $other_action, $register_action=null) {

		$current_comment_id = '';
		$current_string = '';
		$current_string_line = 0;

		$result = '';
		$line = 1;

		foreach($tokens as $token) {
			if (is_array($token)) {
				list($id, $text) = $token;
				$line += substr_count($text, "\n");
				if ((T_ML_COMMENT == $id || T_COMMENT == $id) && preg_match('|/\*\s*(/?WP_I18N_[a-z_]+)\s*\*/|i', $text, $matches)) {
					if ($this->STAGE_OUTSIDE == $stage) {
						$stage = $this->STAGE_START_COMMENT;
						$current_comment_id = $matches[1];
						$this->logmsg('start comment', $current_comment_id);
						$result .= call_user_func($other_action, $token);
						continue;
					}
					if ($this->STAGE_START_COMMENT <= $stage && $stage <= $this->STAGE_WHITESPACE_AFTER && '/'.$current_comment_id == $matches[1]) {
						$stage = $this->STAGE_END_COMMENT;
						$this->logmsg('end comment', $current_comment_id);
						$result .= call_user_func($other_action, $token);
						if (!is_null($register_action)) call_user_func($register_action, $current_string, $current_comment_id, $current_string_line);
						continue;
					}
				} else if (T_CONSTANT_ENCAPSED_STRING == $id) {
					if ($this->STAGE_START_COMMENT <= $stage && $stage < $this->STAGE_WHITESPACE_AFTER) {
						eval('$current_string='.$text.';');
						$this->logmsg('string', $current_string);
						$current_string_line = $line;
						$result .= call_user_func($string_action, $token, $current_string);
						continue;
					}
				} else if (T_WHITESPACE == $id) {
					if ($this->STAGE_START_COMMENT <= $stage && $stage < $this->STAGE_STRING) {
						$stage = $this->STAGE_WHITESPACE_BEFORE;
						$this->logmsg('whitespace before');
						$result .= call_user_func($other_action, $token);
						continue;
					}
					if ($this->STAGE_STRING < $stage && $stage < $this->STAGE_END_COMMENT) {
						$stage = $this->STAGE_WHITESPACE_AFTER;
						$this->logmsg('whitespace after');
						$result .= call_user_func($other_action, $token);
						continue;
					}
				}
			}
			$result .= call_user_func($other_action, $token);
			$stage = $this->STAGE_OUTSIDE;
			$current_comment_id = '';
			$current_string = '';
			$current_string_line = 0;
		}
		return $result;
	}


||||||||||||||||NO_DOC_COMMENTNO_RETURN_TYPE
(NO_PARAM_TYPENO_PARAM_DEFAULTNO_PARAM_TYPENO_PARAM_DEFAULTNO_PARAM_TYPENO_PARAM_DEFAULTNO_PARAM_TYPEPARAM_DEFAULT)
(
    (AST_ASSIGN
        (AST_VAR)
        (SCALAR))
    (AST_ASSIGN
        (AST_VAR)
        (SCALAR))
    (AST_ASSIGN
        (AST_VAR)
        (SCALAR))
    (AST_ASSIGN
        (AST_VAR)
        (SCALAR))
    (AST_ASSIGN
        (AST_VAR)
        (SCALAR))
    (AST_FOREACH
        (AST_VAR)
        (AST_VAR)
        (NULL)
        (
            (AST_IF
                (AST_IF_ELEM
                    (AST_CALL
                        (
                            (AST_VAR)))
                    (
                        (AST_ASSIGN
                            (AST_ARRAY
                                (AST_ARRAY_ELEM
                                    (AST_VAR)
                                    (NULL))
                                (AST_ARRAY_ELEM
                                    (AST_VAR)
                                    (NULL)))
                            (AST_VAR))
                        (AST_ASSIGN_OP
                            (AST_VAR)
                            (AST_CALL
                                (
                                    (AST_VAR)
                                    (SCALAR))))
                        (AST_IF
                            (AST_IF_ELEM
                                (AST_BINARY_OP
                                    (AST_BINARY_OP
                                        (AST_BINARY_OP
                                            (AST_CONST)
                                            (AST_VAR))
                                        (AST_BINARY_OP
                                            (AST_CONST)
                                            (AST_VAR)))
                                    (AST_CALL
                                        (
                                            (SCALAR)
                                            (AST_VAR)
                                            (AST_VAR))))
                                (
                                    (AST_IF
                                        (AST_IF_ELEM
                                            (AST_BINARY_OP
                                                (AST_PROP
                                                    (AST_VAR))
                                                (AST_VAR))
                                            (
                                                (AST_ASSIGN
                                                    (AST_VAR)
                                                    (AST_PROP
                                                        (AST_VAR)))
                                                (AST_ASSIGN
                                                    (AST_VAR)
                                                    (AST_DIM
                                                        (AST_VAR)
                                                        (SCALAR)))
                                                (AST_METHOD_CALL
                                                    (AST_VAR)
                                                    (
                                                        (SCALAR)
                                                        (AST_VAR)))
                                                (AST_ASSIGN_OP
                                                    (AST_VAR)
                                                    (AST_CALL
                                                        (
                                                            (AST_VAR)
                                                            (AST_VAR))))
                                                (AST_CONTINUE
                                                    (NULL)))))
                                    (AST_IF
                                        (AST_IF_ELEM
                                            (AST_BINARY_OP
                                                (AST_BINARY_OP
                                                    (AST_BINARY_OP
                                                        (AST_PROP
                                                            (AST_VAR))
                                                        (AST_VAR))
                                                    (AST_BINARY_OP
                                                        (AST_VAR)
                                                        (AST_PROP
                                                            (AST_VAR))))
                                                (AST_BINARY_OP
                                                    (AST_BINARY_OP
                                                        (SCALAR)
                                                        (AST_VAR))
                                                    (AST_DIM
                                                        (AST_VAR)
                                                        (SCALAR))))
                                            (
                                                (AST_ASSIGN
                                                    (AST_VAR)
                                                    (AST_PROP
                                                        (AST_VAR)))
                                                (AST_METHOD_CALL
                                                    (AST_VAR)
                                                    (
                                                        (SCALAR)
                                                        (AST_VAR)))
                                                (AST_ASSIGN_OP
                                                    (AST_VAR)
                                                    (AST_CALL
                                                        (
                                                            (AST_VAR)
                                                            (AST_VAR))))
                                                (AST_IF
                                                    (AST_IF_ELEM
                                                        (AST_UNARY_OP
                                                            (AST_CALL
                                                                (
                                                                    (AST_VAR))))
                                                        (
                                                            (AST_CALL
                                                                (
                                                                    (AST_VAR)
                                                                    (AST_VAR)
                                                                    (AST_VAR)
                                                                    (AST_VAR))))))
                                                (AST_CONTINUE
                                                    (NULL)))))))
                            (AST_IF_ELEM
                                (NULL)
                                (
                                    (AST_IF
                                        (AST_IF_ELEM
                                            (AST_BINARY_OP
                                                (AST_CONST)
                                                (AST_VAR))
                                            (
                                                (AST_IF
                                                    (AST_IF_ELEM
                                                        (AST_BINARY_OP
                                                            (AST_BINARY_OP
                                                                (AST_PROP
                                                                    (AST_VAR))
                                                                (AST_VAR))
                                                            (AST_BINARY_OP
                                                                (AST_VAR)
                                                                (AST_PROP
                                                                    (AST_VAR))))
                                                        (
                                                            (AST_INCLUDE_OR_EVAL
                                                                (AST_BINARY_OP
                                                                    (AST_BINARY_OP
                                                                        (SCALAR)
                                                                        (AST_VAR))
                                                                    (SCALAR)))
                                                            (AST_METHOD_CALL
                                                                (AST_VAR)
                                                                (
                                                                    (SCALAR)
                                                                    (AST_VAR)))
                                                            (AST_ASSIGN
                                                                (AST_VAR)
                                                                (AST_VAR))
                                                            (AST_ASSIGN_OP
                                                                (AST_VAR)
                                                                (AST_CALL
                                                                    (
                                                                        (AST_VAR)
                                                                        (AST_VAR)
                                                                        (AST_VAR))))
                                                            (AST_CONTINUE
                                                                (NULL)))))))
                                        (AST_IF_ELEM
                                            (NULL)
                                            (
                                                (AST_IF
                                                    (AST_IF_ELEM
                                                        (AST_BINARY_OP
                                                            (AST_CONST)
                                                            (AST_VAR))
                                                        (
                                                            (AST_IF
                                                                (AST_IF_ELEM
                                                                    (AST_BINARY_OP
                                                                        (AST_BINARY_OP
                                                                            (AST_PROP
                                                                                (AST_VAR))
                                                                            (AST_VAR))
                                                                        (AST_BINARY_OP
                                                                            (AST_VAR)
                                                                            (AST_PROP
                                                                                (AST_VAR))))
                                                                    (
                                                                        (AST_ASSIGN
                                                                            (AST_VAR)
                                                                            (AST_PROP
                                                                                (AST_VAR)))
                                                                        (AST_METHOD_CALL
                                                                            (AST_VAR)
                                                                            (
                                                                                (SCALAR)))
                                                                        (AST_ASSIGN_OP
                                                                            (AST_VAR)
                                                                            (AST_CALL
                                                                                (
                                                                                    (AST_VAR)
                                                                                    (AST_VAR))))
                                                                        (AST_CONTINUE
                                                                            (NULL)))))
                                                            (AST_IF
                                                                (AST_IF_ELEM
                                                                    (AST_BINARY_OP
                                                                        (AST_BINARY_OP
                                                                            (AST_PROP
                                                                                (AST_VAR))
                                                                            (AST_VAR))
                                                                        (AST_BINARY_OP
                                                                            (AST_VAR)
                                                                            (AST_PROP
                                                                                (AST_VAR))))
                                                                    (
                                                                        (AST_ASSIGN
                                                                            (AST_VAR)
                                                                            (AST_PROP
                                                                                (AST_VAR)))
                                                                        (AST_METHOD_CALL
                                                                            (AST_VAR)
                                                                            (
                                                                                (SCALAR)))
                                                                        (AST_ASSIGN_OP
                                                                            (AST_VAR)
                                                                            (AST_CALL
                                                                                (
                                                                                    (AST_VAR)
                                                                                    (AST_VAR))))
                                                                        (AST_CONTINUE
                                                                            (NULL)))))))))))))))))
            (AST_ASSIGN_OP
                (AST_VAR)
                (AST_CALL
                    (
                        (AST_VAR)
                        (AST_VAR))))
            (AST_ASSIGN
                (AST_VAR)
                (AST_PROP
                    (AST_VAR)))
            (AST_ASSIGN
                (AST_VAR)
                (SCALAR))
            (AST_ASSIGN
                (AST_VAR)
                (SCALAR))
            (AST_ASSIGN
                (AST_VAR)
                (SCALAR))))
    (AST_RETURN
        (AST_VAR)))||||||||