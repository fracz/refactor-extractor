||||||||    public static function replace(&$html)
    {
        // Replace this:
        // <img src="http[s]://.../tinymce/plugins/emoticons/img/smiley-cool.gif" ... />
        // with this:
        // <img src="/path/on/server/.../tinymce/plugins/emoticons/img/smiley-cool.gif" ... />

        $rcube      = rcube::get_instance();
        $assets_dir = $rcube->config->get('assets_dir');
        $path       = unslashify($assets_dir ?: INSTALL_PATH) . '/' . self::IMG_PATH;
        $offset     = 0;
        $images     = array();

        // remove any null-byte characters before parsing
        $html = preg_replace('/\x00/', '', $html);

        if (preg_match_all('# src=[\'"]([^\'"]+)#', $html, $matches, PREG_OFFSET_CAPTURE)) {
            foreach ($matches[1] as $m) {
                // find emoticon image tags
                if (preg_match('#'. self::IMG_PATH . '(.*)$#', $m[0], $imatches)) {
                    $image_name = $imatches[1];

                    // sanitize image name so resulting attachment doesn't leave images dir
                    $image_name = preg_replace('/[^a-zA-Z0-9_\.\-]/i', '', $image_name);
                    $image_file = $path . $image_name;

                    // Add the same image only once
                    $images[$image_name] = $image_file;

                    $html    = substr_replace($html, $image_file, $m[1] + $offset, strlen($m[0]));
                    $offset += strlen($image_file) - strlen($m[0]);
                }
            }
        }

        return $images;
    }
}||||||||||||||||HAS_DOC_COMMENTNO_RETURN_TYPE
(NO_PARAM_TYPENO_PARAM_DEFAULT)
(
    (AST_ASSIGN
        (AST_VAR)
        (AST_STATIC_CALL))
    (AST_ASSIGN
        (AST_VAR)
        (AST_METHOD_CALL
            (AST_PROP
                (AST_VAR))
            (
                (SCALAR))))
    (AST_ASSIGN
        (AST_VAR)
        (AST_BINARY_OP
            (AST_BINARY_OP
                (AST_CALL
                    (
                        (AST_CONDITIONAL
                            (AST_VAR)
                            (NULL)
                            (AST_CONST))))
                (SCALAR))
            (AST_CLASS_CONST
                (SCALAR))))
    (AST_ASSIGN
        (AST_VAR)
        (SCALAR))
    (AST_ASSIGN
        (AST_VAR)
        (AST_ARRAY))
    (AST_ASSIGN
        (AST_VAR)
        (AST_CALL
            (
                (SCALAR)
                (SCALAR)
                (AST_VAR))))
    (AST_IF
        (AST_IF_ELEM
            (AST_CALL
                (
                    (SCALAR)
                    (AST_VAR)
                    (AST_VAR)
                    (AST_CONST)))
            (
                (AST_FOREACH
                    (AST_DIM
                        (AST_VAR)
                        (SCALAR))
                    (AST_VAR)
                    (NULL)
                    (
                        (AST_IF
                            (AST_IF_ELEM
                                (AST_CALL
                                    (
                                        (AST_BINARY_OP
                                            (AST_BINARY_OP
                                                (SCALAR)
                                                (AST_CLASS_CONST
                                                    (SCALAR)))
                                            (SCALAR))
                                        (AST_DIM
                                            (AST_VAR)
                                            (SCALAR))
                                        (AST_VAR)))
                                (
                                    (AST_ASSIGN
                                        (AST_VAR)
                                        (AST_DIM
                                            (AST_VAR)
                                            (SCALAR)))
                                    (AST_ASSIGN
                                        (AST_VAR)
                                        (AST_CALL
                                            (
                                                (SCALAR)
                                                (SCALAR)
                                                (AST_VAR))))
                                    (AST_ASSIGN
                                        (AST_VAR)
                                        (AST_BINARY_OP
                                            (AST_VAR)
                                            (AST_VAR)))
                                    (AST_ASSIGN
                                        (AST_DIM
                                            (AST_VAR)
                                            (AST_VAR))
                                        (AST_VAR))
                                    (AST_ASSIGN
                                        (AST_VAR)
                                        (AST_CALL
                                            (
                                                (AST_VAR)
                                                (AST_VAR)
                                                (AST_BINARY_OP
                                                    (AST_DIM
                                                        (AST_VAR)
                                                        (SCALAR))
                                                    (AST_VAR))
                                                (AST_CALL
                                                    (
                                                        (AST_DIM
                                                            (AST_VAR)
                                                            (SCALAR)))))))
                                    (AST_ASSIGN_OP
                                        (AST_VAR)
                                        (AST_BINARY_OP
                                            (AST_CALL
                                                (
                                                    (AST_VAR)))
                                            (AST_CALL
                                                (
                                                    (AST_DIM
                                                        (AST_VAR)
                                                        (SCALAR))))))))))))))
    (AST_RETURN
        (AST_VAR)))