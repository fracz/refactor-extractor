	public function sendfile($path, $cb, $pri = EIO_PRI_DEFAULT) {
		$req = $this;
		try {
			$this->header('Content-Type: ' . MIME::get($path));
		} catch (RequestHeadersAlreadySent $e) {}
		if ($this->conn->sendfileCap) {
			$req->ensureSentHeaders();
			$req->conn->onWriteOnce(function($conn) use ($req, $path, $cb, $pri) {
				Daemon::log('sendfile');
				FS::sendfile($req->conn->fd, $path, $cb, 0, null, $pri);
			});
			return;
		}
		$first = true;
		FS::readfileChunked($path, $cb,
			function($file, $chunk) use ($req, &$first) { // readed chunk
				if ($first) {
					try {
						$req->header('Content-Length: ' . $file->stat['size']);
					} catch (RequestHeadersAlreadySent $e) {}
					$first = false;
				}
				$req->out($chunk);
			}
		);
	}

	/**
	 * Called by call() to check if ready
	 * @todo protected?
	 * @return void
	 */
||||||||	public function sendfile($path, $cb, $pri = EIO_PRI_DEFAULT) {
		$req = $this;
		if ($req->state === self::STATE_FINISHED) {
			return;
		}
		try {
			$req->header('Content-Type: ' . MIME::get($path));
		} catch (RequestHeadersAlreadySent $e) {}
		if ($req->upstream->sendfileCap) {
			$req->ensureSentHeaders();
			$req->upstream->onWriteOnce(function($conn) use ($req, $path, $cb, $pri) {
				FS::sendfile($req->upstream->fd, $path, $cb, 0, null, $pri);
			});
			return;
		}
		$first = true;
		FS::readfileChunked($path, $cb,
			function($file, $chunk) use ($req, &$first) { // readed chunk
				if ($first) {
					try {
						$req->header('Content-Length: ' . $file->stat['size']);
					} catch (RequestHeadersAlreadySent $e) {}
					$first = false;
				}
				$req->out($chunk);
			}
		);
	}

	/**
	 * Called by call() to check if ready
	 * @todo protected?
	 * @return void
	 */
||||||||NO_DOC_COMMENTNO_RETURN_TYPE
(NO_PARAM_TYPENO_PARAM_DEFAULTNO_PARAM_TYPENO_PARAM_DEFAULTNO_PARAM_TYPEPARAM_DEFAULT)
(
    (AST_ASSIGN
        (AST_VAR)
        (AST_VAR))
    (AST_TRY
        (
            (AST_METHOD_CALL
                (AST_VAR)
                (
                    (AST_BINARY_OP
                        (SCALAR)
                        (AST_STATIC_CALL
                            (
                                (AST_VAR)))))))
        (AST_CATCH_LIST
            (AST_CATCH
                (AST_NAME_LIST)
                (AST_VAR)))
        (NULL))
    (AST_IF
        (AST_IF_ELEM
            (AST_PROP
                (AST_PROP
                    (AST_VAR)))
            (
                (AST_METHOD_CALL
                    (AST_VAR))
                (AST_METHOD_CALL
                    (AST_PROP
                        (AST_VAR))
                    (
                        (AST_CLOSURE
                            (NO_PARAM_TYPENO_PARAM_DEFAULT)
                            (AST_CLOSURE_USES
                                (AST_CLOSURE_VAR)
                                (AST_CLOSURE_VAR)
                                (AST_CLOSURE_VAR)
                                (AST_CLOSURE_VAR))
                            (
                                (AST_STATIC_CALL
                                    (
                                        (SCALAR)))
                                (AST_STATIC_CALL
                                    (
                                        (AST_PROP
                                            (AST_PROP
                                                (AST_VAR)))
                                        (AST_VAR)
                                        (AST_VAR)
                                        (SCALAR)
                                        (AST_CONST)
                                        (AST_VAR)))))))
                (AST_RETURN
                    (NULL)))))
    (AST_ASSIGN
        (AST_VAR)
        (AST_CONST))
    (AST_STATIC_CALL
        (
            (AST_VAR)
            (AST_VAR)
            (AST_CLOSURE
                (NO_PARAM_TYPENO_PARAM_DEFAULTNO_PARAM_TYPENO_PARAM_DEFAULT)
                (AST_CLOSURE_USES
                    (AST_CLOSURE_VAR)
                    (AST_CLOSURE_VAR))
                (
                    (AST_IF
                        (AST_IF_ELEM
                            (AST_VAR)
                            (
                                (AST_TRY
                                    (
                                        (AST_METHOD_CALL
                                            (AST_VAR)
                                            (
                                                (AST_BINARY_OP
                                                    (SCALAR)
                                                    (AST_DIM
                                                        (AST_PROP
                                                            (AST_VAR))
                                                        (SCALAR))))))
                                    (AST_CATCH_LIST
                                        (AST_CATCH
                                            (AST_NAME_LIST)
                                            (AST_VAR)))
                                    (NULL))
                                (AST_ASSIGN
                                    (AST_VAR)
                                    (AST_CONST)))))
                    (AST_METHOD_CALL
                        (AST_VAR)
                        (
                            (AST_VAR))))))))||||||||NO_DOC_COMMENTNO_RETURN_TYPE
(NO_PARAM_TYPENO_PARAM_DEFAULTNO_PARAM_TYPENO_PARAM_DEFAULTNO_PARAM_TYPEPARAM_DEFAULT)
(
    (AST_ASSIGN
        (AST_VAR)
        (AST_VAR))
    (AST_IF
        (AST_IF_ELEM
            (AST_BINARY_OP
                (AST_PROP
                    (AST_VAR))
                (AST_CLASS_CONST
                    (SCALAR)))
            (
                (AST_RETURN
                    (NULL)))))
    (AST_TRY
        (
            (AST_METHOD_CALL
                (AST_VAR)
                (
                    (AST_BINARY_OP
                        (SCALAR)
                        (AST_STATIC_CALL
                            (
                                (AST_VAR)))))))
        (AST_CATCH_LIST
            (AST_CATCH
                (AST_NAME_LIST)
                (AST_VAR)))
        (NULL))
    (AST_IF
        (AST_IF_ELEM
            (AST_PROP
                (AST_PROP
                    (AST_VAR)))
            (
                (AST_METHOD_CALL
                    (AST_VAR))
                (AST_METHOD_CALL
                    (AST_PROP
                        (AST_VAR))
                    (
                        (AST_CLOSURE
                            (NO_PARAM_TYPENO_PARAM_DEFAULT)
                            (AST_CLOSURE_USES
                                (AST_CLOSURE_VAR)
                                (AST_CLOSURE_VAR)
                                (AST_CLOSURE_VAR)
                                (AST_CLOSURE_VAR))
                            (
                                (AST_STATIC_CALL
                                    (
                                        (AST_PROP
                                            (AST_PROP
                                                (AST_VAR)))
                                        (AST_VAR)
                                        (AST_VAR)
                                        (SCALAR)
                                        (AST_CONST)
                                        (AST_VAR)))))))
                (AST_RETURN
                    (NULL)))))
    (AST_ASSIGN
        (AST_VAR)
        (AST_CONST))
    (AST_STATIC_CALL
        (
            (AST_VAR)
            (AST_VAR)
            (AST_CLOSURE
                (NO_PARAM_TYPENO_PARAM_DEFAULTNO_PARAM_TYPENO_PARAM_DEFAULT)
                (AST_CLOSURE_USES
                    (AST_CLOSURE_VAR)
                    (AST_CLOSURE_VAR))
                (
                    (AST_IF
                        (AST_IF_ELEM
                            (AST_VAR)
                            (
                                (AST_TRY
                                    (
                                        (AST_METHOD_CALL
                                            (AST_VAR)
                                            (
                                                (AST_BINARY_OP
                                                    (SCALAR)
                                                    (AST_DIM
                                                        (AST_PROP
                                                            (AST_VAR))
                                                        (SCALAR))))))
                                    (AST_CATCH_LIST
                                        (AST_CATCH
                                            (AST_NAME_LIST)
                                            (AST_VAR)))
                                    (NULL))
                                (AST_ASSIGN
                                    (AST_VAR)
                                    (AST_CONST)))))
                    (AST_METHOD_CALL
                        (AST_VAR)
                        (
                            (AST_VAR))))))))