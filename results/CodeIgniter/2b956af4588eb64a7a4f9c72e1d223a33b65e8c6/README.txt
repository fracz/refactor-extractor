commit 2b956af4588eb64a7a4f9c72e1d223a33b65e8c6
Author: Andrey Andreev <narf@devilix.net>
Date:   Wed Aug 7 14:32:56 2013 +0300

    An improved version of PR #2584, fixes #2583