  public function didMarkupText() {
    $engine = $this->getEngine();

    $metadata_key = self::KEY_RULE_EMBED_FILE;
    $metadata = $engine->getTextMetadata($metadata_key, array());

    if (!$metadata) {
      return;
    }

    $file_phids = array();
    foreach ($metadata as $phid => $bundles) {
      foreach ($bundles as $data) {

        $options = $data['options'];
        $meta    = $data['meta'];

        if (!$meta['viewable'] || $options['layout'] == 'link') {
          $link = id(new PhabricatorFileLinkView())
            ->setFilePHID($meta['phid'])
            ->setFileName($meta['name'])
            ->setFileDownloadURI($meta['dUri'])
            ->setFileViewURI($meta['uri'])
            ->setFileViewable($meta['viewable']);
          $embed = $link->render();
          $engine->overwriteStoredText($data['token'], $embed);
          continue;
        }

        require_celerity_resource('lightbox-attachment-css');
        $img = phutil_tag('img', $data['attrs']);

        $embed = javelin_tag(
          'a',
          array(
            'href'        => $meta['uri'],
            'class'       => $options['image_class'],
            'sigil'       => 'lightboxable',
            'mustcapture' => true,
            'meta'        => $meta,
          ),
          $img);

        $layout_class = null;
        switch ($options['layout']) {
          case 'right':
          case 'center':
          case 'inline':
          case 'left':
            $layout_class = 'phabricator-remarkup-embed-layout-'.
              $options['layout'];
            break;
          default:
            $layout_class = 'phabricator-remarkup-embed-layout-left';
            break;
        }

        if ($options['float']) {
          switch ($options['layout']) {
            case 'center':
            case 'inline':
              break;
            case 'right':
              $layout_class .= ' phabricator-remarkup-embed-float-right';
              break;
            case 'left':
            default:
              $layout_class .= ' phabricator-remarkup-embed-float-left';
              break;
          }
        }

        if ($layout_class) {
          $embed = phutil_tag(
            'div',
            array(
              'class' => $layout_class,
            ),
            $embed);
        }

        $engine->overwriteStoredText($data['token'], $embed);
      }
      $file_phids[] = $phid;
    }
    $engine->setTextMetadata(self::KEY_EMBED_FILE_PHIDS, $file_phids);
    $engine->setTextMetadata($metadata_key, array());
  }

}||||||||||||||||NO_DOC_COMMENTNO_RETURN_TYPE
(
    (AST_ASSIGN
        (AST_VAR)
        (AST_METHOD_CALL
            (AST_VAR)))
    (AST_ASSIGN
        (AST_VAR)
        (AST_CLASS_CONST
            (SCALAR)))
    (AST_ASSIGN
        (AST_VAR)
        (AST_METHOD_CALL
            (AST_VAR)
            (
                (AST_VAR)
                (AST_ARRAY))))
    (AST_IF
        (AST_IF_ELEM
            (AST_UNARY_OP
                (AST_VAR))
            (
                (AST_RETURN
                    (NULL)))))
    (AST_ASSIGN
        (AST_VAR)
        (AST_ARRAY))
    (AST_FOREACH
        (AST_VAR)
        (AST_VAR)
        (AST_VAR)
        (
            (AST_FOREACH
                (AST_VAR)
                (AST_VAR)
                (NULL)
                (
                    (AST_ASSIGN
                        (AST_VAR)
                        (AST_DIM
                            (AST_VAR)
                            (SCALAR)))
                    (AST_ASSIGN
                        (AST_VAR)
                        (AST_DIM
                            (AST_VAR)
                            (SCALAR)))
                    (AST_IF
                        (AST_IF_ELEM
                            (AST_BINARY_OP
                                (AST_UNARY_OP
                                    (AST_DIM
                                        (AST_VAR)
                                        (SCALAR)))
                                (AST_BINARY_OP
                                    (AST_DIM
                                        (AST_VAR)
                                        (SCALAR))
                                    (SCALAR)))
                            (
                                (AST_ASSIGN
                                    (AST_VAR)
                                    (AST_METHOD_CALL
                                        (AST_METHOD_CALL
                                            (AST_METHOD_CALL
                                                (AST_METHOD_CALL
                                                    (AST_METHOD_CALL
                                                        (AST_CALL
                                                            (
                                                                (AST_NEW)))
                                                        (
                                                            (AST_DIM
                                                                (AST_VAR)
                                                                (SCALAR))))
                                                    (
                                                        (AST_DIM
                                                            (AST_VAR)
                                                            (SCALAR))))
                                                (
                                                    (AST_DIM
                                                        (AST_VAR)
                                                        (SCALAR))))
                                            (
                                                (AST_DIM
                                                    (AST_VAR)
                                                    (SCALAR))))
                                        (
                                            (AST_DIM
                                                (AST_VAR)
                                                (SCALAR)))))
                                (AST_ASSIGN
                                    (AST_VAR)
                                    (AST_METHOD_CALL
                                        (AST_VAR)))
                                (AST_METHOD_CALL
                                    (AST_VAR)
                                    (
                                        (AST_DIM
                                            (AST_VAR)
                                            (SCALAR))
                                        (AST_VAR)))
                                (AST_CONTINUE
                                    (NULL)))))
                    (AST_CALL
                        (
                            (SCALAR)))
                    (AST_ASSIGN
                        (AST_VAR)
                        (AST_CALL
                            (
                                (SCALAR)
                                (AST_DIM
                                    (AST_VAR)
                                    (SCALAR)))))
                    (AST_ASSIGN
                        (AST_VAR)
                        (AST_CALL
                            (
                                (SCALAR)
                                (AST_ARRAY
                                    (AST_ARRAY_ELEM
                                        (AST_DIM
                                            (AST_VAR)
                                            (SCALAR))
                                        (SCALAR))
                                    (AST_ARRAY_ELEM
                                        (AST_DIM
                                            (AST_VAR)
                                            (SCALAR))
                                        (SCALAR))
                                    (AST_ARRAY_ELEM
                                        (SCALAR)
                                        (SCALAR))
                                    (AST_ARRAY_ELEM
                                        (AST_CONST)
                                        (SCALAR))
                                    (AST_ARRAY_ELEM
                                        (AST_VAR)
                                        (SCALAR)))
                                (AST_VAR))))
                    (AST_ASSIGN
                        (AST_VAR)
                        (AST_CONST))
                    (AST_SWITCH
                        (AST_DIM
                            (AST_VAR)
                            (SCALAR))
                        (AST_SWITCH_LIST
                            (AST_SWITCH_CASE
                                (SCALAR))
                            (AST_SWITCH_CASE
                                (SCALAR))
                            (AST_SWITCH_CASE
                                (SCALAR))
                            (AST_SWITCH_CASE
                                (SCALAR)
                                (
                                    (AST_ASSIGN
                                        (AST_VAR)
                                        (AST_BINARY_OP
                                            (SCALAR)
                                            (AST_DIM
                                                (AST_VAR)
                                                (SCALAR))))
                                    (AST_BREAK
                                        (NULL))))
                            (AST_SWITCH_CASE
                                (NULL)
                                (
                                    (AST_ASSIGN
                                        (AST_VAR)
                                        (SCALAR))
                                    (AST_BREAK
                                        (NULL))))))
                    (AST_IF
                        (AST_IF_ELEM
                            (AST_DIM
                                (AST_VAR)
                                (SCALAR))
                            (
                                (AST_SWITCH
                                    (AST_DIM
                                        (AST_VAR)
                                        (SCALAR))
                                    (AST_SWITCH_LIST
                                        (AST_SWITCH_CASE
                                            (SCALAR))
                                        (AST_SWITCH_CASE
                                            (SCALAR)
                                            (
                                                (AST_BREAK
                                                    (NULL))))
                                        (AST_SWITCH_CASE
                                            (SCALAR)
                                            (
                                                (AST_ASSIGN_OP
                                                    (AST_VAR)
                                                    (SCALAR))
                                                (AST_BREAK
                                                    (NULL))))
                                        (AST_SWITCH_CASE
                                            (SCALAR))
                                        (AST_SWITCH_CASE
                                            (NULL)
                                            (
                                                (AST_ASSIGN_OP
                                                    (AST_VAR)
                                                    (SCALAR))
                                                (AST_BREAK
                                                    (NULL)))))))))
                    (AST_IF
                        (AST_IF_ELEM
                            (AST_VAR)
                            (
                                (AST_ASSIGN
                                    (AST_VAR)
                                    (AST_CALL
                                        (
                                            (SCALAR)
                                            (AST_ARRAY
                                                (AST_ARRAY_ELEM
                                                    (AST_VAR)
                                                    (SCALAR)))
                                            (AST_VAR)))))))
                    (AST_METHOD_CALL
                        (AST_VAR)
                        (
                            (AST_DIM
                                (AST_VAR)
                                (SCALAR))
                            (AST_VAR)))))
            (AST_ASSIGN
                (AST_DIM
                    (AST_VAR)
                    (NULL))
                (AST_VAR))))
    (AST_METHOD_CALL
        (AST_VAR)
        (
            (AST_CLASS_CONST
                (SCALAR))
            (AST_VAR)))
    (AST_METHOD_CALL
        (AST_VAR)
        (
            (AST_VAR)
            (AST_ARRAY))))||||||||