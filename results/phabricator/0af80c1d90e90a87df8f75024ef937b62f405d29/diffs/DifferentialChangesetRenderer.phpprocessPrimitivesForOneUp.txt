  private function processPrimitivesForOneUp(array $primitives) {
    // Primitives come out of buildPrimitives() in two-up format, because it
    // is the most general, flexible format. To put them into one-up format,
    // we need to filter and reorder them. In particular:
    //
    //   - We discard unchanged lines in the old file; in one-up format, we
    //     render them only once.
    //   - We group contiguous blocks of old-modified and new-modified lines, so
    //     they render in "block of old, block of new" order instead of
    //     alternating old and new lines.

    $out = array();

    $old_buf = array();
    $new_buf = array();
    foreach ($primitives as $primitive) {
      $type = $primitive['type'];

      if ($type == 'old') {
        if (!$primitive['htype']) {
          // This is a line which appears in both the old file and the new
          // file, or the spacer corresponding to a line added in the new file.
          // Ignore it when rendering a one-up diff.
          continue;
        }
        if ($new_buf) {
          $out[] = $new_buf;
          $new_buf = array();
        }
        $old_buf[] = $primitive;
      } else if ($type == 'new') {
        if ($primitive['line'] === null) {
          // This is an empty spacer corresponding to a line removed from the
          // old file. Ignore it when rendering a one-up diff.
          continue;
        }
        if ($old_buf) {
          $out[] = $old_buf;
          $old_buf = array();
        }
        if (!$primitive['htype']) {
          // If this line is the same in both versions of the file, put it in
          // the old line buffer. This makes sure inlines on old, unchanged
          // lines end up in the right place.

          // First, we need to flush the new line buffer if there's anything
          // in it.
          if ($new_buf) {
            $out[] = $new_buf;
            $new_buf = array();
          }
          $old_buf[] = $primitive;
        } else {
          $new_buf[] = $primitive;
        }
      } else if ($type == 'context' || $type == 'no-context') {
        $out[] = $old_buf;
        $out[] = $new_buf;
        $old_buf = array();
        $new_buf = array();
        $out[] = array($primitive);
      } else if ($type == 'inline') {

        // If this inline is on the left side, put it after the old lines.
        if (!$primitive['right']) {
          $out[] = $old_buf;
          $out[] = array($primitive);
          $out[] = $new_buf;
        } else {
          $out[] = $old_buf;
          $out[] = $new_buf;
          $out[] = array($primitive);
        }

        $old_buf = array();
        $new_buf = array();
      } else {
        throw new Exception("Unknown primitive type '{$primitive}'!");
      }
    }

    $out[] = $old_buf;
    $out[] = $new_buf;
    $out = array_mergev($out);

    return $out;
  }

||||||||  private function processPrimitivesForOneUp(array $primitives) {
    // Primitives come out of buildPrimitives() in two-up format, because it
    // is the most general, flexible format. To put them into one-up format,
    // we need to filter and reorder them. In particular:
    //
    //   - We discard unchanged lines in the old file; in one-up format, we
    //     render them only once.
    //   - We group contiguous blocks of old-modified and new-modified lines, so
    //     they render in "block of old, block of new" order instead of
    //     alternating old and new lines.

    $out = array();

    $old_buf = array();
    $new_buf = array();
    foreach ($primitives as $primitive) {
      $type = $primitive['type'];

      if ($type == 'old') {
        if (!$primitive['htype']) {
          // This is a line which appears in both the old file and the new
          // file, or the spacer corresponding to a line added in the new file.
          // Ignore it when rendering a one-up diff.
          continue;
        }
        $old_buf[] = $primitive;
      } else if ($type == 'new') {
        if ($primitive['line'] === null) {
          // This is an empty spacer corresponding to a line removed from the
          // old file. Ignore it when rendering a one-up diff.
          continue;
        }
        if (!$primitive['htype']) {
          // If this line is the same in both versions of the file, put it in
          // the old line buffer. This makes sure inlines on old, unchanged
          // lines end up in the right place.

          // First, we need to flush the line buffers if they're not empty.
          if ($old_buf) {
            $out[] = $old_buf;
            $old_buf = array();
          }
          if ($new_buf) {
            $out[] = $new_buf;
            $new_buf = array();
          }
          $old_buf[] = $primitive;
        } else {
          $new_buf[] = $primitive;
        }
      } else if ($type == 'context' || $type == 'no-context') {
        $out[] = $old_buf;
        $out[] = $new_buf;
        $old_buf = array();
        $new_buf = array();
        $out[] = array($primitive);
      } else if ($type == 'inline') {

        // If this inline is on the left side, put it after the old lines.
        if (!$primitive['right']) {
          $out[] = $old_buf;
          $out[] = array($primitive);
          $old_buf = array();
        } else {
          $out[] = $old_buf;
          $out[] = $new_buf;
          $out[] = array($primitive);
          $old_buf = array();
          $new_buf = array();
        }

      } else {
        throw new Exception("Unknown primitive type '{$primitive}'!");
      }
    }

    $out[] = $old_buf;
    $out[] = $new_buf;
    $out = array_mergev($out);

    return $out;
  }

||||||||NO_DOC_COMMENTNO_RETURN_TYPE
(PARAM_TYPENO_PARAM_DEFAULT)
(
    (AST_ASSIGN
        (AST_VAR)
        (AST_ARRAY))
    (AST_ASSIGN
        (AST_VAR)
        (AST_ARRAY))
    (AST_ASSIGN
        (AST_VAR)
        (AST_ARRAY))
    (AST_FOREACH
        (AST_VAR)
        (AST_VAR)
        (NULL)
        (
            (AST_ASSIGN
                (AST_VAR)
                (AST_DIM
                    (AST_VAR)
                    (SCALAR)))
            (AST_IF
                (AST_IF_ELEM
                    (AST_BINARY_OP
                        (AST_VAR)
                        (SCALAR))
                    (
                        (AST_IF
                            (AST_IF_ELEM
                                (AST_UNARY_OP
                                    (AST_DIM
                                        (AST_VAR)
                                        (SCALAR)))
                                (
                                    (AST_CONTINUE
                                        (NULL)))))
                        (AST_IF
                            (AST_IF_ELEM
                                (AST_VAR)
                                (
                                    (AST_ASSIGN
                                        (AST_DIM
                                            (AST_VAR)
                                            (NULL))
                                        (AST_VAR))
                                    (AST_ASSIGN
                                        (AST_VAR)
                                        (AST_ARRAY)))))
                        (AST_ASSIGN
                            (AST_DIM
                                (AST_VAR)
                                (NULL))
                            (AST_VAR))))
                (AST_IF_ELEM
                    (NULL)
                    (
                        (AST_IF
                            (AST_IF_ELEM
                                (AST_BINARY_OP
                                    (AST_VAR)
                                    (SCALAR))
                                (
                                    (AST_IF
                                        (AST_IF_ELEM
                                            (AST_BINARY_OP
                                                (AST_DIM
                                                    (AST_VAR)
                                                    (SCALAR))
                                                (AST_CONST))
                                            (
                                                (AST_CONTINUE
                                                    (NULL)))))
                                    (AST_IF
                                        (AST_IF_ELEM
                                            (AST_VAR)
                                            (
                                                (AST_ASSIGN
                                                    (AST_DIM
                                                        (AST_VAR)
                                                        (NULL))
                                                    (AST_VAR))
                                                (AST_ASSIGN
                                                    (AST_VAR)
                                                    (AST_ARRAY)))))
                                    (AST_IF
                                        (AST_IF_ELEM
                                            (AST_UNARY_OP
                                                (AST_DIM
                                                    (AST_VAR)
                                                    (SCALAR)))
                                            (
                                                (AST_IF
                                                    (AST_IF_ELEM
                                                        (AST_VAR)
                                                        (
                                                            (AST_ASSIGN
                                                                (AST_DIM
                                                                    (AST_VAR)
                                                                    (NULL))
                                                                (AST_VAR))
                                                            (AST_ASSIGN
                                                                (AST_VAR)
                                                                (AST_ARRAY)))))
                                                (AST_ASSIGN
                                                    (AST_DIM
                                                        (AST_VAR)
                                                        (NULL))
                                                    (AST_VAR))))
                                        (AST_IF_ELEM
                                            (NULL)
                                            (
                                                (AST_ASSIGN
                                                    (AST_DIM
                                                        (AST_VAR)
                                                        (NULL))
                                                    (AST_VAR)))))))
                            (AST_IF_ELEM
                                (NULL)
                                (
                                    (AST_IF
                                        (AST_IF_ELEM
                                            (AST_BINARY_OP
                                                (AST_BINARY_OP
                                                    (AST_VAR)
                                                    (SCALAR))
                                                (AST_BINARY_OP
                                                    (AST_VAR)
                                                    (SCALAR)))
                                            (
                                                (AST_ASSIGN
                                                    (AST_DIM
                                                        (AST_VAR)
                                                        (NULL))
                                                    (AST_VAR))
                                                (AST_ASSIGN
                                                    (AST_DIM
                                                        (AST_VAR)
                                                        (NULL))
                                                    (AST_VAR))
                                                (AST_ASSIGN
                                                    (AST_VAR)
                                                    (AST_ARRAY))
                                                (AST_ASSIGN
                                                    (AST_VAR)
                                                    (AST_ARRAY))
                                                (AST_ASSIGN
                                                    (AST_DIM
                                                        (AST_VAR)
                                                        (NULL))
                                                    (AST_ARRAY
                                                        (AST_ARRAY_ELEM
                                                            (AST_VAR)
                                                            (NULL))))))
                                        (AST_IF_ELEM
                                            (NULL)
                                            (
                                                (AST_IF
                                                    (AST_IF_ELEM
                                                        (AST_BINARY_OP
                                                            (AST_VAR)
                                                            (SCALAR))
                                                        (
                                                            (AST_IF
                                                                (AST_IF_ELEM
                                                                    (AST_UNARY_OP
                                                                        (AST_DIM
                                                                            (AST_VAR)
                                                                            (SCALAR)))
                                                                    (
                                                                        (AST_ASSIGN
                                                                            (AST_DIM
                                                                                (AST_VAR)
                                                                                (NULL))
                                                                            (AST_VAR))
                                                                        (AST_ASSIGN
                                                                            (AST_DIM
                                                                                (AST_VAR)
                                                                                (NULL))
                                                                            (AST_ARRAY
                                                                                (AST_ARRAY_ELEM
                                                                                    (AST_VAR)
                                                                                    (NULL))))
                                                                        (AST_ASSIGN
                                                                            (AST_DIM
                                                                                (AST_VAR)
                                                                                (NULL))
                                                                            (AST_VAR))))
                                                                (AST_IF_ELEM
                                                                    (NULL)
                                                                    (
                                                                        (AST_ASSIGN
                                                                            (AST_DIM
                                                                                (AST_VAR)
                                                                                (NULL))
                                                                            (AST_VAR))
                                                                        (AST_ASSIGN
                                                                            (AST_DIM
                                                                                (AST_VAR)
                                                                                (NULL))
                                                                            (AST_VAR))
                                                                        (AST_ASSIGN
                                                                            (AST_DIM
                                                                                (AST_VAR)
                                                                                (NULL))
                                                                            (AST_ARRAY
                                                                                (AST_ARRAY_ELEM
                                                                                    (AST_VAR)
                                                                                    (NULL)))))))
                                                            (AST_ASSIGN
                                                                (AST_VAR)
                                                                (AST_ARRAY))
                                                            (AST_ASSIGN
                                                                (AST_VAR)
                                                                (AST_ARRAY))))
                                                    (AST_IF_ELEM
                                                        (NULL)
                                                        (
                                                            (AST_THROW
                                                                (AST_NEW
                                                                    (
                                                                        (AST_ENCAPS_LIST
                                                                            (SCALAR)
                                                                            (AST_VAR)
                                                                            (SCALAR)))))))))))))))))))
    (AST_ASSIGN
        (AST_DIM
            (AST_VAR)
            (NULL))
        (AST_VAR))
    (AST_ASSIGN
        (AST_DIM
            (AST_VAR)
            (NULL))
        (AST_VAR))
    (AST_ASSIGN
        (AST_VAR)
        (AST_CALL
            (
                (AST_VAR))))
    (AST_RETURN
        (AST_VAR)))||||||||NO_DOC_COMMENTNO_RETURN_TYPE
(PARAM_TYPENO_PARAM_DEFAULT)
(
    (AST_ASSIGN
        (AST_VAR)
        (AST_ARRAY))
    (AST_ASSIGN
        (AST_VAR)
        (AST_ARRAY))
    (AST_ASSIGN
        (AST_VAR)
        (AST_ARRAY))
    (AST_FOREACH
        (AST_VAR)
        (AST_VAR)
        (NULL)
        (
            (AST_ASSIGN
                (AST_VAR)
                (AST_DIM
                    (AST_VAR)
                    (SCALAR)))
            (AST_IF
                (AST_IF_ELEM
                    (AST_BINARY_OP
                        (AST_VAR)
                        (SCALAR))
                    (
                        (AST_IF
                            (AST_IF_ELEM
                                (AST_UNARY_OP
                                    (AST_DIM
                                        (AST_VAR)
                                        (SCALAR)))
                                (
                                    (AST_CONTINUE
                                        (NULL)))))
                        (AST_ASSIGN
                            (AST_DIM
                                (AST_VAR)
                                (NULL))
                            (AST_VAR))))
                (AST_IF_ELEM
                    (NULL)
                    (
                        (AST_IF
                            (AST_IF_ELEM
                                (AST_BINARY_OP
                                    (AST_VAR)
                                    (SCALAR))
                                (
                                    (AST_IF
                                        (AST_IF_ELEM
                                            (AST_BINARY_OP
                                                (AST_DIM
                                                    (AST_VAR)
                                                    (SCALAR))
                                                (AST_CONST))
                                            (
                                                (AST_CONTINUE
                                                    (NULL)))))
                                    (AST_IF
                                        (AST_IF_ELEM
                                            (AST_UNARY_OP
                                                (AST_DIM
                                                    (AST_VAR)
                                                    (SCALAR)))
                                            (
                                                (AST_IF
                                                    (AST_IF_ELEM
                                                        (AST_VAR)
                                                        (
                                                            (AST_ASSIGN
                                                                (AST_DIM
                                                                    (AST_VAR)
                                                                    (NULL))
                                                                (AST_VAR))
                                                            (AST_ASSIGN
                                                                (AST_VAR)
                                                                (AST_ARRAY)))))
                                                (AST_IF
                                                    (AST_IF_ELEM
                                                        (AST_VAR)
                                                        (
                                                            (AST_ASSIGN
                                                                (AST_DIM
                                                                    (AST_VAR)
                                                                    (NULL))
                                                                (AST_VAR))
                                                            (AST_ASSIGN
                                                                (AST_VAR)
                                                                (AST_ARRAY)))))
                                                (AST_ASSIGN
                                                    (AST_DIM
                                                        (AST_VAR)
                                                        (NULL))
                                                    (AST_VAR))))
                                        (AST_IF_ELEM
                                            (NULL)
                                            (
                                                (AST_ASSIGN
                                                    (AST_DIM
                                                        (AST_VAR)
                                                        (NULL))
                                                    (AST_VAR)))))))
                            (AST_IF_ELEM
                                (NULL)
                                (
                                    (AST_IF
                                        (AST_IF_ELEM
                                            (AST_BINARY_OP
                                                (AST_BINARY_OP
                                                    (AST_VAR)
                                                    (SCALAR))
                                                (AST_BINARY_OP
                                                    (AST_VAR)
                                                    (SCALAR)))
                                            (
                                                (AST_ASSIGN
                                                    (AST_DIM
                                                        (AST_VAR)
                                                        (NULL))
                                                    (AST_VAR))
                                                (AST_ASSIGN
                                                    (AST_DIM
                                                        (AST_VAR)
                                                        (NULL))
                                                    (AST_VAR))
                                                (AST_ASSIGN
                                                    (AST_VAR)
                                                    (AST_ARRAY))
                                                (AST_ASSIGN
                                                    (AST_VAR)
                                                    (AST_ARRAY))
                                                (AST_ASSIGN
                                                    (AST_DIM
                                                        (AST_VAR)
                                                        (NULL))
                                                    (AST_ARRAY
                                                        (AST_ARRAY_ELEM
                                                            (AST_VAR)
                                                            (NULL))))))
                                        (AST_IF_ELEM
                                            (NULL)
                                            (
                                                (AST_IF
                                                    (AST_IF_ELEM
                                                        (AST_BINARY_OP
                                                            (AST_VAR)
                                                            (SCALAR))
                                                        (
                                                            (AST_IF
                                                                (AST_IF_ELEM
                                                                    (AST_UNARY_OP
                                                                        (AST_DIM
                                                                            (AST_VAR)
                                                                            (SCALAR)))
                                                                    (
                                                                        (AST_ASSIGN
                                                                            (AST_DIM
                                                                                (AST_VAR)
                                                                                (NULL))
                                                                            (AST_VAR))
                                                                        (AST_ASSIGN
                                                                            (AST_DIM
                                                                                (AST_VAR)
                                                                                (NULL))
                                                                            (AST_ARRAY
                                                                                (AST_ARRAY_ELEM
                                                                                    (AST_VAR)
                                                                                    (NULL))))
                                                                        (AST_ASSIGN
                                                                            (AST_VAR)
                                                                            (AST_ARRAY))))
                                                                (AST_IF_ELEM
                                                                    (NULL)
                                                                    (
                                                                        (AST_ASSIGN
                                                                            (AST_DIM
                                                                                (AST_VAR)
                                                                                (NULL))
                                                                            (AST_VAR))
                                                                        (AST_ASSIGN
                                                                            (AST_DIM
                                                                                (AST_VAR)
                                                                                (NULL))
                                                                            (AST_VAR))
                                                                        (AST_ASSIGN
                                                                            (AST_DIM
                                                                                (AST_VAR)
                                                                                (NULL))
                                                                            (AST_ARRAY
                                                                                (AST_ARRAY_ELEM
                                                                                    (AST_VAR)
                                                                                    (NULL))))
                                                                        (AST_ASSIGN
                                                                            (AST_VAR)
                                                                            (AST_ARRAY))
                                                                        (AST_ASSIGN
                                                                            (AST_VAR)
                                                                            (AST_ARRAY)))))))
                                                    (AST_IF_ELEM
                                                        (NULL)
                                                        (
                                                            (AST_THROW
                                                                (AST_NEW
                                                                    (
                                                                        (AST_ENCAPS_LIST
                                                                            (SCALAR)
                                                                            (AST_VAR)
                                                                            (SCALAR)))))))))))))))))))
    (AST_ASSIGN
        (AST_DIM
            (AST_VAR)
            (NULL))
        (AST_VAR))
    (AST_ASSIGN
        (AST_DIM
            (AST_VAR)
            (NULL))
        (AST_VAR))
    (AST_ASSIGN
        (AST_VAR)
        (AST_CALL
            (
                (AST_VAR))))
    (AST_RETURN
        (AST_VAR)))