    function snort($key) {
        // check if the key is valid -> search for users based on key
        $this->loadModel('User');
        // no input sanitization necessary, it's done by model
        $user = $this->User->findByAuthkey($key);
        if (empty($user))
            $this->cakeError('error403', array('message' => 'Incorrect authentication key'));
        // display the full snort rulebase
        $this->header('Content-Type: text/plain');    // set the content type
        $this->header('Content-Disposition: attachment; filename="cydefsig.rules"');
        $this->layout = 'xml/xml'; // LATER better layout than xml

        $rules= array();

        // find events that are finished
        $events = $this->Event->findAllByAlerted(1);


        foreach ($events as $event) {
            # proto src_ip src_port direction dst_ip dst_port msg rule_content tag sid rev
            $rule_format = 'alert %s %s %s %s %s %s (msg: "CyDefSIG %s, Event '.$event['Event']['id'].', '.$event['Event']['risk'].'"; %s %s classtype:targeted-attack; sid:%d; rev:%d; reference:url,'.Configure::read('CyDefSIG.baseurl').'/events/view/'.$event['Event']['id'].';) ';

            $sid = 3000000+($event['Event']['id']*100); // LATER this will cause issues with events containing more than 99 signatures
            //debug($event);
            foreach ($event['Signature'] as $signature) {
                $sid++;
                switch ($signature['type']) {
                    // LATER test all the snort signatures
                    // LATER add the tag keyword in the rules to capture network traffic
                    // LATER sanitize every $signature['value'] to not conflict with snort
                    case 'ip-dst':
                        $rules[] = sprintf($rule_format,
                            'ip',                           // proto
                            '$HOME_NET',                    // src_ip
                            'any',                          // src_port
                            '->',                           // direction
                            $signature['value'],            // dst_ip
                            'any',                          // dst_port
                            'Outgoing To Bad IP',          // msg
                            '',                             // rule_content
                            '',                             // tag
                            $sid,                           // sid
                            1                               // rev
                            );
                        break;
                    case 'ip-src':
                        $rules[] = sprintf($rule_format,
                            'ip',                           // proto
                            $signature['value'],            // src_ip
                            'any',                          // src_port
                            '->',                           // direction
                            '$HOME_NET',                    // dst_ip
                            'any',                          // dst_port
                            'Incoming From Bad IP',        // msg
                            '',                             // rule_content
                            '',                             // tag
                            $sid,                           // sid
                            1                               // rev
                            );
                        break;
                    case 'email-src':
                        $rules[] = sprintf($rule_format,
                            'tcp',                          // proto
                            '$EXTERNAL_NET',                // src_ip
                            'any',                          // src_port
                            '<>',                           // direction
                            '$SMTP_SERVERS',                // dst_ip
                            '25',                           // dst_port
                            'Bad Source Email Address',     // msg
                            'flow:established,to_server; content:"MAIL FROM|3a|"; nocase; content:"'.$signature['value'].'"; nocase;',  // rule_content
                            'tag:session,600,seconds;',     // tag
                            $sid,                           // sid
                            1                               // rev
                            );
                        break;
                    case 'email-dst':
                        $rules[] = sprintf($rule_format,
                            'tcp',                          // proto
                            '$EXTERNAL_NET',                // src_ip
                            'any',                          // src_port
                            '<>',                           // direction
                            '$SMTP_SERVERS',                // dst_ip
                            '25',                           // dst_port
                            'Bad Destination Email Address',// msg
                            'flow:established,to_server; content:"RCPT TO|3a|"; nocase; content:"'.$signature['value'].'"; nocase;',  // rule_content
                        	'tag:session,600,seconds;',     // tag
                            $sid,                           // sid
                            1                               // rev
                            );
                        break;
                    case 'email-subject':
                        // LATER email-subject rule might not match because of line-wrapping
                    	$rules[] = sprintf($rule_format,
                            'tcp',                          // proto
                            '$EXTERNAL_NET',                // src_ip
                            'any',                          // src_port
                            '<>',                           // direction
                            '$SMTP_SERVERS',                // dst_ip
                            '25',                           // dst_port
                            'Bad Email Subject',            // msg
                            'flow:established,to_server; content:"Subject|3a|"; nocase; content:"'.$signature['value'].'"; nocase;',  // rule_content
                    		'tag:session,600,seconds;',     // tag
                            $sid,                           // sid
                            1                               // rev
                            );
                        break;
                    case 'email-attachment':
                        // LATER email-attachment rule might not match because of line-wrapping
                    	$rules[] = sprintf($rule_format,
                            'tcp',                          // proto
                            '$EXTERNAL_NET',                // src_ip
                            'any',                          // src_port
                            '<>',                           // direction
                            '$SMTP_SERVERS',                // dst_ip
                            '25',                           // dst_port
                            'Bad Email Attachment',         // msg
                            'flow:established,to_server; content:"Content-Disposition: attachment|3b| filename=|22|"; content:"'.$signature['value'].'|22|";',  // rule_content   // LATER test and finetune this snort rule https://secure.wikimedia.org/wikipedia/en/wiki/MIME#Content-Disposition
                    		'tag:session,600,seconds;',     // tag
                            $sid,                           // sid
                            1                               // rev
                            );
                        break;
                    case 'domain':
                        $rules[] = sprintf($rule_format,
                            'udp',                          // proto
                            'any',                          // src_ip
                            'any',                          // src_port
                            '->',                           // direction
                            'any',                          // dst_ip
                            '53',                           // dst_port
                            'Lookup Of Bad Domain',         // msg
                            'content:"'.$this->_dnsNameToRawFormat($signature['value']).'"; nocase;',  // rule_content
                        	'',                             // tag
                            $sid,                           // sid
                            1                               // rev
                            );
                        $sid++;
                        $rules[] = sprintf($rule_format,
                            'tcp',                          // proto
                            'any',                          // src_ip
                            'any',                          // src_port
                            '->',                           // direction
                            'any',                          // dst_ip
                            '53',                           // dst_port
                            'Lookup Of Bad Domain',         // msg
                            'content:"'.$this->_dnsNameToRawFormat($signature['value']).'"; nocase;',  // rule_content
                        	'',                             // tag
                            $sid,                           // sid
                            1                               // rev
                            );
                        $sid++;
                        //break; // domain should also detect the domain name in a url
                    case 'url':
                        $rules[] = sprintf($rule_format,
                            'tcp',                          // proto
                            '$HOME_NET',                    // src_ip
                            'any',                          // src_port
                            '->',                           // direction
                            '$EXTERNAL_NET',                // dst_ip
                            '$HTTP_PORTS',                  // dst_port
                            'Outgoing Bad HTTP URL',        // msg
                            'flow:to_server,established; uricontent:"'.$signature['value'].'"; nocase;',  // rule_content
                        	'tag:session,600,seconds;',     // tag
                            $sid,                           // sid
                            1                               // rev
                            );
                        break;
                    case 'user-agent':
                        $rules[] = "";
                        // TODO write snort user-agent rule
                        break;
                    default:
                        break;
                }

            }

        }
        print ("#<h1>This part is not finished and might be buggy. Please report any issues.</h1>\n");

        print "#<pre> \n";
        foreach ($rules as $rule)
        print $rule."\n";
        print "#</pre>\n";

        $this->set('rules', $rules);

    }

    /**
     * // TODO move _dnsNameToRawFormat($name) function to a better place
     * Converts a DNS name to a raw format usable in NIDS like Snort.
     *   example: foobar.com becomes |06|foobar|03|com|00|
     * @param string $name dns name to be converted
     * @return string raw snort compatible format of the dns name
     */
||||||||    function snort($key) {
        $this->redirect(array('action' => 'nids', $key));
    }

||||||||NO_DOC_COMMENTNO_RETURN_TYPE
(NO_PARAM_TYPENO_PARAM_DEFAULT)
(
    (AST_METHOD_CALL
        (AST_VAR)
        (
            (SCALAR)))
    (AST_ASSIGN
        (AST_VAR)
        (AST_METHOD_CALL
            (AST_PROP
                (AST_VAR))
            (
                (AST_VAR))))
    (AST_IF
        (AST_IF_ELEM
            (AST_EMPTY
                (AST_VAR))
            (
                (AST_METHOD_CALL
                    (AST_VAR)
                    (
                        (SCALAR)
                        (AST_ARRAY
                            (AST_ARRAY_ELEM
                                (SCALAR)
                                (SCALAR))))))))
    (AST_METHOD_CALL
        (AST_VAR)
        (
            (SCALAR)))
    (AST_METHOD_CALL
        (AST_VAR)
        (
            (SCALAR)))
    (AST_ASSIGN
        (AST_PROP
            (AST_VAR))
        (SCALAR))
    (AST_ASSIGN
        (AST_VAR)
        (AST_ARRAY))
    (AST_ASSIGN
        (AST_VAR)
        (AST_METHOD_CALL
            (AST_PROP
                (AST_VAR))
            (
                (SCALAR))))
    (AST_FOREACH
        (AST_VAR)
        (AST_VAR)
        (NULL)
        (
            (AST_ASSIGN
                (AST_VAR)
                (AST_BINARY_OP
                    (AST_BINARY_OP
                        (AST_BINARY_OP
                            (AST_BINARY_OP
                                (AST_BINARY_OP
                                    (AST_BINARY_OP
                                        (AST_BINARY_OP
                                            (AST_BINARY_OP
                                                (SCALAR)
                                                (AST_DIM
                                                    (AST_DIM
                                                        (AST_VAR)
                                                        (SCALAR))
                                                    (SCALAR)))
                                            (SCALAR))
                                        (AST_DIM
                                            (AST_DIM
                                                (AST_VAR)
                                                (SCALAR))
                                            (SCALAR)))
                                    (SCALAR))
                                (AST_STATIC_CALL
                                    (
                                        (SCALAR))))
                            (SCALAR))
                        (AST_DIM
                            (AST_DIM
                                (AST_VAR)
                                (SCALAR))
                            (SCALAR)))
                    (SCALAR)))
            (AST_ASSIGN
                (AST_VAR)
                (AST_BINARY_OP
                    (SCALAR)
                    (AST_BINARY_OP
                        (AST_DIM
                            (AST_DIM
                                (AST_VAR)
                                (SCALAR))
                            (SCALAR))
                        (SCALAR))))
            (AST_FOREACH
                (AST_DIM
                    (AST_VAR)
                    (SCALAR))
                (AST_VAR)
                (NULL)
                (
                    (AST_POST_INC
                        (AST_VAR))
                    (AST_SWITCH
                        (AST_DIM
                            (AST_VAR)
                            (SCALAR))
                        (AST_SWITCH_LIST
                            (AST_SWITCH_CASE
                                (SCALAR)
                                (
                                    (AST_ASSIGN
                                        (AST_DIM
                                            (AST_VAR)
                                            (NULL))
                                        (AST_CALL
                                            (
                                                (AST_VAR)
                                                (SCALAR)
                                                (SCALAR)
                                                (SCALAR)
                                                (SCALAR)
                                                (AST_DIM
                                                    (AST_VAR)
                                                    (SCALAR))
                                                (SCALAR)
                                                (SCALAR)
                                                (SCALAR)
                                                (SCALAR)
                                                (AST_VAR)
                                                (SCALAR))))
                                    (AST_BREAK
                                        (NULL))))
                            (AST_SWITCH_CASE
                                (SCALAR)
                                (
                                    (AST_ASSIGN
                                        (AST_DIM
                                            (AST_VAR)
                                            (NULL))
                                        (AST_CALL
                                            (
                                                (AST_VAR)
                                                (SCALAR)
                                                (AST_DIM
                                                    (AST_VAR)
                                                    (SCALAR))
                                                (SCALAR)
                                                (SCALAR)
                                                (SCALAR)
                                                (SCALAR)
                                                (SCALAR)
                                                (SCALAR)
                                                (SCALAR)
                                                (AST_VAR)
                                                (SCALAR))))
                                    (AST_BREAK
                                        (NULL))))
                            (AST_SWITCH_CASE
                                (SCALAR)
                                (
                                    (AST_ASSIGN
                                        (AST_DIM
                                            (AST_VAR)
                                            (NULL))
                                        (AST_CALL
                                            (
                                                (AST_VAR)
                                                (SCALAR)
                                                (SCALAR)
                                                (SCALAR)
                                                (SCALAR)
                                                (SCALAR)
                                                (SCALAR)
                                                (SCALAR)
                                                (AST_BINARY_OP
                                                    (AST_BINARY_OP
                                                        (SCALAR)
                                                        (AST_DIM
                                                            (AST_VAR)
                                                            (SCALAR)))
                                                    (SCALAR))
                                                (SCALAR)
                                                (AST_VAR)
                                                (SCALAR))))
                                    (AST_BREAK
                                        (NULL))))
                            (AST_SWITCH_CASE
                                (SCALAR)
                                (
                                    (AST_ASSIGN
                                        (AST_DIM
                                            (AST_VAR)
                                            (NULL))
                                        (AST_CALL
                                            (
                                                (AST_VAR)
                                                (SCALAR)
                                                (SCALAR)
                                                (SCALAR)
                                                (SCALAR)
                                                (SCALAR)
                                                (SCALAR)
                                                (SCALAR)
                                                (AST_BINARY_OP
                                                    (AST_BINARY_OP
                                                        (SCALAR)
                                                        (AST_DIM
                                                            (AST_VAR)
                                                            (SCALAR)))
                                                    (SCALAR))
                                                (SCALAR)
                                                (AST_VAR)
                                                (SCALAR))))
                                    (AST_BREAK
                                        (NULL))))
                            (AST_SWITCH_CASE
                                (SCALAR)
                                (
                                    (AST_ASSIGN
                                        (AST_DIM
                                            (AST_VAR)
                                            (NULL))
                                        (AST_CALL
                                            (
                                                (AST_VAR)
                                                (SCALAR)
                                                (SCALAR)
                                                (SCALAR)
                                                (SCALAR)
                                                (SCALAR)
                                                (SCALAR)
                                                (SCALAR)
                                                (AST_BINARY_OP
                                                    (AST_BINARY_OP
                                                        (SCALAR)
                                                        (AST_DIM
                                                            (AST_VAR)
                                                            (SCALAR)))
                                                    (SCALAR))
                                                (SCALAR)
                                                (AST_VAR)
                                                (SCALAR))))
                                    (AST_BREAK
                                        (NULL))))
                            (AST_SWITCH_CASE
                                (SCALAR)
                                (
                                    (AST_ASSIGN
                                        (AST_DIM
                                            (AST_VAR)
                                            (NULL))
                                        (AST_CALL
                                            (
                                                (AST_VAR)
                                                (SCALAR)
                                                (SCALAR)
                                                (SCALAR)
                                                (SCALAR)
                                                (SCALAR)
                                                (SCALAR)
                                                (SCALAR)
                                                (AST_BINARY_OP
                                                    (AST_BINARY_OP
                                                        (SCALAR)
                                                        (AST_DIM
                                                            (AST_VAR)
                                                            (SCALAR)))
                                                    (SCALAR))
                                                (SCALAR)
                                                (AST_VAR)
                                                (SCALAR))))
                                    (AST_BREAK
                                        (NULL))))
                            (AST_SWITCH_CASE
                                (SCALAR)
                                (
                                    (AST_ASSIGN
                                        (AST_DIM
                                            (AST_VAR)
                                            (NULL))
                                        (AST_CALL
                                            (
                                                (AST_VAR)
                                                (SCALAR)
                                                (SCALAR)
                                                (SCALAR)
                                                (SCALAR)
                                                (SCALAR)
                                                (SCALAR)
                                                (SCALAR)
                                                (AST_BINARY_OP
                                                    (AST_BINARY_OP
                                                        (SCALAR)
                                                        (AST_METHOD_CALL
                                                            (AST_VAR)
                                                            (
                                                                (AST_DIM
                                                                    (AST_VAR)
                                                                    (SCALAR)))))
                                                    (SCALAR))
                                                (SCALAR)
                                                (AST_VAR)
                                                (SCALAR))))
                                    (AST_POST_INC
                                        (AST_VAR))
                                    (AST_ASSIGN
                                        (AST_DIM
                                            (AST_VAR)
                                            (NULL))
                                        (AST_CALL
                                            (
                                                (AST_VAR)
                                                (SCALAR)
                                                (SCALAR)
                                                (SCALAR)
                                                (SCALAR)
                                                (SCALAR)
                                                (SCALAR)
                                                (SCALAR)
                                                (AST_BINARY_OP
                                                    (AST_BINARY_OP
                                                        (SCALAR)
                                                        (AST_METHOD_CALL
                                                            (AST_VAR)
                                                            (
                                                                (AST_DIM
                                                                    (AST_VAR)
                                                                    (SCALAR)))))
                                                    (SCALAR))
                                                (SCALAR)
                                                (AST_VAR)
                                                (SCALAR))))
                                    (AST_POST_INC
                                        (AST_VAR))))
                            (AST_SWITCH_CASE
                                (SCALAR)
                                (
                                    (AST_ASSIGN
                                        (AST_DIM
                                            (AST_VAR)
                                            (NULL))
                                        (AST_CALL
                                            (
                                                (AST_VAR)
                                                (SCALAR)
                                                (SCALAR)
                                                (SCALAR)
                                                (SCALAR)
                                                (SCALAR)
                                                (SCALAR)
                                                (SCALAR)
                                                (AST_BINARY_OP
                                                    (AST_BINARY_OP
                                                        (SCALAR)
                                                        (AST_DIM
                                                            (AST_VAR)
                                                            (SCALAR)))
                                                    (SCALAR))
                                                (SCALAR)
                                                (AST_VAR)
                                                (SCALAR))))
                                    (AST_BREAK
                                        (NULL))))
                            (AST_SWITCH_CASE
                                (SCALAR)
                                (
                                    (AST_ASSIGN
                                        (AST_DIM
                                            (AST_VAR)
                                            (NULL))
                                        (SCALAR))
                                    (AST_BREAK
                                        (NULL))))
                            (AST_SWITCH_CASE
                                (NULL)
                                (
                                    (AST_BREAK
                                        (NULL))))))))))
    (AST_PRINT
        (SCALAR))
    (AST_PRINT
        (SCALAR))
    (AST_FOREACH
        (AST_VAR)
        (AST_VAR)
        (NULL)
        (
            (AST_PRINT
                (AST_BINARY_OP
                    (AST_VAR)
                    (SCALAR)))))
    (AST_PRINT
        (SCALAR))
    (AST_METHOD_CALL
        (AST_VAR)
        (
            (SCALAR)
            (AST_VAR))))||||||||HAS_DOC_COMMENTNO_RETURN_TYPE
(NO_PARAM_TYPENO_PARAM_DEFAULT)
(
    (AST_METHOD_CALL
        (AST_VAR)
        (
            (AST_ARRAY
                (AST_ARRAY_ELEM
                    (SCALAR)
                    (SCALAR))
                (AST_ARRAY_ELEM
                    (AST_VAR)
                    (NULL))))))