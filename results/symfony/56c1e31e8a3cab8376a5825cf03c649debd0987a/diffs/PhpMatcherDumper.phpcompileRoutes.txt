    private function compileRoutes(RouteCollection $routes, $supportsRedirections, $parentPrefix = null)
    {
        $code = array();

        $routeIterator = $routes->getIterator();
        $keys = array_keys($routeIterator->getArrayCopy());
        $keysCount = count($keys);

        $i = 0;
        foreach ($routeIterator as $name => $route) {
            $i++;

            if ($route instanceof RouteCollection) {
                $prefix = $route->getPrefix();
                $optimizable = $prefix && count($route->all()) > 1 && false === strpos($route->getPrefix(), '{');
                $indent = '';
                if ($optimizable) {
                    for ($j = $i; $j < $keysCount; $j++) {
                        if ($keys[$j] === null) {
                            continue;
                        }

                        $testRoute = $routeIterator->offsetGet($keys[$j]);
                        $isCollection = ($testRoute instanceof RouteCollection);

                        $testPrefix = $isCollection ? $testRoute->getPrefix() : $testRoute->getPattern();

                        if (0 === strpos($testPrefix, $prefix)) {
                            $routeIterator->offsetUnset($keys[$j]);

                            if ($isCollection) {
                                $route->addCollection($testRoute);
                            } else {
                                $route->add($keys[$j], $testRoute);
                            }

                            $i++;
                            $keys[$j] = null;
                        }
                    }

                    if ($prefix !== $parentPrefix) {
                        $code[] = sprintf("        if (0 === strpos(\$pathinfo, %s)) {", var_export($prefix, true));
                        $indent = '    ';
                    }
                }

                foreach ($this->compileRoutes($route, $supportsRedirections, $prefix) as $line) {
                    foreach (explode("\n", $line) as $l) {
                        if ($l) {
                            $code[] = $indent.$l;
                        } else {
                            $code[] = $l;
                        }
                    }
                }

                if ($optimizable && $prefix !== $parentPrefix) {
                    $code[] = "        }\n";
                }
            } else {
                foreach ($this->compileRoute($route, $name, $supportsRedirections, $parentPrefix) as $line) {
                    $code[] = $line;
                }
            }
        }

        return $code;
    }

||||||||    private function compileRoutes(RouteCollection $routes, $supportsRedirections, $parentPrefix = null)
    {
        $code = '';

        $routeIterator = $routes->getIterator();
        $keys = array_keys($routeIterator->getArrayCopy());
        $keysCount = count($keys);

        $i = 0;
        foreach ($routeIterator as $name => $route) {
            $i++;

            if ($route instanceof RouteCollection) {
                $prefix = $route->getPrefix();
                $optimizable = $prefix && count($route->all()) > 1 && false === strpos($route->getPrefix(), '{');
                $optimized = false;

                if ($optimizable) {
                    for ($j = $i; $j < $keysCount; $j++) {
                        if (null === $keys[$j]) {
                            continue;
                        }

                        $testRoute = $routeIterator->offsetGet($keys[$j]);
                        $isCollection = ($testRoute instanceof RouteCollection);

                        $testPrefix = $isCollection ? $testRoute->getPrefix() : $testRoute->getPattern();

                        if (0 === strpos($testPrefix, $prefix)) {
                            $routeIterator->offsetUnset($keys[$j]);

                            if ($isCollection) {
                                $route->addCollection($testRoute);
                            } else {
                                $route->add($keys[$j], $testRoute);
                            }

                            $i++;
                            $keys[$j] = null;
                        }
                    }

                    if ($prefix !== $parentPrefix) {
                        $code .= sprintf("        if (0 === strpos(\$pathinfo, %s)) {\n", var_export($prefix, true));
                        $optimized = true;
                    }
                }

                if ($optimized) {
                    foreach (explode("\n", $this->compileRoutes($route, $supportsRedirections, $prefix)) as $line) {
                        if ('' !== $line) {
                            $code .= '    '; // apply extra indention
                        }
                        $code .= $line."\n";
                    }
                    $code = substr($code, 0, -2); // remove redundant last two line breaks
                    $code .= "        }\n\n";
                } else {
                    $code .= $this->compileRoutes($route, $supportsRedirections, $prefix);
                }
            } else {
                $code .= $this->compileRoute($route, $name, $supportsRedirections, $parentPrefix)."\n";
            }
        }

        return $code;
    }

||||||||NO_DOC_COMMENTNO_RETURN_TYPE
(PARAM_TYPENO_PARAM_DEFAULTNO_PARAM_TYPENO_PARAM_DEFAULTNO_PARAM_TYPEPARAM_DEFAULT)
(
    (AST_ASSIGN
        (AST_VAR)
        (AST_ARRAY))
    (AST_ASSIGN
        (AST_VAR)
        (AST_METHOD_CALL
            (AST_VAR)))
    (AST_ASSIGN
        (AST_VAR)
        (AST_CALL
            (
                (AST_METHOD_CALL
                    (AST_VAR)))))
    (AST_ASSIGN
        (AST_VAR)
        (AST_CALL
            (
                (AST_VAR))))
    (AST_ASSIGN
        (AST_VAR)
        (SCALAR))
    (AST_FOREACH
        (AST_VAR)
        (AST_VAR)
        (AST_VAR)
        (
            (AST_POST_INC
                (AST_VAR))
            (AST_IF
                (AST_IF_ELEM
                    (AST_INSTANCEOF
                        (AST_VAR))
                    (
                        (AST_ASSIGN
                            (AST_VAR)
                            (AST_METHOD_CALL
                                (AST_VAR)))
                        (AST_ASSIGN
                            (AST_VAR)
                            (AST_BINARY_OP
                                (AST_BINARY_OP
                                    (AST_VAR)
                                    (AST_BINARY_OP
                                        (AST_CALL
                                            (
                                                (AST_METHOD_CALL
                                                    (AST_VAR))))
                                        (SCALAR)))
                                (AST_BINARY_OP
                                    (AST_CONST)
                                    (AST_CALL
                                        (
                                            (AST_METHOD_CALL
                                                (AST_VAR))
                                            (SCALAR))))))
                        (AST_ASSIGN
                            (AST_VAR)
                            (SCALAR))
                        (AST_IF
                            (AST_IF_ELEM
                                (AST_VAR)
                                (
                                    (AST_FOR
                                        (AST_EXPR_LIST
                                            (AST_ASSIGN
                                                (AST_VAR)
                                                (AST_VAR)))
                                        (AST_EXPR_LIST
                                            (AST_BINARY_OP
                                                (AST_VAR)
                                                (AST_VAR)))
                                        (AST_EXPR_LIST
                                            (AST_POST_INC
                                                (AST_VAR)))
                                        (
                                            (AST_IF
                                                (AST_IF_ELEM
                                                    (AST_BINARY_OP
                                                        (AST_DIM
                                                            (AST_VAR)
                                                            (AST_VAR))
                                                        (AST_CONST))
                                                    (
                                                        (AST_CONTINUE
                                                            (NULL)))))
                                            (AST_ASSIGN
                                                (AST_VAR)
                                                (AST_METHOD_CALL
                                                    (AST_VAR)
                                                    (
                                                        (AST_DIM
                                                            (AST_VAR)
                                                            (AST_VAR)))))
                                            (AST_ASSIGN
                                                (AST_VAR)
                                                (AST_INSTANCEOF
                                                    (AST_VAR)))
                                            (AST_ASSIGN
                                                (AST_VAR)
                                                (AST_CONDITIONAL
                                                    (AST_VAR)
                                                    (AST_METHOD_CALL
                                                        (AST_VAR))
                                                    (AST_METHOD_CALL
                                                        (AST_VAR))))
                                            (AST_IF
                                                (AST_IF_ELEM
                                                    (AST_BINARY_OP
                                                        (SCALAR)
                                                        (AST_CALL
                                                            (
                                                                (AST_VAR)
                                                                (AST_VAR))))
                                                    (
                                                        (AST_METHOD_CALL
                                                            (AST_VAR)
                                                            (
                                                                (AST_DIM
                                                                    (AST_VAR)
                                                                    (AST_VAR))))
                                                        (AST_IF
                                                            (AST_IF_ELEM
                                                                (AST_VAR)
                                                                (
                                                                    (AST_METHOD_CALL
                                                                        (AST_VAR)
                                                                        (
                                                                            (AST_VAR)))))
                                                            (AST_IF_ELEM
                                                                (NULL)
                                                                (
                                                                    (AST_METHOD_CALL
                                                                        (AST_VAR)
                                                                        (
                                                                            (AST_DIM
                                                                                (AST_VAR)
                                                                                (AST_VAR))
                                                                            (AST_VAR))))))
                                                        (AST_POST_INC
                                                            (AST_VAR))
                                                        (AST_ASSIGN
                                                            (AST_DIM
                                                                (AST_VAR)
                                                                (AST_VAR))
                                                            (AST_CONST)))))))
                                    (AST_IF
                                        (AST_IF_ELEM
                                            (AST_BINARY_OP
                                                (AST_VAR)
                                                (AST_VAR))
                                            (
                                                (AST_ASSIGN
                                                    (AST_DIM
                                                        (AST_VAR)
                                                        (NULL))
                                                    (AST_CALL
                                                        (
                                                            (SCALAR)
                                                            (AST_CALL
                                                                (
                                                                    (AST_VAR)
                                                                    (AST_CONST))))))
                                                (AST_ASSIGN
                                                    (AST_VAR)
                                                    (SCALAR))))))))
                        (AST_FOREACH
                            (AST_METHOD_CALL
                                (AST_VAR)
                                (
                                    (AST_VAR)
                                    (AST_VAR)
                                    (AST_VAR)))
                            (AST_VAR)
                            (NULL)
                            (
                                (AST_FOREACH
                                    (AST_CALL
                                        (
                                            (SCALAR)
                                            (AST_VAR)))
                                    (AST_VAR)
                                    (NULL)
                                    (
                                        (AST_IF
                                            (AST_IF_ELEM
                                                (AST_VAR)
                                                (
                                                    (AST_ASSIGN
                                                        (AST_DIM
                                                            (AST_VAR)
                                                            (NULL))
                                                        (AST_BINARY_OP
                                                            (AST_VAR)
                                                            (AST_VAR)))))
                                            (AST_IF_ELEM
                                                (NULL)
                                                (
                                                    (AST_ASSIGN
                                                        (AST_DIM
                                                            (AST_VAR)
                                                            (NULL))
                                                        (AST_VAR)))))))))
                        (AST_IF
                            (AST_IF_ELEM
                                (AST_BINARY_OP
                                    (AST_VAR)
                                    (AST_BINARY_OP
                                        (AST_VAR)
                                        (AST_VAR)))
                                (
                                    (AST_ASSIGN
                                        (AST_DIM
                                            (AST_VAR)
                                            (NULL))
                                        (SCALAR)))))))
                (AST_IF_ELEM
                    (NULL)
                    (
                        (AST_FOREACH
                            (AST_METHOD_CALL
                                (AST_VAR)
                                (
                                    (AST_VAR)
                                    (AST_VAR)
                                    (AST_VAR)
                                    (AST_VAR)))
                            (AST_VAR)
                            (NULL)
                            (
                                (AST_ASSIGN
                                    (AST_DIM
                                        (AST_VAR)
                                        (NULL))
                                    (AST_VAR)))))))))
    (AST_RETURN
        (AST_VAR)))||||||||NO_DOC_COMMENTNO_RETURN_TYPE
(PARAM_TYPENO_PARAM_DEFAULTNO_PARAM_TYPENO_PARAM_DEFAULTNO_PARAM_TYPEPARAM_DEFAULT)
(
    (AST_ASSIGN
        (AST_VAR)
        (SCALAR))
    (AST_ASSIGN
        (AST_VAR)
        (AST_METHOD_CALL
            (AST_VAR)))
    (AST_ASSIGN
        (AST_VAR)
        (AST_CALL
            (
                (AST_METHOD_CALL
                    (AST_VAR)))))
    (AST_ASSIGN
        (AST_VAR)
        (AST_CALL
            (
                (AST_VAR))))
    (AST_ASSIGN
        (AST_VAR)
        (SCALAR))
    (AST_FOREACH
        (AST_VAR)
        (AST_VAR)
        (AST_VAR)
        (
            (AST_POST_INC
                (AST_VAR))
            (AST_IF
                (AST_IF_ELEM
                    (AST_INSTANCEOF
                        (AST_VAR))
                    (
                        (AST_ASSIGN
                            (AST_VAR)
                            (AST_METHOD_CALL
                                (AST_VAR)))
                        (AST_ASSIGN
                            (AST_VAR)
                            (AST_BINARY_OP
                                (AST_BINARY_OP
                                    (AST_VAR)
                                    (AST_BINARY_OP
                                        (AST_CALL
                                            (
                                                (AST_METHOD_CALL
                                                    (AST_VAR))))
                                        (SCALAR)))
                                (AST_BINARY_OP
                                    (AST_CONST)
                                    (AST_CALL
                                        (
                                            (AST_METHOD_CALL
                                                (AST_VAR))
                                            (SCALAR))))))
                        (AST_ASSIGN
                            (AST_VAR)
                            (AST_CONST))
                        (AST_IF
                            (AST_IF_ELEM
                                (AST_VAR)
                                (
                                    (AST_FOR
                                        (AST_EXPR_LIST
                                            (AST_ASSIGN
                                                (AST_VAR)
                                                (AST_VAR)))
                                        (AST_EXPR_LIST
                                            (AST_BINARY_OP
                                                (AST_VAR)
                                                (AST_VAR)))
                                        (AST_EXPR_LIST
                                            (AST_POST_INC
                                                (AST_VAR)))
                                        (
                                            (AST_IF
                                                (AST_IF_ELEM
                                                    (AST_BINARY_OP
                                                        (AST_CONST)
                                                        (AST_DIM
                                                            (AST_VAR)
                                                            (AST_VAR)))
                                                    (
                                                        (AST_CONTINUE
                                                            (NULL)))))
                                            (AST_ASSIGN
                                                (AST_VAR)
                                                (AST_METHOD_CALL
                                                    (AST_VAR)
                                                    (
                                                        (AST_DIM
                                                            (AST_VAR)
                                                            (AST_VAR)))))
                                            (AST_ASSIGN
                                                (AST_VAR)
                                                (AST_INSTANCEOF
                                                    (AST_VAR)))
                                            (AST_ASSIGN
                                                (AST_VAR)
                                                (AST_CONDITIONAL
                                                    (AST_VAR)
                                                    (AST_METHOD_CALL
                                                        (AST_VAR))
                                                    (AST_METHOD_CALL
                                                        (AST_VAR))))
                                            (AST_IF
                                                (AST_IF_ELEM
                                                    (AST_BINARY_OP
                                                        (SCALAR)
                                                        (AST_CALL
                                                            (
                                                                (AST_VAR)
                                                                (AST_VAR))))
                                                    (
                                                        (AST_METHOD_CALL
                                                            (AST_VAR)
                                                            (
                                                                (AST_DIM
                                                                    (AST_VAR)
                                                                    (AST_VAR))))
                                                        (AST_IF
                                                            (AST_IF_ELEM
                                                                (AST_VAR)
                                                                (
                                                                    (AST_METHOD_CALL
                                                                        (AST_VAR)
                                                                        (
                                                                            (AST_VAR)))))
                                                            (AST_IF_ELEM
                                                                (NULL)
                                                                (
                                                                    (AST_METHOD_CALL
                                                                        (AST_VAR)
                                                                        (
                                                                            (AST_DIM
                                                                                (AST_VAR)
                                                                                (AST_VAR))
                                                                            (AST_VAR))))))
                                                        (AST_POST_INC
                                                            (AST_VAR))
                                                        (AST_ASSIGN
                                                            (AST_DIM
                                                                (AST_VAR)
                                                                (AST_VAR))
                                                            (AST_CONST)))))))
                                    (AST_IF
                                        (AST_IF_ELEM
                                            (AST_BINARY_OP
                                                (AST_VAR)
                                                (AST_VAR))
                                            (
                                                (AST_ASSIGN_OP
                                                    (AST_VAR)
                                                    (AST_CALL
                                                        (
                                                            (SCALAR)
                                                            (AST_CALL
                                                                (
                                                                    (AST_VAR)
                                                                    (AST_CONST))))))
                                                (AST_ASSIGN
                                                    (AST_VAR)
                                                    (AST_CONST))))))))
                        (AST_IF
                            (AST_IF_ELEM
                                (AST_VAR)
                                (
                                    (AST_FOREACH
                                        (AST_CALL
                                            (
                                                (SCALAR)
                                                (AST_METHOD_CALL
                                                    (AST_VAR)
                                                    (
                                                        (AST_VAR)
                                                        (AST_VAR)
                                                        (AST_VAR)))))
                                        (AST_VAR)
                                        (NULL)
                                        (
                                            (AST_IF
                                                (AST_IF_ELEM
                                                    (AST_BINARY_OP
                                                        (SCALAR)
                                                        (AST_VAR))
                                                    (
                                                        (AST_ASSIGN_OP
                                                            (AST_VAR)
                                                            (SCALAR)))))
                                            (AST_ASSIGN_OP
                                                (AST_VAR)
                                                (AST_BINARY_OP
                                                    (AST_VAR)
                                                    (SCALAR)))))
                                    (AST_ASSIGN
                                        (AST_VAR)
                                        (AST_CALL
                                            (
                                                (AST_VAR)
                                                (SCALAR)
                                                (AST_UNARY_OP
                                                    (SCALAR)))))
                                    (AST_ASSIGN_OP
                                        (AST_VAR)
                                        (SCALAR))))
                            (AST_IF_ELEM
                                (NULL)
                                (
                                    (AST_ASSIGN_OP
                                        (AST_VAR)
                                        (AST_METHOD_CALL
                                            (AST_VAR)
                                            (
                                                (AST_VAR)
                                                (AST_VAR)
                                                (AST_VAR)))))))))
                (AST_IF_ELEM
                    (NULL)
                    (
                        (AST_ASSIGN_OP
                            (AST_VAR)
                            (AST_BINARY_OP
                                (AST_METHOD_CALL
                                    (AST_VAR)
                                    (
                                        (AST_VAR)
                                        (AST_VAR)
                                        (AST_VAR)
                                        (AST_VAR)))
                                (SCALAR))))))))
    (AST_RETURN
        (AST_VAR)))