    private static function find_files($files = array(), $type = 'css', $bypass_inheritance = false)
    {
        // Grab the theme paths from the template library.
        $paths         = Template::get('theme_paths');
        $site_path     = Template::get('site_path');
        $active_theme  = Template::get('active_theme');
        $default_theme = Template::get('default_theme');

        $new_files  = array();
        $clean_type = $type;
        $type       = ".{$type}";
        if (self::$debug) {
            echo "Active Theme = {$active_theme}<br/>
                Default Theme = {$default_theme}<br/>
                Site Path = {$site_path}<br/>
                File(s) to find: ";
            print_r($files);
        }

        // Check for HTTPS or HTTP connection
        $http_protocol = is_https() ? 'https' : 'http';

        // Is the language moving right to left?
        $rtl = self::$rtl_postfix;
        $rtl_set = lang('bf_language_direction') == $rtl;

        foreach ($files as &$file) {
            // If it's an array, $file is css and has both 'file' and 'media'
            // keys. Store them for later use.
            if (is_array($file)) {
                if ($type == '.css') {
                    $media = $file['media'];
                }
                $module = isset($file['module']) ? $file['module'] : '';
                $file = $file['file'];
            }

            $file = (string)$file;

            // Strip out the file type for consistency
            // Using strripos and substr because rtrim was giving some odd
            // results (for instance, rtrim('tickets.js', '.js');
            // would return 'ticket')
            $pos = strripos($file, $type);
            if ($pos !== false) {
                $file = substr($file, 0, $pos);
            }

            // If it contains an external URL, there's nothing more to do
            if (strpos($file, $http_protocol . ':') !== false   // Absolute URL with current protocol, which should be more likely
                    || strpos($file, '//') === 0                // Protocol-relative URL
                    || strpos($file, 'https:') !== false        // We should assume $http_protocol is most likely 'http', so check 'https' next
                    || strpos($file, 'http:') !== false         // Finally, check 'http' in case $http_protocol is 'https'
               ) {
                $new_files[] = empty($media) ? $file : array('file' => $file, 'media' => $media);
                continue;
            }

            $found = false;

            // Non-module files
            if (empty($module)) {
                $media = empty($media) ? '' : $media;
                // Check all possible theme paths
                foreach ($paths as $path) {
                    if (self::$debug) {
                        echo "[Assets] Looking in:
                            <ul>
                                <li>{$site_path}{$path}/{$default_theme}{$file}{$type}</li>
                                <li>{$site_path}{$path}/{$default_theme}{$clean_type}/{$file}{$type}</li>";

                        if (! empty($active_theme)) {
                            echo "
                                <li>{$site_path}{$path}/{$active_theme}{$file}{$type}</li>
                                <li>{$site_path}{$path}/{$active_theme}{$clean_type}/{$file}{$type}</li>";
                        }

                        echo "
                                <li>{$site_path}" . self::$directories['base'] . "/{$clean_type}/{$file}{$type}</li>
                            </ul>" . PHP_EOL;
                    }

                    // DEFAULT THEME
                    // First, check the default theme. Add found files to the
                    // array. Anything in the active theme will override it.
                    //
                    // If $default_theme and $active_theme are the same,
                    // checking $default_theme would just repeat the
                    // $active_theme section, resulting in duplicates
                    if (! $bypass_inheritance && $default_theme !== $active_theme) {
                        if ($file_array = self::get_file_array($site_path, "{$path}/{$default_theme}", $file, $type, $media)) {
                            $new_files[] = $file_array;
                            $found = true;
                        } elseif ($file_array = self::get_file_array($site_path, "{$path}/{$default_theme}{$clean_type}/", $file, $type, $media)) {
                            // If it wasn't in the root, check the $type sub-folder
                            $new_files[] = $file_array;
                            $found = true;
                        }
                    }
                    // ACTIVE THEME
                    // By grabbing a copy from both $default_theme and
                    // $active_theme, simple CSS-only overrides for a theme are
                    // supported, completely changing appearance through a
                    // simple child CSS file
                    if (! empty($active_theme)) { // separated this because the elseif below should not run if $active_theme is empty
                        if ($file_array = self::get_file_array($site_path, "{$path}/{$active_theme}", $file, $type, $media)) {
                            $new_files[] = $file_array;
                            $found = true;
                        } elseif ($file_array = self::get_file_array($site_path, "{$path}/{$active_theme}{$clean_type}/", $file, $type, $media)) {
                            // If it wasn't in the root, check the $type sub-folder
                            $new_files[] = $file_array;
                            $found = true;
                        }
                    }
                    // ASSET BASE
                    // If the file hasn't been found, yet, look in the
                    // 'assets.base_folder'
                    if (! $found) {
                        // Assets/type folder
                        if ($file_array = self::get_file_array($site_path, self::$directories['base'] . "/{$clean_type}/", $file, $type, $media)) {
                            $new_files[] = $file_array;
                        } elseif ($file_array = self::get_file_array($site_path, self::$directories['base'] . '/', $file, $type, $media)) {
                            // ASSETS ROOT
                            // One last check to see if it's under assets without
                            // the type sub-folder. Useful for keeping script
                            // collections together
                            $new_files[] = $file_array;
                        }
                    } // if (!$found)
                } // foreach ($paths as $path)
            } else {
                // Module Files
                $file_path_name = $file;

                // Try the /module/assets folder
                $path = Modules::file_path($module, self::$directories['base'], $file_path_name . $type);

                // If $path is empty, try the /module/assets/type folder
                if (empty($path)) {
                    $file_path_name = "{$clean_type}/{$file}";
                    $path = Modules::file_path($module, self::$directories['base'], $file_path_name . $type);
                }

                // If the language is right-to-left, add -rtl to the file name
                if (! empty($path) && $rtl_set) {
                    $path_rtl = Modules::file_path($module, self::$directories['base'], "{$file_path_name}-{$rtl}{$type}");
                    if (! empty($path_rtl)) {
                        $path = $path_rtl;
                    }
                }

                if (self::$debug) {
                    echo "[Assets] Looking for MODULE asset at: {$path}<br/>" . PHP_EOL;
                }

                // If the file was found, add it to the array for output
                if (! empty($path)) {
                    $file = array(
                        'file'          => '',
                        'server_path'   => $path
                    );
                    if (isset($media)) {
                        $file['media'] = $media;
                    }

                    $new_files[] = $file;
                }
            }
        } //end foreach

        return $new_files;
    }

    /**
     * Get the file array for a given file and path.
     *
     * @param string $sitePath The base server path.
     * @param string $path     The path to the file (appended to base_url() and $site_path).
     * @param string $file     The name of the file, without the extension.
     * @param string $type     File extension, including '.'.
     * @param string $media    media type, e.g. 'screen' or 'print'.
     *
     * @return mixed    false if the file wasn't found, the URL of the file if
     * $media is empty, or an array containing the file (URL), media, and server
     * path.
     */
||||||||||||||||HAS_DOC_COMMENTNO_RETURN_TYPE
(NO_PARAM_TYPEPARAM_DEFAULTNO_PARAM_TYPEPARAM_DEFAULTNO_PARAM_TYPEPARAM_DEFAULT)
(
    (AST_ASSIGN
        (AST_VAR)
        (AST_STATIC_CALL
            (
                (SCALAR))))
    (AST_ASSIGN
        (AST_VAR)
        (AST_STATIC_CALL
            (
                (SCALAR))))
    (AST_ASSIGN
        (AST_VAR)
        (AST_STATIC_CALL
            (
                (SCALAR))))
    (AST_ASSIGN
        (AST_VAR)
        (AST_STATIC_CALL
            (
                (SCALAR))))
    (AST_ASSIGN
        (AST_VAR)
        (AST_ARRAY))
    (AST_ASSIGN
        (AST_VAR)
        (AST_VAR))
    (AST_ASSIGN
        (AST_VAR)
        (AST_ENCAPS_LIST
            (SCALAR)
            (AST_VAR)))
    (AST_IF
        (AST_IF_ELEM
            (AST_STATIC_PROP)
            (
                (AST_ECHO
                    (AST_ENCAPS_LIST
                        (SCALAR)
                        (AST_VAR)
                        (SCALAR)
                        (AST_VAR)
                        (SCALAR)
                        (AST_VAR)
                        (SCALAR)))
                (AST_CALL
                    (
                        (AST_VAR))))))
    (AST_ASSIGN
        (AST_VAR)
        (AST_CONDITIONAL
            (AST_CALL)
            (SCALAR)
            (SCALAR)))
    (AST_ASSIGN
        (AST_VAR)
        (AST_STATIC_PROP))
    (AST_ASSIGN
        (AST_VAR)
        (AST_BINARY_OP
            (AST_CALL
                (
                    (SCALAR)))
            (AST_VAR)))
    (AST_FOREACH
        (AST_VAR)
        (AST_REF
            (AST_VAR))
        (NULL)
        (
            (AST_IF
                (AST_IF_ELEM
                    (AST_CALL
                        (
                            (AST_VAR)))
                    (
                        (AST_IF
                            (AST_IF_ELEM
                                (AST_BINARY_OP
                                    (AST_VAR)
                                    (SCALAR))
                                (
                                    (AST_ASSIGN
                                        (AST_VAR)
                                        (AST_DIM
                                            (AST_VAR)
                                            (SCALAR))))))
                        (AST_ASSIGN
                            (AST_VAR)
                            (AST_CONDITIONAL
                                (AST_ISSET
                                    (AST_DIM
                                        (AST_VAR)
                                        (SCALAR)))
                                (AST_DIM
                                    (AST_VAR)
                                    (SCALAR))
                                (SCALAR)))
                        (AST_ASSIGN
                            (AST_VAR)
                            (AST_DIM
                                (AST_VAR)
                                (SCALAR))))))
            (AST_ASSIGN
                (AST_VAR)
                (AST_CAST
                    (AST_VAR)))
            (AST_ASSIGN
                (AST_VAR)
                (AST_CALL
                    (
                        (AST_VAR)
                        (AST_VAR))))
            (AST_IF
                (AST_IF_ELEM
                    (AST_BINARY_OP
                        (AST_VAR)
                        (AST_CONST))
                    (
                        (AST_ASSIGN
                            (AST_VAR)
                            (AST_CALL
                                (
                                    (AST_VAR)
                                    (SCALAR)
                                    (AST_VAR)))))))
            (AST_IF
                (AST_IF_ELEM
                    (AST_BINARY_OP
                        (AST_BINARY_OP
                            (AST_BINARY_OP
                                (AST_BINARY_OP
                                    (AST_CALL
                                        (
                                            (AST_VAR)
                                            (AST_BINARY_OP
                                                (AST_VAR)
                                                (SCALAR))))
                                    (AST_CONST))
                                (AST_BINARY_OP
                                    (AST_CALL
                                        (
                                            (AST_VAR)
                                            (SCALAR)))
                                    (SCALAR)))
                            (AST_BINARY_OP
                                (AST_CALL
                                    (
                                        (AST_VAR)
                                        (SCALAR)))
                                (AST_CONST)))
                        (AST_BINARY_OP
                            (AST_CALL
                                (
                                    (AST_VAR)
                                    (SCALAR)))
                            (AST_CONST)))
                    (
                        (AST_ASSIGN
                            (AST_DIM
                                (AST_VAR)
                                (NULL))
                            (AST_CONDITIONAL
                                (AST_EMPTY
                                    (AST_VAR))
                                (AST_VAR)
                                (AST_ARRAY
                                    (AST_ARRAY_ELEM
                                        (AST_VAR)
                                        (SCALAR))
                                    (AST_ARRAY_ELEM
                                        (AST_VAR)
                                        (SCALAR)))))
                        (AST_CONTINUE
                            (NULL)))))
            (AST_ASSIGN
                (AST_VAR)
                (AST_CONST))
            (AST_IF
                (AST_IF_ELEM
                    (AST_EMPTY
                        (AST_VAR))
                    (
                        (AST_ASSIGN
                            (AST_VAR)
                            (AST_CONDITIONAL
                                (AST_EMPTY
                                    (AST_VAR))
                                (SCALAR)
                                (AST_VAR)))
                        (AST_FOREACH
                            (AST_VAR)
                            (AST_VAR)
                            (NULL)
                            (
                                (AST_IF
                                    (AST_IF_ELEM
                                        (AST_STATIC_PROP)
                                        (
                                            (AST_ECHO
                                                (AST_ENCAPS_LIST
                                                    (SCALAR)
                                                    (AST_VAR)
                                                    (AST_VAR)
                                                    (SCALAR)
                                                    (AST_VAR)
                                                    (AST_VAR)
                                                    (AST_VAR)
                                                    (SCALAR)
                                                    (AST_VAR)
                                                    (AST_VAR)
                                                    (SCALAR)
                                                    (AST_VAR)
                                                    (AST_VAR)
                                                    (SCALAR)
                                                    (AST_VAR)
                                                    (AST_VAR)
                                                    (SCALAR)))
                                            (AST_IF
                                                (AST_IF_ELEM
                                                    (AST_UNARY_OP
                                                        (AST_EMPTY
                                                            (AST_VAR)))
                                                    (
                                                        (AST_ECHO
                                                            (AST_ENCAPS_LIST
                                                                (SCALAR)
                                                                (AST_VAR)
                                                                (AST_VAR)
                                                                (SCALAR)
                                                                (AST_VAR)
                                                                (AST_VAR)
                                                                (AST_VAR)
                                                                (SCALAR)
                                                                (AST_VAR)
                                                                (AST_VAR)
                                                                (SCALAR)
                                                                (AST_VAR)
                                                                (AST_VAR)
                                                                (SCALAR)
                                                                (AST_VAR)
                                                                (AST_VAR)
                                                                (SCALAR))))))
                                            (AST_ECHO
                                                (AST_BINARY_OP
                                                    (AST_BINARY_OP
                                                        (AST_BINARY_OP
                                                            (AST_ENCAPS_LIST
                                                                (SCALAR)
                                                                (AST_VAR))
                                                            (AST_DIM
                                                                (AST_STATIC_PROP)
                                                                (SCALAR)))
                                                        (AST_ENCAPS_LIST
                                                            (SCALAR)
                                                            (AST_VAR)
                                                            (SCALAR)
                                                            (AST_VAR)
                                                            (AST_VAR)
                                                            (SCALAR)))
                                                    (AST_CONST))))))
                                (AST_IF
                                    (AST_IF_ELEM
                                        (AST_BINARY_OP
                                            (AST_UNARY_OP
                                                (AST_VAR))
                                            (AST_BINARY_OP
                                                (AST_VAR)
                                                (AST_VAR)))
                                        (
                                            (AST_IF
                                                (AST_IF_ELEM
                                                    (AST_ASSIGN
                                                        (AST_VAR)
                                                        (AST_STATIC_CALL
                                                            (
                                                                (AST_VAR)
                                                                (AST_ENCAPS_LIST
                                                                    (AST_VAR)
                                                                    (SCALAR)
                                                                    (AST_VAR))
                                                                (AST_VAR)
                                                                (AST_VAR)
                                                                (AST_VAR))))
                                                    (
                                                        (AST_ASSIGN
                                                            (AST_DIM
                                                                (AST_VAR)
                                                                (NULL))
                                                            (AST_VAR))
                                                        (AST_ASSIGN
                                                            (AST_VAR)
                                                            (AST_CONST))))
                                                (AST_IF_ELEM
                                                    (AST_ASSIGN
                                                        (AST_VAR)
                                                        (AST_STATIC_CALL
                                                            (
                                                                (AST_VAR)
                                                                (AST_ENCAPS_LIST
                                                                    (AST_VAR)
                                                                    (SCALAR)
                                                                    (AST_VAR)
                                                                    (AST_VAR)
                                                                    (SCALAR))
                                                                (AST_VAR)
                                                                (AST_VAR)
                                                                (AST_VAR))))
                                                    (
                                                        (AST_ASSIGN
                                                            (AST_DIM
                                                                (AST_VAR)
                                                                (NULL))
                                                            (AST_VAR))
                                                        (AST_ASSIGN
                                                            (AST_VAR)
                                                            (AST_CONST))))))))
                                (AST_IF
                                    (AST_IF_ELEM
                                        (AST_UNARY_OP
                                            (AST_EMPTY
                                                (AST_VAR)))
                                        (
                                            (AST_IF
                                                (AST_IF_ELEM
                                                    (AST_ASSIGN
                                                        (AST_VAR)
                                                        (AST_STATIC_CALL
                                                            (
                                                                (AST_VAR)
                                                                (AST_ENCAPS_LIST
                                                                    (AST_VAR)
                                                                    (SCALAR)
                                                                    (AST_VAR))
                                                                (AST_VAR)
                                                                (AST_VAR)
                                                                (AST_VAR))))
                                                    (
                                                        (AST_ASSIGN
                                                            (AST_DIM
                                                                (AST_VAR)
                                                                (NULL))
                                                            (AST_VAR))
                                                        (AST_ASSIGN
                                                            (AST_VAR)
                                                            (AST_CONST))))
                                                (AST_IF_ELEM
                                                    (AST_ASSIGN
                                                        (AST_VAR)
                                                        (AST_STATIC_CALL
                                                            (
                                                                (AST_VAR)
                                                                (AST_ENCAPS_LIST
                                                                    (AST_VAR)
                                                                    (SCALAR)
                                                                    (AST_VAR)
                                                                    (AST_VAR)
                                                                    (SCALAR))
                                                                (AST_VAR)
                                                                (AST_VAR)
                                                                (AST_VAR))))
                                                    (
                                                        (AST_ASSIGN
                                                            (AST_DIM
                                                                (AST_VAR)
                                                                (NULL))
                                                            (AST_VAR))
                                                        (AST_ASSIGN
                                                            (AST_VAR)
                                                            (AST_CONST))))))))
                                (AST_IF
                                    (AST_IF_ELEM
                                        (AST_UNARY_OP
                                            (AST_VAR))
                                        (
                                            (AST_IF
                                                (AST_IF_ELEM
                                                    (AST_ASSIGN
                                                        (AST_VAR)
                                                        (AST_STATIC_CALL
                                                            (
                                                                (AST_VAR)
                                                                (AST_BINARY_OP
                                                                    (AST_DIM
                                                                        (AST_STATIC_PROP)
                                                                        (SCALAR))
                                                                    (AST_ENCAPS_LIST
                                                                        (SCALAR)
                                                                        (AST_VAR)
                                                                        (SCALAR)))
                                                                (AST_VAR)
                                                                (AST_VAR)
                                                                (AST_VAR))))
                                                    (
                                                        (AST_ASSIGN
                                                            (AST_DIM
                                                                (AST_VAR)
                                                                (NULL))
                                                            (AST_VAR))))
                                                (AST_IF_ELEM
                                                    (AST_ASSIGN
                                                        (AST_VAR)
                                                        (AST_STATIC_CALL
                                                            (
                                                                (AST_VAR)
                                                                (AST_BINARY_OP
                                                                    (AST_DIM
                                                                        (AST_STATIC_PROP)
                                                                        (SCALAR))
                                                                    (SCALAR))
                                                                (AST_VAR)
                                                                (AST_VAR)
                                                                (AST_VAR))))
                                                    (
                                                        (AST_ASSIGN
                                                            (AST_DIM
                                                                (AST_VAR)
                                                                (NULL))
                                                            (AST_VAR))))))))))))
                (AST_IF_ELEM
                    (NULL)
                    (
                        (AST_ASSIGN
                            (AST_VAR)
                            (AST_VAR))
                        (AST_ASSIGN
                            (AST_VAR)
                            (AST_STATIC_CALL
                                (
                                    (AST_VAR)
                                    (AST_DIM
                                        (AST_STATIC_PROP)
                                        (SCALAR))
                                    (AST_BINARY_OP
                                        (AST_VAR)
                                        (AST_VAR)))))
                        (AST_IF
                            (AST_IF_ELEM
                                (AST_EMPTY
                                    (AST_VAR))
                                (
                                    (AST_ASSIGN
                                        (AST_VAR)
                                        (AST_ENCAPS_LIST
                                            (AST_VAR)
                                            (SCALAR)
                                            (AST_VAR)))
                                    (AST_ASSIGN
                                        (AST_VAR)
                                        (AST_STATIC_CALL
                                            (
                                                (AST_VAR)
                                                (AST_DIM
                                                    (AST_STATIC_PROP)
                                                    (SCALAR))
                                                (AST_BINARY_OP
                                                    (AST_VAR)
                                                    (AST_VAR))))))))
                        (AST_IF
                            (AST_IF_ELEM
                                (AST_BINARY_OP
                                    (AST_UNARY_OP
                                        (AST_EMPTY
                                            (AST_VAR)))
                                    (AST_VAR))
                                (
                                    (AST_ASSIGN
                                        (AST_VAR)
                                        (AST_STATIC_CALL
                                            (
                                                (AST_VAR)
                                                (AST_DIM
                                                    (AST_STATIC_PROP)
                                                    (SCALAR))
                                                (AST_ENCAPS_LIST
                                                    (AST_VAR)
                                                    (SCALAR)
                                                    (AST_VAR)
                                                    (AST_VAR)))))
                                    (AST_IF
                                        (AST_IF_ELEM
                                            (AST_UNARY_OP
                                                (AST_EMPTY
                                                    (AST_VAR)))
                                            (
                                                (AST_ASSIGN
                                                    (AST_VAR)
                                                    (AST_VAR))))))))
                        (AST_IF
                            (AST_IF_ELEM
                                (AST_STATIC_PROP)
                                (
                                    (AST_ECHO
                                        (AST_BINARY_OP
                                            (AST_ENCAPS_LIST
                                                (SCALAR)
                                                (AST_VAR)
                                                (SCALAR))
                                            (AST_CONST))))))
                        (AST_IF
                            (AST_IF_ELEM
                                (AST_UNARY_OP
                                    (AST_EMPTY
                                        (AST_VAR)))
                                (
                                    (AST_ASSIGN
                                        (AST_VAR)
                                        (AST_ARRAY
                                            (AST_ARRAY_ELEM
                                                (SCALAR)
                                                (SCALAR))
                                            (AST_ARRAY_ELEM
                                                (AST_VAR)
                                                (SCALAR))))
                                    (AST_IF
                                        (AST_IF_ELEM
                                            (AST_ISSET
                                                (AST_VAR))
                                            (
                                                (AST_ASSIGN
                                                    (AST_DIM
                                                        (AST_VAR)
                                                        (SCALAR))
                                                    (AST_VAR)))))
                                    (AST_ASSIGN
                                        (AST_DIM
                                            (AST_VAR)
                                            (NULL))
                                        (AST_VAR))))))))))
    (AST_RETURN
        (AST_VAR)))||||||||