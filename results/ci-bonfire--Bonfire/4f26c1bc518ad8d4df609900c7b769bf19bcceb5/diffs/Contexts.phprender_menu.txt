    public static function render_menu($mode = 'text', $order_by = 'normal', $top_level_only = false, $benchmark = false)
    {
        if ($benchmark) {
            self::$ci->benchmark->mark('render_menu_start');
        }

        // As long as the contexts were set with setContexts(), the required contexts
        // should be in place. However, it's still a good idea to make sure an array
        // of contexts was provided.
        $contexts = self::getContexts();
        if (empty($contexts) || ! is_array($contexts)) {
            die(self::$ci->lang->line('bf_no_contexts'));
        }

        // Sorting (top-level menus).
        switch ($order_by) {
            case 'reverse':
                $contexts = array_reverse($contexts);
                break;
            case 'asc':
                natsort($contexts);
                break;
            case 'desc':
                rsort($contexts);
                break;
            case 'normal':
            case 'default':
            default:
                break;
        }

        $template = '';
        if ($mode == 'text') {
            $template = self::$templateContextText;
        } else {
            $template = self::$templateContextImage;
            if ($mode == 'both') {
                $template .= self::$templateContextText;
            }
        }
        $template .= self::$templateContextEnd;

        // Build out the navigation.
        $menu = '';
        foreach ($contexts as $context) {
            // Don't display an entry in the menu if the user doesn't have permission
            // to view it (unless the permission doesn't exist).
            $viewPermission = 'Site.' . ucfirst($context) . '.View';
            if (self::$ci->auth->has_permission($viewPermission)
                || ! self::$ci->auth->permission_exists($viewPermission)
            ) {
                // The text/image displayed in the top-level context menu.
                $title    = self::$ci->lang->line("bf_context_{$context}");
                $navTitle = str_replace(
                    array('{title}', '{image}'),
                    array(
                        $title,
                        $mode == 'text' ? '' : Template::theme_url("images/context_{$context}.png"),
                    ),
                    $template
                );

                // Build the menu for this context.
                $menu .= str_replace(
                    array('{parent_class}', '{url}', '{id}', '{current_class}', '{title}', '{extra}', '{text}', '{content}'),
                    array(
                        self::$parent_class . ' ' . check_class($context, true),
                        site_url(self::$site_area . "/{$context}"),
                        "tb_{$context}",
                        self::$templateContextMenuAnchorClass,
                        $title,
                        str_replace('{dataId}', $context, self::$templateContextMenuExtra),
                        $navTitle,
                        $top_level_only ? '' : self::context_nav($context),
                    ),
                    self::$templateContextMenu
                );
            }
        }

        // Put the generated menu into the context nav template.
        $nav = str_replace(
            array('{class}', '{extra}', '{menu}'),
            array(
                self::$outer_class,
                trim(self::$outer_id) == '' ? '' : ' id="' . self::$outer_id . '"',
                $menu,
            ),
            self::$templateContextNav
        );

        if ($benchmark) {
            self::$ci->benchmark->mark('render_menu_end');
        }

        return $nav;
    }

    /**
     * Create the mobile navigation.
     *
     * The tab-style mobile navigation is made up of a series of divs, each of which
     * contains a list of links within that context.
     *
     * @return string The navigation lists.
     */
||||||||||||||||HAS_DOC_COMMENTNO_RETURN_TYPE
(NO_PARAM_TYPEPARAM_DEFAULTNO_PARAM_TYPEPARAM_DEFAULTNO_PARAM_TYPEPARAM_DEFAULTNO_PARAM_TYPEPARAM_DEFAULT)
(
    (AST_IF
        (AST_IF_ELEM
            (AST_VAR)
            (
                (AST_METHOD_CALL
                    (AST_PROP
                        (AST_STATIC_PROP))
                    (
                        (SCALAR))))))
    (AST_ASSIGN
        (AST_VAR)
        (AST_STATIC_CALL))
    (AST_IF
        (AST_IF_ELEM
            (AST_BINARY_OP
                (AST_EMPTY
                    (AST_VAR))
                (AST_UNARY_OP
                    (AST_CALL
                        (
                            (AST_VAR)))))
            (
                (AST_EXIT
                    (AST_METHOD_CALL
                        (AST_PROP
                            (AST_STATIC_PROP))
                        (
                            (SCALAR)))))))
    (AST_SWITCH
        (AST_VAR)
        (AST_SWITCH_LIST
            (AST_SWITCH_CASE
                (SCALAR)
                (
                    (AST_ASSIGN
                        (AST_VAR)
                        (AST_CALL
                            (
                                (AST_VAR))))
                    (AST_BREAK
                        (NULL))))
            (AST_SWITCH_CASE
                (SCALAR)
                (
                    (AST_CALL
                        (
                            (AST_VAR)))
                    (AST_BREAK
                        (NULL))))
            (AST_SWITCH_CASE
                (SCALAR)
                (
                    (AST_CALL
                        (
                            (AST_VAR)))
                    (AST_BREAK
                        (NULL))))
            (AST_SWITCH_CASE
                (SCALAR))
            (AST_SWITCH_CASE
                (SCALAR))
            (AST_SWITCH_CASE
                (NULL)
                (
                    (AST_BREAK
                        (NULL))))))
    (AST_ASSIGN
        (AST_VAR)
        (SCALAR))
    (AST_IF
        (AST_IF_ELEM
            (AST_BINARY_OP
                (AST_VAR)
                (SCALAR))
            (
                (AST_ASSIGN
                    (AST_VAR)
                    (AST_STATIC_PROP))))
        (AST_IF_ELEM
            (NULL)
            (
                (AST_ASSIGN
                    (AST_VAR)
                    (AST_STATIC_PROP))
                (AST_IF
                    (AST_IF_ELEM
                        (AST_BINARY_OP
                            (AST_VAR)
                            (SCALAR))
                        (
                            (AST_ASSIGN_OP
                                (AST_VAR)
                                (AST_STATIC_PROP))))))))
    (AST_ASSIGN_OP
        (AST_VAR)
        (AST_STATIC_PROP))
    (AST_ASSIGN
        (AST_VAR)
        (SCALAR))
    (AST_FOREACH
        (AST_VAR)
        (AST_VAR)
        (NULL)
        (
            (AST_ASSIGN
                (AST_VAR)
                (AST_BINARY_OP
                    (AST_BINARY_OP
                        (SCALAR)
                        (AST_CALL
                            (
                                (AST_VAR))))
                    (SCALAR)))
            (AST_IF
                (AST_IF_ELEM
                    (AST_BINARY_OP
                        (AST_METHOD_CALL
                            (AST_PROP
                                (AST_STATIC_PROP))
                            (
                                (AST_VAR)))
                        (AST_UNARY_OP
                            (AST_METHOD_CALL
                                (AST_PROP
                                    (AST_STATIC_PROP))
                                (
                                    (AST_VAR)))))
                    (
                        (AST_ASSIGN
                            (AST_VAR)
                            (AST_METHOD_CALL
                                (AST_PROP
                                    (AST_STATIC_PROP))
                                (
                                    (AST_ENCAPS_LIST
                                        (SCALAR)
                                        (AST_VAR)))))
                        (AST_ASSIGN
                            (AST_VAR)
                            (AST_CALL
                                (
                                    (AST_ARRAY
                                        (AST_ARRAY_ELEM
                                            (SCALAR)
                                            (NULL))
                                        (AST_ARRAY_ELEM
                                            (SCALAR)
                                            (NULL)))
                                    (AST_ARRAY
                                        (AST_ARRAY_ELEM
                                            (AST_VAR)
                                            (NULL))
                                        (AST_ARRAY_ELEM
                                            (AST_CONDITIONAL
                                                (AST_BINARY_OP
                                                    (AST_VAR)
                                                    (SCALAR))
                                                (SCALAR)
                                                (AST_STATIC_CALL
                                                    (
                                                        (AST_ENCAPS_LIST
                                                            (SCALAR)
                                                            (AST_VAR)
                                                            (SCALAR)))))
                                            (NULL)))
                                    (AST_VAR))))
                        (AST_ASSIGN_OP
                            (AST_VAR)
                            (AST_CALL
                                (
                                    (AST_ARRAY
                                        (AST_ARRAY_ELEM
                                            (SCALAR)
                                            (NULL))
                                        (AST_ARRAY_ELEM
                                            (SCALAR)
                                            (NULL))
                                        (AST_ARRAY_ELEM
                                            (SCALAR)
                                            (NULL))
                                        (AST_ARRAY_ELEM
                                            (SCALAR)
                                            (NULL))
                                        (AST_ARRAY_ELEM
                                            (SCALAR)
                                            (NULL))
                                        (AST_ARRAY_ELEM
                                            (SCALAR)
                                            (NULL))
                                        (AST_ARRAY_ELEM
                                            (SCALAR)
                                            (NULL))
                                        (AST_ARRAY_ELEM
                                            (SCALAR)
                                            (NULL)))
                                    (AST_ARRAY
                                        (AST_ARRAY_ELEM
                                            (AST_BINARY_OP
                                                (AST_BINARY_OP
                                                    (AST_STATIC_PROP)
                                                    (SCALAR))
                                                (AST_CALL
                                                    (
                                                        (AST_VAR)
                                                        (AST_CONST))))
                                            (NULL))
                                        (AST_ARRAY_ELEM
                                            (AST_CALL
                                                (
                                                    (AST_BINARY_OP
                                                        (AST_STATIC_PROP)
                                                        (AST_ENCAPS_LIST
                                                            (SCALAR)
                                                            (AST_VAR)))))
                                            (NULL))
                                        (AST_ARRAY_ELEM
                                            (AST_ENCAPS_LIST
                                                (SCALAR)
                                                (AST_VAR))
                                            (NULL))
                                        (AST_ARRAY_ELEM
                                            (AST_STATIC_PROP)
                                            (NULL))
                                        (AST_ARRAY_ELEM
                                            (AST_VAR)
                                            (NULL))
                                        (AST_ARRAY_ELEM
                                            (AST_CALL
                                                (
                                                    (SCALAR)
                                                    (AST_VAR)
                                                    (AST_STATIC_PROP)))
                                            (NULL))
                                        (AST_ARRAY_ELEM
                                            (AST_VAR)
                                            (NULL))
                                        (AST_ARRAY_ELEM
                                            (AST_CONDITIONAL
                                                (AST_VAR)
                                                (SCALAR)
                                                (AST_STATIC_CALL
                                                    (
                                                        (AST_VAR))))
                                            (NULL)))
                                    (AST_STATIC_PROP)))))))))
    (AST_ASSIGN
        (AST_VAR)
        (AST_CALL
            (
                (AST_ARRAY
                    (AST_ARRAY_ELEM
                        (SCALAR)
                        (NULL))
                    (AST_ARRAY_ELEM
                        (SCALAR)
                        (NULL))
                    (AST_ARRAY_ELEM
                        (SCALAR)
                        (NULL)))
                (AST_ARRAY
                    (AST_ARRAY_ELEM
                        (AST_STATIC_PROP)
                        (NULL))
                    (AST_ARRAY_ELEM
                        (AST_CONDITIONAL
                            (AST_BINARY_OP
                                (AST_CALL
                                    (
                                        (AST_STATIC_PROP)))
                                (SCALAR))
                            (SCALAR)
                            (AST_BINARY_OP
                                (AST_BINARY_OP
                                    (SCALAR)
                                    (AST_STATIC_PROP))
                                (SCALAR)))
                        (NULL))
                    (AST_ARRAY_ELEM
                        (AST_VAR)
                        (NULL)))
                (AST_STATIC_PROP))))
    (AST_IF
        (AST_IF_ELEM
            (AST_VAR)
            (
                (AST_METHOD_CALL
                    (AST_PROP
                        (AST_STATIC_PROP))
                    (
                        (SCALAR))))))
    (AST_RETURN
        (AST_VAR)))||||||||