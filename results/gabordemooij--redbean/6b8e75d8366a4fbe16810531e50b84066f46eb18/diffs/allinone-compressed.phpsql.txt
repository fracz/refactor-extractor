||||||||class RedBean_Mod_Search extends RedBean_Mod { public function processQuerySlots($sql, $slots) { $db = $this->provider->getDatabase(); $code = sha1(rand(1,1000)*time()); foreach( $slots as $key=>$value ) { $sql = str_replace( "{".$key."}", "{".$code.$key."}" ,$sql ); } foreach( $slots as $key=>$value ) { $sql = str_replace( "{".$code.$key."}", $this->provider->getWriter()->getQuote().$db->escape( $value ).$this->provider->getWriter()->getQuote(),$sql ); } return $sql; } public function sql($rawsql, $slots, $table, $max=0) { $db = $this->provider->getDatabase(); $sql = $rawsql; if (is_array($slots)) { $sql = $this->processQuerySlots( $sql, $slots ); } $sql = str_replace('@ifexists:','', $sql); $rs = $db->getCol( $this->provider->getWriter()->getQuery("where",array( "table"=>$table )) . $sql ); $err = $db->getErrorMsg(); if (!$this->frozen && strpos($err,"Unknown column")!==false && $max<10) { $matches = array(); if (preg_match("/Unknown\scolumn\s'(.*?)'/",$err,$matches)) { if (count($matches)==2 && strpos($rawsql,'@ifexists')!==false) { $rawsql = str_replace('@ifexists:`'.$matches[1].'`','NULL', $rawsql); $rawsql = str_replace('@ifexists:'.$matches[1].'','NULL', $rawsql); return $this->sql( $rawsql, $slots, $table, ++$max); } } return array(); } else { if (is_array($rs)) { return $rs; } else { return array(); } } } }
abstract class RedBean_Mod { protected $provider; public function __construct(RedBean_OODB $provider) { $this->provider = $provider; } }
class RedBean_Observable { private $observers = array(); public function addEventListener( $eventname, RedBean_Observer $observer ) { if (!isset($this->observers[ $eventname ])) { $this->observers[ $eventname ] = array(); } $this->observers[ $eventname ][] = $observer; } public function signal( $eventname ) { if (!isset($this->observers[ $eventname ])) { $this->observers[ $eventname ] = array(); } foreach($this->observers[$eventname] as $observer) { $observer->onEvent( $eventname, $this ); } } }
interface RedBean_Observer { public function onEvent( $eventname, RedBean_Observable $o ); }
class RedBean_OODB { private $locktime = 10; private $db; private $locking = true; public $pkey = false; private $rollback = false; private $me = null; private $engine = "myisam"; private $frozen = false; private $writer; private $beanchecker; private $gc; private $classGenerator; private $filter; private $search; private $optimizer; private $beanstore; private function __construct( $filter = false ) { $this->filter = new RedBean_Mod_Filter_Strict(); $this->beanchecker = new RedBean_Mod_BeanChecker(); $this->gc = new RedBean_Mod_GarbageCollector(); $this->classGenerator = new RedBean_Mod_ClassGenerator( $this ); $this->search = new RedBean_Mod_Search( $this ); $this->optimizer = new RedBean_Mod_Optimizer( $this ); $this->beanstore = new RedBean_Mod_BeanStore( $this ); } public function getFilter() { return $this->filter; } public function setFilter( RedBean_Mod_Filter $filter ) { $this->filter = $filter; } public function getWriter() { return $this->writer; } public function isFrozen() { return (boolean) $this->freeze; } public function __destruct() { $this->releaseAllLocks(); $this->db->exec( $this->writer->getQuery("destruct", array("engine"=>$this->engine,"rollback"=>$this->rollback)) ); } public function setLocking( $tf ) { $this->locking = $tf; } public function getDatabase() { return $this->db; } public function setDatabase( RedBean_DBAdapter $db ) { $this->db = $db; } public function getLocking() { return $this->locking; } public function setOptimizerActive( $bool ) { $this->optimizer = (boolean) $bool; } public function getOptimizerActive() { return $this->optimizer; } private static $instance = null; public function getInstance() { if (self::$instance === null) { self::$instance = new RedBean_OODB; } return self::$instance; } public function checkBean(RedBean_OODBBean $bean) { if (!$this->db) { throw new RedBean_Exception_Security("No database object. Have you used kickstart to initialize RedBean?"); } return $this->beanchecker->check( $bean ); } public function checkBeanForAssoc( $bean ) { $this->checkBean($bean); if (intval($bean->id) < 1) { $bean->id = $this->set( $bean ); } return $bean; } public function getEngine() { return $this->engine; } public function setEngine( $engine ) { if ($engine=="myisam" || $engine=="innodb") { $this->engine = $engine; } else { throw new Exception("Unsupported database engine"); } return $this->engine; } public function rollback() { $this->rollback = true; } public function set( RedBean_OODBBean $bean ) { return $this->beanstore->set($bean); } public function inferType( $v ) { $db = $this->db; $rawv = $v; $checktypeSQL = $this->writer->getQuery("infertype", array( "value"=> $this->db->escape(strval($v)) )); $db->exec( $checktypeSQL ); $id = $db->getInsertID(); $readtypeSQL = $this->writer->getQuery("readtype",array( "id"=>$id )); $row=$db->getRow($readtypeSQL); $db->exec( $this->writer->getQuery("reset_dtyp") ); $tp = 0; foreach($row as $t=>$tv) { if (strval($tv) === strval($rawv)) { return $tp; } $tp++; } return $tp; } public function getType( $sqlType ) { if (in_array($sqlType,$this->writer->sqltype_typeno)) { $typeno = $this->writer->sqltype_typeno[$sqlType]; } else { $typeno = -1; } return $typeno; } public function init( RedBean_QueryWriter $querywriter, $dontclose = false ) { $this->writer = $querywriter; if ($this->engine === "innodb") { $this->db->exec($this->writer->getQuery("prepare_innodb")); $this->db->exec($this->writer->getQuery("starttransaction")); } else if ($this->engine === "myisam"){ $this->db->exec($this->writer->getQuery("prepare_myisam")); } if (!$this->frozen) { $this->db->exec($this->writer->getQuery("clear_dtyp")); $this->db->exec($this->writer->getQuery("setup_dtyp")); $this->db->exec($this->writer->getQuery("setup_locking")); $this->db->exec($this->writer->getQuery("setup_tables")); } if (!$this->pkey) { $this->pkey = str_replace(".","",microtime(true)."".mt_rand()); } return true; } public function freeze() { $this->frozen = true; } public function unfreeze() { $this->frozen = false; } public function showTables( $all=false ) { $db = $this->db; if ($all && $this->frozen) { $alltables = $db->getCol($this->writer->getQuery("show_tables")); return $alltables; } else { $alltables = $db->getCol($this->writer->getQuery("show_rtables")); return $alltables; } } public function addTable( $tablename ) { $db = $this->db; $tablename = $db->escape( $tablename ); $db->exec($this->writer->getQuery("register_table",array("table"=>$tablename))); } public function dropTable( $tablename ) { $db = $this->db; $tablename = $db->escape( $tablename ); $db->exec($this->writer->getQuery("unregister_table",array("table"=>$tablename))); } public function releaseAllLocks() { $this->db->exec($this->writer->getQuery("release",array("key"=>$this->pkey))); } public function openBean( $bean, $mustlock=false) { $this->checkBean( $bean ); if (!$this->locking || $bean->id === 0) return true; $db = $this->db; $removeExpiredSQL = $this->writer->getQuery("remove_expir_lock", array( "locktime"=>$this->locktime )); $db->exec($removeExpiredSQL); $tbl = $db->escape( $bean->type ); $id = intval( $bean->id ); $checkopenSQL = $this->writer->getQuery("get_lock",array( "id"=>$id, "table"=>$tbl, "key"=>$this->pkey )); $row = $db->getRow($checkopenSQL); if ($row && is_array($row) && count($row)>0) { $updateexpstamp = $this->writer->getQuery("update_expir_lock",array( "time"=>time(), "id"=>$row["id"] )); $db->exec($updateexpstamp); return true; } if ($mustlock) { throw new RedBean_Exception_FailedAccessBean("Could not acquire a lock for bean $tbl . $id "); return false; } $openSQL = $this->writer->getQuery("aq_lock", array( "table"=>$tbl, "id"=>$id, "key"=>$this->pkey, "time"=>time() )); $trials = 0; $aff = 0; while( $aff < 1 && $trials < 5 ) { $db->exec($openSQL); $aff = $db->getAffectedRows(); $trials++; if ($aff < 1) usleep(500000); } if ($trials > 4) { return false; } else { return true; } } private function sync( $toggle ) { $bean = $this->dispense("_syncmethod"); $bean->id = 0; if ($toggle) { $this->openBean( $bean ); } else { $this->closeBean( $bean ); } } public function getById($type, $id, $data=false) { $bean = $this->dispense( $type ); $db = $this->db; $table = $db->escape( $type ); $id = abs( intval( $id ) ); $bean->id = $id; $this->openBean($bean); if (!$data) { $getSQL = $this->writer->getQuery("get_bean",array( "type"=>$type, "id"=>$id )); $row = $db->getRow( $getSQL ); } else { $row = $data; } if ($row && is_array($row) && count($row)>0) { foreach($row as $p=>$v) { $bean->$p = $v; } } else { throw new RedBean_Exception_FailedAccessBean("bean not found"); } return $bean; } public function exists($type,$id) { $db = $this->db; $id = intval( $id ); $type = $db->escape( $type ); $alltables = $this->showTables(); if (!in_array($type, $alltables)) { return false; } else { $no = $db->getCell( $this->writer->getQuery("bean_exists",array( "type"=>$type, "id"=>$id )) ); if (intval($no)) { return true; } else { return false; } } } public function numberof($type) { $db = $this->db; $type = $this->filter->table( $db->escape( $type ) ); $alltables = $this->showTables(); if (!in_array($type, $alltables)) { return 0; } else { $no = $db->getCell( $this->writer->getQuery("count",array( "type"=>$type ))); return intval( $no ); } } function distinct($type, $field) { $db = $this->db; $type = $this->filter->table( $db->escape( $type ) ); $field = $db->escape( $field ); $alltables = $this->showTables(); if (!in_array($type, $alltables)) { return array(); } else { $ids = $db->getCol( $this->writer->getQuery("distinct",array( "type"=>$type, "field"=>$field ))); $beans = array(); if (is_array($ids) && count($ids)>0) { foreach( $ids as $id ) { $beans[ $id ] = $this->getById( $type, $id , false); } } return $beans; } } private function stat($type,$field,$stat="sum") { $db = $this->db; $type = $this->filter->table( $db->escape( $type ) ); $field = $this->filter->property( $db->escape( $field ) ); $stat = $db->escape( $stat ); $alltables = $this->showTables(); if (!in_array($type, $alltables)) { return 0; } else { $no = $db->getCell($this->writer->getQuery("stat",array( "stat"=>$stat, "field"=>$field, "type"=>$type ))); return floatval( $no ); } } public function sumof($type,$field) { return $this->stat( $type, $field, "sum"); } public function avgof($type,$field) { return $this->stat( $type, $field, "avg"); } public function minof($type,$field) { return $this->stat( $type, $field, "min"); } public function maxof($type,$field) { return $this->stat( $type, $field, "max"); } public function resetAll() { $sql = $this->writer->getQuery("releaseall"); $this->db->exec( $sql ); return true; } public function fastLoader( $type, $ids ) { $db = $this->db; $sql = $this->writer->getQuery("fastload", array( "type"=>$type, "ids"=>$ids )); return $db->get( $sql ); } public function getBySQL( $rawsql, $slots, $table, $max=0 ) { return $this->search->sql( $rawsql, $slots, $table, $max ); } public function find(RedBean_OODBBean $bean, $searchoperators = array(), $start=0, $end=100, $orderby="id ASC", $extraSQL=false) { $this->checkBean( $bean ); $db = $this->db; $tbl = $db->escape( $bean->type ); $findSQL = $this->writer->getQuery("find",array( "searchoperators"=>$searchoperators, "bean"=>$bean, "start"=>$start, "end"=>$end, "orderby"=>$orderby, "extraSQL"=>$extraSQL, "tbl"=>$tbl )); $ids = $db->getCol( $findSQL ); $beans = array(); if (is_array($ids) && count($ids)>0) { foreach( $ids as $id ) { $beans[ $id ] = $this->getById( $bean->type, $id , false); } } return $beans; } public function listAll($type, $start=false, $end=false, $orderby="id ASC", $extraSQL = false) { $db = $this->db; $listSQL = $this->writer->getQuery("list",array( "type"=>$type, "start"=>$start, "end"=>$end, "orderby"=>$orderby, "extraSQL"=>$extraSQL )); return $db->get( $listSQL ); } public function associate( RedBean_OODBBean $bean1, RedBean_OODBBean $bean2 ) { $db = $this->db; $bean1 = $this->checkBeanForAssoc($bean1); $bean2 = $this->checkBeanForAssoc($bean2); $this->openBean( $bean1, true ); $this->openBean( $bean2, true ); $tp1 = $bean1->type; $tp2 = $bean2->type; if ($tp1==$tp2){ $arr = array( 0=>$bean1, 1 =>$bean2 ); } else { $arr = array( $tp1=>$bean1, $tp2 =>$bean2 ); } ksort($arr); $bean1 = array_shift( $arr ); $bean2 = array_shift( $arr ); $id1 = intval($bean1->id); $id2 = intval($bean2->id); $tables = array(); array_push( $tables, $db->escape( $bean1->type ) ); array_push( $tables, $db->escape( $bean2->type ) ); sort($tables); $assoctable = $db->escape( implode("_",$tables) ); if (!$this->frozen) { $alltables = $this->showTables(); if (!in_array($assoctable, $alltables)) { $t1 = $tables[0]; $t2 = $tables[1]; if ($t1==$t2) { $t2.="2"; } $assoccreateSQL = $this->writer->getQuery("create_assoc",array( "assoctable"=> $assoctable, "t1" =>$t1, "t2" =>$t2, "engine"=>$this->engine )); $db->exec( $assoccreateSQL ); $db->exec( $this->writer->getQuery("add_assoc",array( "assoctable"=> $assoctable, "t1" =>$t1, "t2" =>$t2 )) ); $this->addTable( $assoctable ); } } $assocSQL = $this->writer->getQuery("add_assoc_now", array( "id1"=>$id1, "id2"=>$id2, "assoctable"=>$assoctable )); $db->exec( $assocSQL ); } public function unassociate(RedBean_OODBBean $bean1, RedBean_OODBBean $bean2) { $db = $this->db; $bean1 = $this->checkBeanForAssoc($bean1); $bean2 = $this->checkBeanForAssoc($bean2); $this->openBean( $bean1, true ); $this->openBean( $bean2, true ); $idx1 = intval($bean1->id); $idx2 = intval($bean2->id); $tp1 = $bean1->type; $tp2 = $bean2->type; if ($tp1==$tp2){ $arr = array( 0=>$bean1, 1 =>$bean2 ); } else { $arr = array( $tp1=>$bean1, $tp2 =>$bean2 ); } ksort($arr); $bean1 = array_shift( $arr ); $bean2 = array_shift( $arr ); $id1 = intval($bean1->id); $id2 = intval($bean2->id); $tables = array(); array_push( $tables, $db->escape( $bean1->type ) ); array_push( $tables, $db->escape( $bean2->type ) ); sort($tables); $assoctable = $db->escape( implode("_",$tables) ); $alltables = $this->showTables(); if (in_array($assoctable, $alltables)) { $t1 = $tables[0]; $t2 = $tables[1]; if ($t1==$t2) { $t2.="2"; $unassocSQL = $this->writer->getQuery("unassoc",array( "assoctable"=>$assoctable, "t1"=>$t2, "t2"=>$t1, "id1"=>$id1, "id2"=>$id2 )); $db->exec($unassocSQL); } $unassocSQL = $this->writer->getQuery("unassoc",array( "assoctable"=>$assoctable, "t1"=>$t1, "t2"=>$t2, "id1"=>$id1, "id2"=>$id2 )); $db->exec($unassocSQL); } if ($tp1==$tp2) { $assoctable2 = "pc_".$db->escape( $bean1->type )."_".$db->escape( $bean1->type ); $alltables = $this->showTables(); if (in_array($assoctable2, $alltables)) { $unassocSQL = $this->writer->getQuery("untree", array( "assoctable2"=>$assoctable2, "idx1"=>$idx1, "idx2"=>$idx2 )); $db->exec($unassocSQL); } } } public function getAssoc(RedBean_OODBBean $bean, $targettype) { $db = $this->db; $bean = $this->checkBeanForAssoc($bean); $id = intval($bean->id); $t1 = $db->escape( $this->filter->table($bean->type) ); $t2 = $db->escape( $targettype ); $tables = array(); array_push( $tables, $t1 ); array_push( $tables, $t2 ); sort($tables); $assoctable = $db->escape( implode("_",$tables) ); $alltables = $this->showTables(); if (!in_array($assoctable, $alltables)) { return array(); } else { if ($t1==$t2) { $t2.="2"; } $getassocSQL = $this->writer->getQuery("get_assoc",array( "t1"=>$t1, "t2"=>$t2, "assoctable"=>$assoctable, "id"=>$id )); $rows = $db->getCol( $getassocSQL ); $beans = array(); if ($rows && is_array($rows) && count($rows)>0) { foreach($rows as $i) { $beans[$i] = $this->getById( $targettype, $i, false); } } return $beans; } } public function trash( RedBean_OODBBean $bean ) { $this->checkBean( $bean ); if (intval($bean->id)===0) return; $this->deleteAllAssoc( $bean ); $this->openBean($bean); $table = $this->db->escape($bean->type); $id = intval($bean->id); $this->db->exec( $this->writer->getQuery("trash",array( "table"=>$table, "id"=>$id )) ); } public function deleteAllAssoc( $bean ) { $db = $this->db; $bean = $this->checkBeanForAssoc($bean); $this->openBean( $bean, true ); $id = intval( $bean->id ); $alltables = $this->showTables(); $t = $db->escape($bean->type); $checktables = array(); foreach( $alltables as $table ) { if (strpos($table,$t."_")!==false || strpos($table,"_".$t)!==false){ $checktables[] = $table; } } foreach($checktables as $table) { if (strpos($table,"pc_")===0){ $db->exec( $this->writer->getQuery("deltree",array( "id"=>$id, "table"=>$table )) ); } else { $db->exec( $this->writer->getQuery("unassoc_all_t1",array("table"=>$table,"t"=>$t,"id"=>$id)) ); $db->exec( $this->writer->getQuery("unassoc_all_t2",array("table"=>$table,"t"=>$t,"id"=>$id)) ); } } return true; } public function deleteAllAssocType( $targettype, $bean ) { $db = $this->db; $bean = $this->checkBeanForAssoc($bean); $this->openBean( $bean, true ); $id = intval( $bean->id ); $t1 = $db->escape( $this->filter->table($bean->type) ); $t2 = $db->escape( $targettype ); $tables = array(); array_push( $tables, $t1 ); array_push( $tables, $t2 ); sort($tables); $assoctable = $db->escape( implode("_",$tables) ); $availabletables = $this->showTables(); if (in_array('pc_'.$assoctable,$availabletables)){ $db->exec( $this->writer->getQuery("deltreetype",array( "assoctable"=>'pc_'.$assoctable, "id"=>$id )) ); } if (in_array($assoctable,$availabletables)) { $db->exec( $this->writer->getQuery("unassoctype1",array( "assoctable"=>$assoctable, "t1"=>$t1, "id"=>$id )) ); $db->exec( $this->writer->getQuery("unassoctype2",array( "assoctable"=>$assoctable, "t1"=>$t1, "id"=>$id )) ); } return true; } public function dispense( $type="StandardBean" ) { $oBean = new RedBean_OODBBean(); $oBean->type = $type; $oBean->id = 0; return $oBean; } public function addChild( RedBean_OODBBean $parent, RedBean_OODBBean $child ) { $db = $this->db; $parent = $this->checkBeanForAssoc($parent); $child = $this->checkBeanForAssoc($child); $this->openBean( $parent, true ); $this->openBean( $child, true ); if ($parent->type !== $child->type) { throw new RedBean_Exception_InvalidParentChildCombination(); } $pid = intval($parent->id); $cid = intval($child->id); $assoctable = "pc_".$db->escape($parent->type."_".$parent->type); if (!$this->frozen) { $alltables = $this->showTables(); if (!in_array($assoctable, $alltables)) { $assoccreateSQL = $this->writer->getQuery("create_tree",array( "engine"=>$this->engine, "assoctable"=>$assoctable )); $db->exec( $assoccreateSQL ); $db->exec( $this->writer->getQuery("unique", array( "assoctable"=>$assoctable )) ); $this->addTable( $assoctable ); } } $assocSQL = $this->writer->getQuery("add_child",array( "assoctable"=>$assoctable, "pid"=>$pid, "cid"=>$cid )); $db->exec( $assocSQL ); } public function getChildren( RedBean_OODBBean $parent ) { $db = $this->db; $parent = $this->checkBeanForAssoc($parent); $pid = intval($parent->id); $assoctable = "pc_".$db->escape( $parent->type . "_" . $parent->type ); $alltables = $this->showTables(); if (!in_array($assoctable, $alltables)) { return array(); } else { $targettype = $parent->type; $getassocSQL = $this->writer->getQuery("get_children", array( "assoctable"=>$assoctable, "pid"=>$pid )); $rows = $db->getCol( $getassocSQL ); $beans = array(); if ($rows && is_array($rows) && count($rows)>0) { foreach($rows as $i) { $beans[$i] = $this->getById( $targettype, $i, false); } } return $beans; } } public function getParent( RedBean_OODBBean $child ) { $db = $this->db; $child = $this->checkBeanForAssoc($child); $cid = intval($child->id); $assoctable = "pc_".$db->escape( $child->type . "_" . $child->type ); $alltables = $this->showTables(); if (!in_array($assoctable, $alltables)) { return array(); } else { $targettype = $child->type; $getassocSQL = $this->writer->getQuery("get_parent", array( "assoctable"=>$assoctable, "cid"=>$cid )); $rows = $db->getCol( $getassocSQL ); $beans = array(); if ($rows && is_array($rows) && count($rows)>0) { foreach($rows as $i) { $beans[$i] = $this->getById( $targettype, $i, false); } } return $beans; } } public function removeChild(RedBean_OODBBean $parent, RedBean_OODBBean $child) { $db = $this->db; $parent = $this->checkBeanForAssoc($parent); $child = $this->checkBeanForAssoc($child); $this->openBean( $parent, true ); $this->openBean( $child, true ); if ($parent->type !== $child->type) { throw new RedBean_Exception_InvalidParentChildCombination(); } $assoctable = "pc_".$db->escape( $parent->type . "_" . $parent->type ); $alltables = $this->showTables(); if (!in_array($assoctable, $alltables)) { return true; } else { $pid = intval($parent->id); $cid = intval($child->id); $unassocSQL = $this->writer->getQuery("remove_child", array( "assoctable"=>$assoctable, "pid"=>$pid, "cid"=>$cid )); $db->exec($unassocSQL); } } public function numofRelated( $type, RedBean_OODBBean $bean ) { $db = $this->db; $t2 = $this->filter->table( $db->escape( $type ) ); $this->checkBean( $bean ); $t1 = $this->filter->table( $bean->type ); $tref = $this->filter->table( $db->escape( $bean->type ) ); $id = intval( $bean->id ); $tables = array(); array_push( $tables, $t1 ); array_push( $tables, $t2 ); sort($tables); $assoctable = $db->escape( implode("_",$tables) ); $tables = $this->showTables(); if ($tables && is_array($tables) && count($tables) > 0) { if (in_array( $t1, $tables ) && in_array($t2, $tables)){ $sqlCountRelations = $this->writer->getQuery( "num_related", array( "assoctable"=>$assoctable, "t1"=>$t1, "id"=>$id ) ); return (int) $db->getCell( $sqlCountRelations ); } } else { return 0; } } public function generate( $classes, $prefix = false, $suffix = false ) { return $this->classGenerator->generate($classes,$prefix,$suffix); } public function setLockingTime( $timeInSecs ) { if (is_int($timeInSecs) && $timeInSecs >= 0) { $this->locktime = $timeInSecs; } else { throw new RedBean_Exception_InvalidArgument( "time must be integer >= 0" ); } } public function clean() { if ($this->frozen) { return false; } $db = $this->db; $tables = $db->getCol( $this->writer->getQuery("show_rtables") ); foreach($tables as $key=>$table) { $tables[$key] = $this->writer->getEscape().$table.$this->writer->getEscape(); } $sqlcleandatabase = $this->writer->getQuery("drop_tables",array( "tables"=>$tables )); $db->exec( $sqlcleandatabase ); $db->exec( $this->writer->getQuery("truncate_rtables") ); $this->resetAll(); return true; } public function removeUnused( ) { if ($this->frozen) { return false; } return $this->gc->removeUnused( $this, $this->db, $this->writer ); } public function dropColumn( $table, $property ) { if ($this->frozen) { return false; } $db = $this->db; $db->exec( $this->writer->getQuery("drop_column", array( "table"=>$table, "property"=>$property )) ); } public function trashAll($type) { $this->db->exec( $this->writer->getQuery("drop_type",array("type"=>$this->filter->table($type)))); } public static function gen($arg, $prefix = false, $suffix = false) { return self::getInstance()->generate($arg, $prefix, $suffix); } public static function keepInShape($gc = false ,$stdTable=false, $stdCol=false) { return self::getInstance()->optimizer->run($gc, $stdTable, $stdCol); } public function getInstOf( $className, $id=0 ) { if (!class_exists($className)) throw new Exception("Class does not Exist"); $object = new $className($id); return $object; } }
class RedBean_OODBBean { }
class Redbean_Querylogger implements RedBean_Observer { private $path = ""; private $userid = 0; private function getFilename() { return $this->path . "audit_".date("m_d_y").".log"; } public function logSCQuery( $sql, $db ) { $sql = addslashes($sql); $line = "\n".date("H:i:s")."|".$_SERVER["REMOTE_ADDR"]."|UID=".$this->userid."|".$sql; file_put_contents( $this->getFilename(), $line, FILE_APPEND ); return null; } public static function init($path="",$userid=0) { $logger = new self; $logger->userid = $userid; $logger->path = $path; if (!file_exists($logger->getFilename())) { file_put_contents($logger->getFilename(),"begin logging"); } RedBean_OODB::getInstance()->getDatabase()->addEventListener( "sql_exec", $logger ); } public function onEvent( $event, RedBean_Observable $db ) { $this->logSCQuery( $db->getSQL(), $db ); } }
class QueryWriter_MySQL implements RedBean_QueryWriter { public $typeno_sqltype = array( " TINYINT(3) UNSIGNED ", " INT(11) UNSIGNED ", " BIGINT(20) ", " VARCHAR(255) ", " TEXT ", " LONGTEXT " ); public $sqltype_typeno = array( "tinyint(3) unsigned"=>0, "int(11) unsigned"=>1, "bigint(20)"=>2, "varchar(255)"=>3, "text"=>4, "longtext"=>5 ); public $dtypes = array( "tintyintus","intus","ints","varchar255","text","ltext" ); private function getQueryCreateTable( $options=array() ) { $engine = $options["engine"]; $table = $options["table"]; if ($engine=="myisam") { $createtableSQL = "
			 CREATE TABLE `$table` (
			`id` INT( 11 ) UNSIGNED NOT NULL AUTO_INCREMENT ,
			 PRIMARY KEY ( `id` )
			 ) ENGINE = MYISAM DEFAULT CHARSET=utf8 COLLATE=utf8_unicode_ci
			"; } else { $createtableSQL = "
			 CREATE TABLE `$table` (
			`id` INT( 11 ) UNSIGNED NOT NULL AUTO_INCREMENT ,
			 PRIMARY KEY ( `id` )
			 ) ENGINE = InnoDB DEFAULT CHARSET=utf8 COLLATE=utf8_unicode_ci
			"; } return $createtableSQL; } private function getQueryWiden( $options ) { extract($options); return "ALTER TABLE `$table` CHANGE `$column` `$column` $newtype "; } private function getQueryAddColumn( $options ) { extract($options); return "ALTER TABLE `$table` ADD `$column` $type "; } private function getQueryUpdate( $options ) { extract($options); $update = array(); foreach($updatevalues as $u) { $update[] = " `".$u["property"]."` = \"".$u["value"]."\" "; } return "UPDATE `$table` SET ".implode(",",$update)." WHERE id = ".$id; } private function getQueryInsert( $options ) { extract($options); foreach($insertcolumns as $k=>$v) { $insertcolumns[$k] = "`".$v."`"; } foreach($insertvalues as $k=>$v) { $insertvalues[$k] = "\"".$v."\""; } $insertSQL = "INSERT INTO `$table`
					  ( id, ".implode(",",$insertcolumns)." )
					  VALUES( null, ".implode(",",$insertvalues)." ) "; return $insertSQL; } private function getQueryCreate( $options ) { extract($options); return "INSERT INTO `$table` (id) VALUES(null) "; } private function getQueryInferType( $options ) { extract($options); $v = "\"".$value."\""; $checktypeSQL = "insert into dtyp VALUES(null,$v,$v,$v,$v,$v )"; return $checktypeSQL; } private function getQueryResetDTYP() { return "truncate table dtyp"; } private function getQueryRegisterTable( $options ) { extract( $options ); return "replace into redbeantables values (null, \"$table\") "; } private function getQueryUnregisterTable( $options ) { extract( $options ); return "delete from redbeantables where tablename = \"$table\" "; } private function getQueryRelease( $options ) { extract( $options ); return "DELETE FROM locking WHERE fingerprint=\"".$key."\" "; } private function getQueryRemoveExpirLock( $options ) { extract( $options ); return "DELETE FROM locking WHERE expire <= ".(time()-$locktime); } private function getQueryUpdateExpirLock( $options ) { extract( $options ); return "UPDATE locking SET expire=".$time." WHERE id =".$id; } private function getQueryAQLock( $options ) { extract($options); return "INSERT INTO locking VALUES(\"$table\",$id,\"".$key."\",\"".$time."\") "; } private function getQueryDistinct($options) { extract($options); return "SELECT id FROM `$type` GROUP BY $field"; } private function getQueryFastLoad( $options ) { extract( $options ); return "SELECT * FROM `$type` WHERE id IN ( ".implode(",", $ids)." ) ORDER BY FIELD(id,".implode(",", $ids).") ASC		"; } private function getQueryWhere($options) { extract($options); return "select `$table`.id from $table where "; } private function getQueryFind($options) { extract($options); $db = RedBean_OODB::getInstance()->getDatabase(); $findSQL = "SELECT id FROM `$tbl` WHERE "; foreach($bean as $p=>$v) { if ($p === "type" || $p === "id") continue; $p = $db->escape($p); $v = $db->escape($v); if (isset($searchoperators[$p])) { if ($searchoperators[$p]==="LIKE") { $part[] = " `$p`LIKE \"%$v%\" "; } else { $part[] = " `$p` ".$searchoperators[$p]." \"$v\" "; } } else { } } if ($extraSQL) { $findSQL .= @implode(" AND ",$part) . $extraSQL; } else { $findSQL .= @implode(" AND ",$part) . " ORDER BY $orderby LIMIT $start, $end "; } return $findSQL; } private function getQueryList($options) { extract($options); $db = RedBean_OODB::getInstance()->getDatabase(); if ($extraSQL) { $listSQL = "SELECT * FROM ".$db->escape($type)." ".$extraSQL; } else { $listSQL = "SELECT * FROM ".$db->escape($type)."
			ORDER BY ".$orderby; if ($end !== false && $start===false) { $listSQL .= " LIMIT ".intval($end); } if ($start !== false && $end !== false) { $listSQL .= " LIMIT ".intval($start).", ".intval($end); } if ($start !== false && $end===false) { $listSQL .= " LIMIT ".intval($start).", 18446744073709551615 "; } } return $listSQL; } private function getQueryAddAssocNow( $options ) { extract($options); return "REPLACE INTO `$assoctable` VALUES(null,$id1,$id2) "; } private function getQueryUnassoc( $options ) { extract($options); return "DELETE FROM `$assoctable` WHERE ".$t1."_id = $id1 AND ".$t2."_id = $id2 "; } private function getQueryCreateAssoc($options) { extract($options); return "
			 CREATE TABLE `$assoctable` (
			`id` INT( 11 ) UNSIGNED NOT NULL AUTO_INCREMENT ,
			`".$t1."_id` INT( 11 ) UNSIGNED NOT NULL,
			`".$t2."_id` INT( 11 ) UNSIGNED NOT NULL,
			 PRIMARY KEY ( `id` )
			 ) ENGINE = ".$engine.";
			"; } private function getQueryUntree( $options ) { extract($options); return "DELETE FROM `$assoctable2` WHERE
				(parent_id = $idx1 AND child_id = $idx2) OR
				(parent_id = $idx2 AND child_id = $idx1) "; } private function getQueryAddAssoc($options) { extract( $options ); return "ALTER TABLE `$assoctable` ADD UNIQUE INDEX `u_$assoctable` (`".$t1."_id`, `".$t2."_id` ) "; } private function getQueryDeltreeType($options) { extract( $options ); return "DELETE FROM $assoctable WHERE parent_id = $id  OR child_id = $id "; } private function getQueryCreateTree( $options ) { extract( $options ); return "
				 CREATE TABLE `$assoctable` (
				`id` INT( 11 ) UNSIGNED NOT NULL AUTO_INCREMENT ,
				`parent_id` INT( 11 ) UNSIGNED NOT NULL,
				`child_id` INT( 11 ) UNSIGNED NOT NULL,
				 PRIMARY KEY ( `id` )
				 ) ENGINE = ".$engine.";
				"; } private function getQueryUnique( $options ) { extract( $options ); return "ALTER TABLE `$assoctable` ADD UNIQUE INDEX `u_$assoctable` (`parent_id`, `child_id` ) "; } private function getQueryAddChild( $options ) { extract( $options ); return "REPLACE INTO `$assoctable` VALUES(null,$pid,$cid) "; } private function getQueryRemoveChild( $options ) { extract( $options ); return "DELETE FROM `$assoctable` WHERE
				( parent_id = $pid AND child_id = $cid ) "; } private function getQueryDescribe( $options ) { extract( $options ); return "describe `$table`"; } public function getTableColumns($tbl, RedBean_DBAdapter $db) { $rs = $db->get($this->getQuery("describe",array( "table"=>$tbl ))); return $rs; } private function getQueryDropTables( $options ) { extract($options); return "drop tables ".implode(",",$tables); } private function getQueryDropColumn( $options ) { extract($options); return "ALTER TABLE `$table` DROP `$property`"; } private function getQueryTestColumn( $options ) { extract($options); return "alter table `$table` add __test  ".$type; } private function getQueryUpdateTest( $options ) { extract($options); return "update `$table` set __test=`$col`"; } private function getQueryMeasure( $options ) { extract($options); return "select count(*) as df from `$table` where
				strcmp(`$col`,__test) != 0 AND `$col` IS NOT NULL"; } private function getQueryRemoveTest($options) { extract($options); return "alter table `$table` change `$col` `$col` ".$type; } private function getQueryDropTest($options) { extract($options); return "alter table `$table` drop __test"; } private function getIndex1($options) { extract($options); return "ALTER IGNORE TABLE `$table` ADD INDEX $indexname (`$col`)"; } private function getIndex2($options) { extract($options); return "ALTER IGNORE TABLE `$table` DROP INDEX $indexname"; } private function getDestruct($options) { extract($options); if ($rollback) return; if ($engine=="innodb") return "COMMIT"; else return ""; } private function getBasicQuery( $options, $sql_type="SELECT" ) { extract($options); if (isset($fields)){ $sqlfields = array(); foreach($fields as $field) { $sqlfields[] = " `$field` "; } $field = implode(",", $fields); } if (!isset($field)) $field=""; $sql = "$sql_type ".$field." FROM `$table` "; if (isset($where)) { if (is_array($where)) { $crit = array(); foreach($where as $w=>$v) { $crit[] = " `$w` = \"".$v."\""; } $sql .= " WHERE ".implode(" AND ",$crit); } else { $sql .= " WHERE ".$where; } } return $sql; } public function getQuery( $queryname, $params=array() ) { switch($queryname) { case "create_table": return $this->getQueryCreateTable($params); break; case "widen_column": return $this->getQueryWiden($params); break; case "add_column": return $this->getQueryAddColumn($params); break; case "update": return $this->getQueryUpdate($params); break; case "insert": return $this->getQueryInsert($params); break; case "create": return $this->getQueryCreate($params); break; case "infertype": return $this->getQueryInferType($params); break; case "readtype": return $this->getBasicQuery( array("fields"=>array("tinyintus","intus","ints","varchar255","text"), "table" =>"dtyp", "where"=>array("id"=>$params["id"]))); break; case "reset_dtyp": return $this->getQueryResetDTYP(); break; case "prepare_innodb": return "SET autocommit=0"; break; case "prepare_myisam": return "SET autocommit=1"; break; case "starttransaction": return "START TRANSACTION"; break; case "setup_dtyp": $engine = RedBean_OODB::getInstance()->getEngine(); return "
				CREATE TABLE IF NOT EXISTS `dtyp` (
				  `id` int(11) unsigned NOT NULL auto_increment,
				  `tinyintus` tinyint(3) unsigned NOT NULL,
				  `intus` int(11) unsigned NOT NULL,
				  `ints` bigint(20) NOT NULL,
				  `varchar255` varchar(255) NOT NULL,
				  `text` text NOT NULL,
				  PRIMARY KEY  (`id`)
				) ENGINE=$engine DEFAULT CHARSET=utf8 COLLATE=utf8_unicode_ci
				"; break; case "clear_dtyp": return "drop tables dtyp"; break; case "setup_locking": $engine = RedBean_OODB::getInstance()->getEngine(); return "
				CREATE TABLE IF NOT EXISTS `locking` (
				  `tbl` varchar(255) NOT NULL,
				  `id` bigint(20) NOT NULL,
				  `fingerprint` varchar(255) NOT NULL,
				  `expire` int(11) NOT NULL,
				  UNIQUE KEY `tbl` (`tbl`,`id`)
				) ENGINE=$engine DEFAULT CHARSET=utf8 COLLATE=utf8_unicode_ci
				"; break; case "setup_tables": $engine = RedBean_OODB::getInstance()->getEngine(); return "
				 CREATE TABLE IF NOT EXISTS `redbeantables` (
				 `id` INT( 11 ) UNSIGNED NOT NULL AUTO_INCREMENT ,
				 `tablename` VARCHAR( 255 ) NOT NULL ,
				 PRIMARY KEY ( `id` ),
				 UNIQUE KEY `tablename` (`tablename`)
				 ) ENGINE = $engine DEFAULT CHARSET=utf8 COLLATE=utf8_unicode_ci
				"; break; case "show_tables": return "show tables"; break; case "show_rtables": return "select tablename from redbeantables"; break; case "register_table": return $this->getQueryRegisterTable( $params ); break; case "unregister_table": return $this->getQueryUnregisterTable( $params ); break; case "release": return $this->getQueryRelease( $params ); break; case "remove_expir_lock": return $this->getQueryRemoveExpirLock( $params ); break; case "update_expir_lock": return $this->getQueryUpdateExpirLock( $params ); break; case "aq_lock": return $this->getQueryAQLock( $params ); break; case "get_lock": return $this->getBasicQuery(array("fields"=>array("id"),"table"=>"locking","where"=>array("id"=>$params["id"],"tbl"=>$params["table"],"fingerprint"=>$params["key"]))); break; case "get_bean": return $this->getBasicQuery(array("field"=>"*","table"=>$params["type"],"where"=>array("id"=>$params["id"]))); break; case "bean_exists": return $this->getBasicQuery(array("field"=>"count(*)","table"=>$params["type"],"where"=>array("id"=>$params["id"]))); break; case "count": return $this->getBasicQuery(array("field"=>"count(*)","table"=>$params["type"])); break; case "distinct": return $this->getQueryDistinct($params); break; case "stat": return $this->getBasicQuery(array("field"=>$params["stat"]."(`".$params["field"]."`)","table"=>$params["type"])); break; case "releaseall": return "TRUNCATE locking"; break; case "fastload": return $this->getQueryFastLoad($params); break; case "where": return $this->getQueryWhere($params); break; case "find": return $this->getQueryFind( $params); break; case "list": return $this->getQueryList( $params); break; case "create_assoc": return $this->getQueryCreateAssoc( $params ); break; case "add_assoc": return $this->getQueryAddAssoc( $params ); break; case "add_assoc_now": return $this->getQueryAddAssocNow( $params ); break; case "unassoc": return $this->getQueryUnassoc( $params ); break; case "untree": return $this->getQueryUntree( $params ); break; case "get_assoc": $col = $params["t1"]."_id"; return $this->getBasicQuery(array( "table"=>$params["assoctable"], "fields"=>array( $params["t2"]."_id" ), "where"=>array( $col=>$params["id"]) )); break; case "trash": return $this->getBasicQuery(array("table"=>$params["table"],"where"=>array("id"=>$params["id"])),"DELETE"); break; case "deltree": return $this->getBasicQuery(array("table"=>$params["table"],"where"=>" parent_id = ".$params["id"]." OR child_id = ".$params["id"]),"DELETE"); break; case "unassoc_all_t1": $col = $params["t"]."_id"; return $this->getBasicQuery(array("table"=>$params["table"],"where"=>array($col=>$params["id"])),"DELETE"); break; case "unassoc_all_t2": $col = $params["t"]."2_id"; return $this->getBasicQuery(array("table"=>$params["table"],"where"=>array($col=>$params["id"])),"DELETE"); break; case "deltreetype": return $this->getQueryDeltreeType( $params ); break; case "unassoctype1": $col = $params["t1"]."_id"; $r = $this->getBasicQuery(array("table"=>$params["assoctable"],"where"=>array($col=>$params["id"])),"DELETE"); return $r; break; case "unassoctype2": $col = $params["t1"]."2_id"; $r =$this->getBasicQuery(array("table"=>$params["assoctable"],"where"=>array($col=>$params["id"])),"DELETE"); return $r; break; case "create_tree": return $this->getQueryCreateTree( $params ); break; case "unique": return $this->getQueryUnique( $params ); break; case "add_child": return $this->getQueryAddChild( $params ); break; case "get_children": return $this->getBasicQuery(array("table"=>$params["assoctable"],"fields"=>array("child_id"), "where"=>array("parent_id"=>$params["pid"]))); break; case "get_parent": return $this->getBasicQuery(array( "where"=>array("child_id"=>$params["cid"]),"fields"=>array("parent_id"),"table"=>$params["assoctable"] )); break; case "remove_child": return $this->getQueryRemoveChild( $params ); break; case "num_related": $col = $params["t1"]."_id"; return $this->getBasicQuery(array("field"=>"COUNT(1)","table"=>$params["assoctable"],"where"=>array($col=>$params["id"]))); break; case "drop_tables": return $this->getQueryDropTables( $params ); break; case "truncate_rtables": return "truncate redbeantables"; break; case "drop_column": return $this->getQueryDropColumn( $params ); break; case "describe": return $this->getQueryDescribe( $params ); break; case "get_null": return $this->getBasicQuery(array("field"=>"count(*)","table"=>$params["table"],"where"=>" `".$params["col"]."` IS NOT NULL ")); return $this->getQueryGetNull( $params ); break; case "test_column": return $this->getQueryTestColumn( $params ); break; case "update_test": return $this->getQueryUpdateTest( $params ); break; case "measure": return $this->getQueryMeasure( $params ); break; case "remove_test": return $this->getQueryRemoveTest($params); break; case "drop_test": return $this->getQueryDropTest($params); break; case "variance": return $this->getBasicQuery(array("field"=>"count(distinct `".$params["col"]."`)","table"=>$params["table"])); break; case "index1": return $this->getIndex1($params); break; case "index2": return $this->getIndex2($params); break; case "drop_type": return $this->getBasicQuery(array("table"=>$params["type"]),"DELETE"); break; case "destruct": return $this->getDestruct($params); break; default: throw new Exception("QueryWriter has no support for Query:".$queryname); } } public function getQuote() { return "\""; } public function getEscape() { return "`"; } }
interface RedBean_QueryWriter { public function getQuery( $queryname, $params=array() ); public function getQuote(); public function getEscape(); public function getTableColumns( $tbl, RedBean_DBAdapter $db ); }
if (!defined("RedBean_Setup_Namespace_PRFX")) define("RedBean_Setup_Namespace_PRFX",""); if (!defined("RedBean_Setup_Namespace_SFFX")) define("RedBean_Setup_Namespace_SFFX",""); class RedBean_Setup { public static function kickstart( $dsn="mysql:host=localhost;dbname=oodb", $username='root', $password='', $freeze=false, $engine="innodb", $debugmode=false, $unlockall=false) { if (!class_exists("R")) { eval("
				class R extends RedBean_OODB { }
			"); eval("
				class RD extends RedBean_Decorator { }
			"); } if (strpos($dsn,"embmysql")===0) { $dsn .= ';'; $matches = array(); preg_match('/host=(.+?);/',$dsn,$matches); $matches2 = array(); preg_match('/dbname=(.+?);/',$dsn,$matches2); if (count($matches)==2 && count($matches2)==2) { $db = RedBean_Driver_MySQL::getInstance( $matches[1], $username, $password, $matches2[1] ); } else { throw new Exception("Could not parse MySQL DSN"); } } else{ $db = new Redbean_Driver_PDO( $dsn, $username, $password, null ); } if ($debugmode) { $db->setDebugMode(1); } $oldconn = RedBean_OODB::getInstance()->getInstance()->getDatabase(); $conn = new RedBean_DBAdapter($db); RedBean_OODB::getInstance()->setDatabase( $conn ); RedBean_OODB::getInstance()->setEngine($engine); RedBean_OODB::getInstance()->init( new QueryWriter_MySQL() ); if ($unlockall) { RedBean_OODB::getInstance()->resetAll(); } if ($freeze) { RedBean_OODB::getInstance()->freeze(); } return $oldconn; } public static function kickstartDev( $gen, $dsn, $username="root", $password="", $debug=false ) { self::kickstart( $dsn, $username, $password, false, "innodb", $debug, false); RedBean_OODB::getInstance()->gen( $gen ); return RedBean_OODB::getInstance(); } public static function kickstartFrozen( $gen, $dsn, $username="root", $password="" ) { self::kickstart( $dsn, $username, $password, true, "innodb", false, false); RedBean_OODB::getInstance()->gen( $gen ); return RedBean_OODB::getInstance(); } public static function reconnect( RedBean_DBAdapter $new ) { $old = RedBean_OODB::getInstance()->getInstance()->getDatabase(); RedBean_OODB::getInstance()->getInstance()->setDatabase( $new ); return $old; } }
class RedBean_Sieve { private $vals; private $report = array(); private $succes = true; public static function make( $validations ) { $sieve = new self; $sieve->vals = $validations; return $sieve; } public function valid( RedBean_Decorator $deco ) { foreach($this->vals as $p => $v) { if (class_exists($v)) { $validator = new $v( $deco, $report ); if ($validator instanceof RedBean_Validator) { $message = $validator->check( $deco->$p ); if ($message !== true) { $this->succes = false; } if (!isset($this->report[$v])) { $this->report[$v]=array(); } $this->report[ $v ][ $p ] = $message; } } } return $this->succes; } public function validAndReport( RedBean_Decorator $deco, $key=false ) { $this->valid( $deco ); if ($key) { if (isset($this->report[$key])) { return $this->report[$key]; } } return $this->report; } public function getReport() { return $this->report; } }
class RedBean_Tools { private static $class_definitions; private static $remove_whitespaces; public static function walk_dir( $root, $callback, $recursive = true ) { $root = realpath($root); $dh = @opendir( $root ); if( false === $dh ) { return false; } while(false !== ($file = readdir($dh))) { if( "." == $file || ".." == $file ) { continue; } call_user_func( $callback, "{$root}/{$file}" ); if( false !== $recursive && is_dir( "{$root}/{$file}" )) { Redbean_Tools::walk_dir( "{$root}/{$file}", $callback, $recursive ); } } closedir($dh); return true; } public static function compile($file = '', $removeWhiteSpaces = true) { self::$remove_whitespaces = $removeWhiteSpaces; self::$class_definitions = ''; $base = dirname(__FILE__) . '/'; self::walk_dir($base,'Redbean_Tools::stripClassDefinition'); $content = str_replace("\r\n","\n", ' ' . "\n" . file_get_contents($base . 'license.txt') . "\n" . self::$class_definitions); if(!empty($file)) { file_put_contents($file, $content); } return $content; } private static function stripClassDefinition($file) { if(is_file($file) && substr($file, -4) == '.php') { echo "\n including.. $file "; if(self::$remove_whitespaces) { self::$class_definitions .= "\n" . trim(str_replace('', '', php_strip_whitespace($file))); } else { self::$class_definitions .= "\n" . trim(str_replace('', '', trim(file_get_contents($file)))); } } } }
class RedBean_Validator_AlphaNumeric implements RedBean_Validator { public function check( $v ) { return (bool) preg_match('/^[A-Za-z0-9]+$/', $v); } }
interface RedBean_Validator { public function check( $property ); }||||||||||||||||NO_DOC_COMMENTNO_RETURN_TYPE
(NO_PARAM_TYPENO_PARAM_DEFAULTNO_PARAM_TYPENO_PARAM_DEFAULTNO_PARAM_TYPENO_PARAM_DEFAULTNO_PARAM_TYPENO_PARAM_DEFAULT)
(
    (AST_ASSIGN
        (AST_VAR)
        (AST_METHOD_CALL
            (AST_PROP
                (AST_VAR))))
    (AST_ASSIGN
        (AST_VAR)
        (AST_VAR))
    (AST_IF
        (AST_IF_ELEM
            (AST_CALL
                (
                    (AST_VAR)))
            (
                (AST_ASSIGN
                    (AST_VAR)
                    (AST_METHOD_CALL
                        (AST_VAR)
                        (
                            (AST_VAR)
                            (AST_VAR)))))))
    (AST_ASSIGN
        (AST_VAR)
        (AST_CALL
            (
                (SCALAR)
                (SCALAR)
                (AST_VAR))))
    (AST_ASSIGN
        (AST_VAR)
        (AST_METHOD_CALL
            (AST_VAR)
            (
                (AST_BINARY_OP
                    (AST_METHOD_CALL
                        (AST_METHOD_CALL
                            (AST_PROP
                                (AST_VAR)))
                        (
                            (SCALAR)
                            (AST_ARRAY
                                (AST_ARRAY_ELEM
                                    (AST_VAR)
                                    (SCALAR)))))
                    (AST_VAR)))))
    (AST_ASSIGN
        (AST_VAR)
        (AST_METHOD_CALL
            (AST_VAR)))
    (AST_IF
        (AST_IF_ELEM
            (AST_BINARY_OP
                (AST_BINARY_OP
                    (AST_UNARY_OP
                        (AST_PROP
                            (AST_VAR)))
                    (AST_BINARY_OP
                        (AST_CALL
                            (
                                (AST_VAR)
                                (SCALAR)))
                        (AST_CONST)))
                (AST_BINARY_OP
                    (AST_VAR)
                    (SCALAR)))
            (
                (AST_ASSIGN
                    (AST_VAR)
                    (AST_ARRAY))
                (AST_IF
                    (AST_IF_ELEM
                        (AST_CALL
                            (
                                (SCALAR)
                                (AST_VAR)
                                (AST_VAR)))
                        (
                            (AST_IF
                                (AST_IF_ELEM
                                    (AST_BINARY_OP
                                        (AST_BINARY_OP
                                            (AST_CALL
                                                (
                                                    (AST_VAR)))
                                            (SCALAR))
                                        (AST_BINARY_OP
                                            (AST_CALL
                                                (
                                                    (AST_VAR)
                                                    (SCALAR)))
                                            (AST_CONST)))
                                    (
                                        (AST_ASSIGN
                                            (AST_VAR)
                                            (AST_CALL
                                                (
                                                    (AST_BINARY_OP
                                                        (AST_BINARY_OP
                                                            (SCALAR)
                                                            (AST_DIM
                                                                (AST_VAR)
                                                                (SCALAR)))
                                                        (SCALAR))
                                                    (SCALAR)
                                                    (AST_VAR))))
                                        (AST_ASSIGN
                                            (AST_VAR)
                                            (AST_CALL
                                                (
                                                    (AST_BINARY_OP
                                                        (AST_BINARY_OP
                                                            (SCALAR)
                                                            (AST_DIM
                                                                (AST_VAR)
                                                                (SCALAR)))
                                                        (SCALAR))
                                                    (SCALAR)
                                                    (AST_VAR))))
                                        (AST_RETURN
                                            (AST_METHOD_CALL
                                                (AST_VAR)
                                                (
                                                    (AST_VAR)
                                                    (AST_VAR)
                                                    (AST_VAR)
                                                    (AST_PRE_INC
                                                        (AST_VAR)))))))))))
                (AST_RETURN
                    (AST_ARRAY))))
        (AST_IF_ELEM
            (NULL)
            (
                (AST_IF
                    (AST_IF_ELEM
                        (AST_CALL
                            (
                                (AST_VAR)))
                        (
                            (AST_RETURN
                                (AST_VAR))))
                    (AST_IF_ELEM
                        (NULL)
                        (
                            (AST_RETURN
                                (AST_ARRAY)))))))))