||||||||class RedBean_OODB extends RedBean_Observable { private $writer; private $isFrozen = false; public function __construct( RedBean_QueryWriter $writer ) { $this->writer = $writer; $this->tableRegister = new RedBean_TableRegister( $writer ); } public function freeze( $tf ) { $isFrozen = (bool) $tf; } public function dispense($type ) { $bean = new RedBean_Bean(); $bean->__info = array( "type"=>$type ); $bean->id = 0; $this->check( $bean ); return $bean; } public function check( RedBean_OODBBean $bean ) { if (!isset($bean->__info)) { throw new RedBean_Exception_Security("Bean has no Meta Information"); } if (!isset($bean->id) || !isset($bean->__info["type"])) { throw new RedBean_Exception_Security("Bean has incomplete Meta Information"); } $pattern = '/[^abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789_]/'; if (preg_match($pattern,$bean->__info["type"])) { throw new RedBean_Exception_Security("Bean Type is invalid"); } foreach($bean as $prop=>$value) { if ( ($prop != "__info") && ( is_array($value) || is_object($value) || strlen($prop)<1 || preg_match($pattern,$prop) ) ) { throw new RedBean_Exception_Security("Invalid Bean: property $prop OR value $value "); } } } public function store( RedBean_OODBBean $bean ) { $this->signal( "update", $bean ); $this->check($bean); $table = $this->writer->escape($bean->__info["type"]); if (!$this->isFrozen) { $tables = $this->writer->getTables(); if (!in_array($table, $tables)) { $this->writer->createTable( $table ); } $columns = $this->writer->getColumns($table) ; $insertvalues = array(); $insertcolumns = array(); $updatevalues = array(); foreach( $bean as $p=>$v) { if ($p!="__info" && $p!="id") { $typeno = $this->writer->scanType($v); if (isset($columns[$p])) { $sqlt = $this->writer->code($columns[$p]); if ($typeno > $sqlt) { $this->writer->widenColumn( $table, $p, $typeno ); } } else { $this->writer->addColumn($table, $p, $typeno); } $insertvalues[] = $v; $insertcolumns[] = $p; $updatevalues[] = array( "property"=>$p, "value"=>$v ); } } if ($bean->id) { if (count($updatevalues)>0) { $this->writer->updateRecord( $table, $updatevalues, $bean->id ); } return (int) $bean->id; } else { $id = $this->writer->insertRecord( $table, $insertcolumns, $insertvalues ); $bean->id = $id; return (int) $id; } } } public function load($type, $id) { $bean = $this->dispense( $type ); $row = $this->writer->selectRecord($type,$id); foreach($row as $p=>$v) { $bean->$p = $v; } $this->signal( "open", $bean ); return $bean; } public function trash( $bean ) { $this->check( $bean ); $this->writer->deleteRecord( $bean->__info["type"], $bean->id ); } }
interface RedBean_OODBBean { } class RedBean_Bean implements RedBean_OODBBean { }
||||||||||||||||NO_DOC_COMMENTNO_RETURN_TYPE
(PARAM_TYPENO_PARAM_DEFAULT)
(
    (AST_METHOD_CALL
        (AST_VAR)
        (
            (SCALAR)
            (AST_VAR)))
    (AST_METHOD_CALL
        (AST_VAR)
        (
            (AST_VAR)))
    (AST_ASSIGN
        (AST_VAR)
        (AST_METHOD_CALL
            (AST_PROP
                (AST_VAR))
            (
                (AST_DIM
                    (AST_PROP
                        (AST_VAR))
                    (SCALAR)))))
    (AST_IF
        (AST_IF_ELEM
            (AST_UNARY_OP
                (AST_PROP
                    (AST_VAR)))
            (
                (AST_ASSIGN
                    (AST_VAR)
                    (AST_METHOD_CALL
                        (AST_PROP
                            (AST_VAR))))
                (AST_IF
                    (AST_IF_ELEM
                        (AST_UNARY_OP
                            (AST_CALL
                                (
                                    (AST_VAR)
                                    (AST_VAR))))
                        (
                            (AST_METHOD_CALL
                                (AST_PROP
                                    (AST_VAR))
                                (
                                    (AST_VAR))))))
                (AST_ASSIGN
                    (AST_VAR)
                    (AST_METHOD_CALL
                        (AST_PROP
                            (AST_VAR))
                        (
                            (AST_VAR))))
                (AST_ASSIGN
                    (AST_VAR)
                    (AST_ARRAY))
                (AST_ASSIGN
                    (AST_VAR)
                    (AST_ARRAY))
                (AST_ASSIGN
                    (AST_VAR)
                    (AST_ARRAY))
                (AST_FOREACH
                    (AST_VAR)
                    (AST_VAR)
                    (AST_VAR)
                    (
                        (AST_IF
                            (AST_IF_ELEM
                                (AST_BINARY_OP
                                    (AST_BINARY_OP
                                        (AST_VAR)
                                        (SCALAR))
                                    (AST_BINARY_OP
                                        (AST_VAR)
                                        (SCALAR)))
                                (
                                    (AST_ASSIGN
                                        (AST_VAR)
                                        (AST_METHOD_CALL
                                            (AST_PROP
                                                (AST_VAR))
                                            (
                                                (AST_VAR))))
                                    (AST_IF
                                        (AST_IF_ELEM
                                            (AST_ISSET
                                                (AST_DIM
                                                    (AST_VAR)
                                                    (AST_VAR)))
                                            (
                                                (AST_ASSIGN
                                                    (AST_VAR)
                                                    (AST_METHOD_CALL
                                                        (AST_PROP
                                                            (AST_VAR))
                                                        (
                                                            (AST_DIM
                                                                (AST_VAR)
                                                                (AST_VAR)))))
                                                (AST_IF
                                                    (AST_IF_ELEM
                                                        (AST_BINARY_OP
                                                            (AST_VAR)
                                                            (AST_VAR))
                                                        (
                                                            (AST_METHOD_CALL
                                                                (AST_PROP
                                                                    (AST_VAR))
                                                                (
                                                                    (AST_VAR)
                                                                    (AST_VAR)
                                                                    (AST_VAR))))))))
                                        (AST_IF_ELEM
                                            (NULL)
                                            (
                                                (AST_METHOD_CALL
                                                    (AST_PROP
                                                        (AST_VAR))
                                                    (
                                                        (AST_VAR)
                                                        (AST_VAR)
                                                        (AST_VAR))))))
                                    (AST_ASSIGN
                                        (AST_DIM
                                            (AST_VAR)
                                            (NULL))
                                        (AST_VAR))
                                    (AST_ASSIGN
                                        (AST_DIM
                                            (AST_VAR)
                                            (NULL))
                                        (AST_VAR))
                                    (AST_ASSIGN
                                        (AST_DIM
                                            (AST_VAR)
                                            (NULL))
                                        (AST_ARRAY
                                            (AST_ARRAY_ELEM
                                                (AST_VAR)
                                                (SCALAR))
                                            (AST_ARRAY_ELEM
                                                (AST_VAR)
                                                (SCALAR)))))))))
                (AST_IF
                    (AST_IF_ELEM
                        (AST_PROP
                            (AST_VAR))
                        (
                            (AST_IF
                                (AST_IF_ELEM
                                    (AST_BINARY_OP
                                        (AST_CALL
                                            (
                                                (AST_VAR)))
                                        (SCALAR))
                                    (
                                        (AST_METHOD_CALL
                                            (AST_PROP
                                                (AST_VAR))
                                            (
                                                (AST_VAR)
                                                (AST_VAR)
                                                (AST_PROP
                                                    (AST_VAR)))))))
                            (AST_RETURN
                                (AST_CAST
                                    (AST_PROP
                                        (AST_VAR))))))
                    (AST_IF_ELEM
                        (NULL)
                        (
                            (AST_ASSIGN
                                (AST_VAR)
                                (AST_METHOD_CALL
                                    (AST_PROP
                                        (AST_VAR))
                                    (
                                        (AST_VAR)
                                        (AST_VAR)
                                        (AST_VAR))))
                            (AST_ASSIGN
                                (AST_PROP
                                    (AST_VAR))
                                (AST_VAR))
                            (AST_RETURN
                                (AST_CAST
                                    (AST_VAR))))))))))