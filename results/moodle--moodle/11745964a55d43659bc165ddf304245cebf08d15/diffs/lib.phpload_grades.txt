||||||||    function load_grades() {
        // first make sure we have all final grades
        // TODO: check that no grade_item has needsupdate set
        grade_regrade_final_grades($this->id);

        if ($this->export_letters) {
            require_once($CFG->dirroot . '/grade/report/lib.php');
            $report = new grade_report($this->id, null, null);
            $letters = $report->get_grade_letters();
        } else {
            $letters = null;
        }

        if ($this->grade_items) {
            foreach ($this->grade_items as $gradeitem) {
                // load as an array of grade_final objects
                if ($itemgrades = $gradeitem->get_final() and !empty($this->students)) {
                    foreach ($this->students as $student) {
                        $finalgrade = null;
                        $feedback = '';
                        if (array_key_exists($student->id, $itemgrades)) {
                            $finalgrade = $itemgrades[$student->id]->finalgrade;
                            $grade = new grade_grade($itemgrades[$student->id], false);
                            if ($grade_text = $grade->load_text()) {
                                $feedback = format_text($grade_text->feedback, $grade_text->feedbackformat);
                            }
                        }

                        if ($this->export_letters) {
                            $grade_item_displaytype = $report->get_pref('gradedisplaytype', $gradeitem->id);
                            // TODO Convert final grade to letter if export option is on, and grade_item is set to letter type MDL-10490
                            if ($grade_item_displaytype == GRADE_REPORT_GRADE_DISPLAY_TYPE_LETTER) {
                                $finalgrade = grade_grade::get_letter($letters, $finalgrade,
                                            $gradeitem->grademin, $gradeitem->grademax);
                            }
                        }

                        $this->grades[$student->id][$gradeitem->id] = $finalgrade;
                        $this->comments[$student->id][$gradeitem->id] = $feedback;
                    }
                }
            }
        }
    }

    /**
     * To be implemented by child classe
     * TODO finish PHPdocs
     */
||||||||||||||||NO_DOC_COMMENTNO_RETURN_TYPE
(
    (AST_CALL
        (
            (AST_PROP
                (AST_VAR))))
    (AST_IF
        (AST_IF_ELEM
            (AST_PROP
                (AST_VAR))
            (
                (AST_INCLUDE_OR_EVAL
                    (AST_BINARY_OP
                        (AST_PROP
                            (AST_VAR))
                        (SCALAR)))
                (AST_ASSIGN
                    (AST_VAR)
                    (AST_NEW
                        (
                            (AST_PROP
                                (AST_VAR))
                            (AST_CONST)
                            (AST_CONST))))
                (AST_ASSIGN
                    (AST_VAR)
                    (AST_METHOD_CALL
                        (AST_VAR)))))
        (AST_IF_ELEM
            (NULL)
            (
                (AST_ASSIGN
                    (AST_VAR)
                    (AST_CONST)))))
    (AST_IF
        (AST_IF_ELEM
            (AST_PROP
                (AST_VAR))
            (
                (AST_FOREACH
                    (AST_PROP
                        (AST_VAR))
                    (AST_VAR)
                    (NULL)
                    (
                        (AST_IF
                            (AST_IF_ELEM
                                (AST_BINARY_OP
                                    (AST_ASSIGN
                                        (AST_VAR)
                                        (AST_METHOD_CALL
                                            (AST_VAR)))
                                    (AST_UNARY_OP
                                        (AST_EMPTY
                                            (AST_PROP
                                                (AST_VAR)))))
                                (
                                    (AST_FOREACH
                                        (AST_PROP
                                            (AST_VAR))
                                        (AST_VAR)
                                        (NULL)
                                        (
                                            (AST_ASSIGN
                                                (AST_VAR)
                                                (AST_CONST))
                                            (AST_ASSIGN
                                                (AST_VAR)
                                                (SCALAR))
                                            (AST_IF
                                                (AST_IF_ELEM
                                                    (AST_CALL
                                                        (
                                                            (AST_PROP
                                                                (AST_VAR))
                                                            (AST_VAR)))
                                                    (
                                                        (AST_ASSIGN
                                                            (AST_VAR)
                                                            (AST_PROP
                                                                (AST_DIM
                                                                    (AST_VAR)
                                                                    (AST_PROP
                                                                        (AST_VAR)))))
                                                        (AST_ASSIGN
                                                            (AST_VAR)
                                                            (AST_NEW
                                                                (
                                                                    (AST_DIM
                                                                        (AST_VAR)
                                                                        (AST_PROP
                                                                            (AST_VAR)))
                                                                    (AST_CONST))))
                                                        (AST_IF
                                                            (AST_IF_ELEM
                                                                (AST_ASSIGN
                                                                    (AST_VAR)
                                                                    (AST_METHOD_CALL
                                                                        (AST_VAR)))
                                                                (
                                                                    (AST_ASSIGN
                                                                        (AST_VAR)
                                                                        (AST_CALL
                                                                            (
                                                                                (AST_PROP
                                                                                    (AST_VAR))
                                                                                (AST_PROP
                                                                                    (AST_VAR)))))))))))
                                            (AST_IF
                                                (AST_IF_ELEM
                                                    (AST_PROP
                                                        (AST_VAR))
                                                    (
                                                        (AST_ASSIGN
                                                            (AST_VAR)
                                                            (AST_METHOD_CALL
                                                                (AST_VAR)
                                                                (
                                                                    (SCALAR)
                                                                    (AST_PROP
                                                                        (AST_VAR)))))
                                                        (AST_IF
                                                            (AST_IF_ELEM
                                                                (AST_BINARY_OP
                                                                    (AST_VAR)
                                                                    (AST_CONST))
                                                                (
                                                                    (AST_ASSIGN
                                                                        (AST_VAR)
                                                                        (AST_STATIC_CALL
                                                                            (
                                                                                (AST_VAR)
                                                                                (AST_VAR)
                                                                                (AST_PROP
                                                                                    (AST_VAR))
                                                                                (AST_PROP
                                                                                    (AST_VAR)))))))))))
                                            (AST_ASSIGN
                                                (AST_DIM
                                                    (AST_DIM
                                                        (AST_PROP
                                                            (AST_VAR))
                                                        (AST_PROP
                                                            (AST_VAR)))
                                                    (AST_PROP
                                                        (AST_VAR)))
                                                (AST_VAR))
                                            (AST_ASSIGN
                                                (AST_DIM
                                                    (AST_DIM
                                                        (AST_PROP
                                                            (AST_VAR))
                                                        (AST_PROP
                                                            (AST_VAR)))
                                                    (AST_PROP
                                                        (AST_VAR)))
                                                (AST_VAR)))))))))))))