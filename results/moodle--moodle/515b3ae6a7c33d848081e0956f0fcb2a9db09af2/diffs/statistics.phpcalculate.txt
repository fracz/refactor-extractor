    public function calculate($qubaids) {
        set_time_limit(0);

        list($lateststeps, $summarks, $summarksavg) = $this->get_latest_steps($qubaids);

        if ($lateststeps) {
            $subquestionstats = array();

            // Compute the statistics of position, and for random questions, work
            // out which questions appear in which positions.
            foreach ($lateststeps as $step) {
                $this->initial_steps_walker($step, $this->questions[$step->slot]->_stats, $summarks);

                // If this is a random question what is the real item being used?
                if ($step->questionid != $this->questions[$step->slot]->id) {
                    if (!isset($subquestionstats[$step->questionid])) {
                        $subquestionstats[$step->questionid] = $this->make_blank_question_stats();
                        $subquestionstats[$step->questionid]->questionid = $step->questionid;
                        $subquestionstats[$step->questionid]->usedin = array();
                        $subquestionstats[$step->questionid]->subquestion = true;
                        $subquestionstats[$step->questionid]->differentweights = false;
                        $subquestionstats[$step->questionid]->maxmark = $step->maxmark;
                    } else if ($subquestionstats[$step->questionid]->maxmark != $step->maxmark) {
                        $subquestionstats[$step->questionid]->differentweights = true;
                    }

                    $this->initial_steps_walker($step, $subquestionstats[$step->questionid], $summarks, false);

                    $number = $this->questions[$step->slot]->number;
                    $subquestionstats[$step->questionid]->usedin[$number] = $number;

                    $randomselectorstring = $this->questions[$step->slot]->category .
                        '/' . $this->questions[$step->slot]->questiontext;
                    if (!isset($this->randomselectors[$randomselectorstring])) {
                        $this->randomselectors[$randomselectorstring] = array();
                    }
                    $this->randomselectors[$randomselectorstring][$step->questionid] =
                        $step->questionid;
                }
            }

            foreach ($this->randomselectors as $key => $notused) {
                ksort($this->randomselectors[$key]);
            }

            // Compute the statistics of question id, if we need any.
            $this->subquestions = question_load_questions(array_keys($subquestionstats));
            foreach ($this->subquestions as $qid => $subquestion) {
                $subquestion->_stats = $subquestionstats[$qid];
                $subquestion->maxmark = $subquestion->_stats->maxmark;
                $subquestion->_stats->randomguessscore = $this->get_random_guess_score($subquestion);

                $this->initial_question_walker($subquestion->_stats);

                if ($subquestionstats[$qid]->differentweights) {
                    // TODO output here really sucks, but throwing is too severe.
                    global $OUTPUT;
                    echo $OUTPUT->notification(
                        get_string('erroritemappearsmorethanoncewithdifferentweight',
                                   'quiz_statistics', $this->subquestions[$qid]->name));
                }

                if ($subquestion->_stats->usedin) {
                    sort($subquestion->_stats->usedin, SORT_NUMERIC);
                    $subquestion->_stats->positions = implode(',', $subquestion->_stats->usedin);
                } else {
                    $subquestion->_stats->positions = '';
                }
            }

            // Finish computing the averages, and put the subquestion data into the
            // corresponding questions.

            // This cannot be a foreach loop because we need to have both
            // $question and $nextquestion available, but apart from that it is
            // foreach ($this->questions as $qid => $question).
            reset($this->questions);
            while (list($slot, $question) = each($this->questions)) {
                $nextquestion = current($this->questions);
                $question->_stats->positions = $question->number;
                $question->_stats->maxmark = $question->maxmark;
                $question->_stats->randomguessscore = $this->get_random_guess_score($question);

                $this->initial_question_walker($question->_stats);

                if ($question->qtype == 'random') {
                    $randomselectorstring = $question->category.'/'.$question->questiontext;
                    if ($nextquestion && $nextquestion->qtype == 'random') {
                        $nextrandomselectorstring = $nextquestion->category . '/' .
                            $nextquestion->questiontext;
                        if ($randomselectorstring == $nextrandomselectorstring) {
                            continue; // Next loop iteration.
                        }
                    }
                    if (isset($this->randomselectors[$randomselectorstring])) {
                        $question->_stats->subquestions = implode(',',
                                                                  $this->randomselectors[$randomselectorstring]);
                    }
                }
            }

            // Go through the records one more time.
            foreach ($lateststeps as $step) {
                $this->secondary_steps_walker($step, $this->questions[$step->slot]->_stats, $summarks, $summarksavg);

                if ($this->questions[$step->slot]->qtype == 'random') {
                    $this->secondary_steps_walker($step, $this->subquestions[$step->questionid]->_stats, $summarks, $summarksavg);
                }
            }

            $sumofcovariancewithoverallmark = 0;
            foreach ($this->questions as $slot => $question) {
                $this->secondary_question_walker($question->_stats);

                $this->sumofmarkvariance += $question->_stats->markvariance;

                if ($question->_stats->covariancewithoverallmark >= 0) {
                    $sumofcovariancewithoverallmark +=
                        sqrt($question->_stats->covariancewithoverallmark);
                    $question->_stats->negcovar = 0;
                } else {
                    $question->_stats->negcovar = 1;
                }
            }

            foreach ($this->subquestions as $subquestion) {
                $this->secondary_question_walker($subquestion->_stats);
            }

            foreach ($this->questions as $question) {
                if ($sumofcovariancewithoverallmark) {
                    if ($question->_stats->negcovar) {
                        $question->_stats->effectiveweight = null;
                    } else {
                        $question->_stats->effectiveweight = 100 *
                            sqrt($question->_stats->covariancewithoverallmark) /
                            $sumofcovariancewithoverallmark;
                    }
                } else {
                    $question->_stats->effectiveweight = null;
                }
            }
            $this->cache_stats($qubaids);
        }


    }

    /**
     * @param $qubaids qubaid_condition
     */
||||||||||||||||HAS_DOC_COMMENTNO_RETURN_TYPE
(NO_PARAM_TYPENO_PARAM_DEFAULT)
(
    (AST_CALL
        (
            (SCALAR)))
    (AST_ASSIGN
        (AST_ARRAY
            (AST_ARRAY_ELEM
                (AST_VAR)
                (NULL))
            (AST_ARRAY_ELEM
                (AST_VAR)
                (NULL))
            (AST_ARRAY_ELEM
                (AST_VAR)
                (NULL)))
        (AST_METHOD_CALL
            (AST_VAR)
            (
                (AST_VAR))))
    (AST_IF
        (AST_IF_ELEM
            (AST_VAR)
            (
                (AST_ASSIGN
                    (AST_VAR)
                    (AST_ARRAY))
                (AST_FOREACH
                    (AST_VAR)
                    (AST_VAR)
                    (NULL)
                    (
                        (AST_METHOD_CALL
                            (AST_VAR)
                            (
                                (AST_VAR)
                                (AST_PROP
                                    (AST_DIM
                                        (AST_PROP
                                            (AST_VAR))
                                        (AST_PROP
                                            (AST_VAR))))
                                (AST_VAR)))
                        (AST_IF
                            (AST_IF_ELEM
                                (AST_BINARY_OP
                                    (AST_PROP
                                        (AST_VAR))
                                    (AST_PROP
                                        (AST_DIM
                                            (AST_PROP
                                                (AST_VAR))
                                            (AST_PROP
                                                (AST_VAR)))))
                                (
                                    (AST_IF
                                        (AST_IF_ELEM
                                            (AST_UNARY_OP
                                                (AST_ISSET
                                                    (AST_DIM
                                                        (AST_VAR)
                                                        (AST_PROP
                                                            (AST_VAR)))))
                                            (
                                                (AST_ASSIGN
                                                    (AST_DIM
                                                        (AST_VAR)
                                                        (AST_PROP
                                                            (AST_VAR)))
                                                    (AST_METHOD_CALL
                                                        (AST_VAR)))
                                                (AST_ASSIGN
                                                    (AST_PROP
                                                        (AST_DIM
                                                            (AST_VAR)
                                                            (AST_PROP
                                                                (AST_VAR))))
                                                    (AST_PROP
                                                        (AST_VAR)))
                                                (AST_ASSIGN
                                                    (AST_PROP
                                                        (AST_DIM
                                                            (AST_VAR)
                                                            (AST_PROP
                                                                (AST_VAR))))
                                                    (AST_ARRAY))
                                                (AST_ASSIGN
                                                    (AST_PROP
                                                        (AST_DIM
                                                            (AST_VAR)
                                                            (AST_PROP
                                                                (AST_VAR))))
                                                    (AST_CONST))
                                                (AST_ASSIGN
                                                    (AST_PROP
                                                        (AST_DIM
                                                            (AST_VAR)
                                                            (AST_PROP
                                                                (AST_VAR))))
                                                    (AST_CONST))
                                                (AST_ASSIGN
                                                    (AST_PROP
                                                        (AST_DIM
                                                            (AST_VAR)
                                                            (AST_PROP
                                                                (AST_VAR))))
                                                    (AST_PROP
                                                        (AST_VAR)))))
                                        (AST_IF_ELEM
                                            (NULL)
                                            (
                                                (AST_IF
                                                    (AST_IF_ELEM
                                                        (AST_BINARY_OP
                                                            (AST_PROP
                                                                (AST_DIM
                                                                    (AST_VAR)
                                                                    (AST_PROP
                                                                        (AST_VAR))))
                                                            (AST_PROP
                                                                (AST_VAR)))
                                                        (
                                                            (AST_ASSIGN
                                                                (AST_PROP
                                                                    (AST_DIM
                                                                        (AST_VAR)
                                                                        (AST_PROP
                                                                            (AST_VAR))))
                                                                (AST_CONST))))))))
                                    (AST_METHOD_CALL
                                        (AST_VAR)
                                        (
                                            (AST_VAR)
                                            (AST_DIM
                                                (AST_VAR)
                                                (AST_PROP
                                                    (AST_VAR)))
                                            (AST_VAR)
                                            (AST_CONST)))
                                    (AST_ASSIGN
                                        (AST_VAR)
                                        (AST_PROP
                                            (AST_DIM
                                                (AST_PROP
                                                    (AST_VAR))
                                                (AST_PROP
                                                    (AST_VAR)))))
                                    (AST_ASSIGN
                                        (AST_DIM
                                            (AST_PROP
                                                (AST_DIM
                                                    (AST_VAR)
                                                    (AST_PROP
                                                        (AST_VAR))))
                                            (AST_VAR))
                                        (AST_VAR))
                                    (AST_ASSIGN
                                        (AST_VAR)
                                        (AST_BINARY_OP
                                            (AST_BINARY_OP
                                                (AST_PROP
                                                    (AST_DIM
                                                        (AST_PROP
                                                            (AST_VAR))
                                                        (AST_PROP
                                                            (AST_VAR))))
                                                (SCALAR))
                                            (AST_PROP
                                                (AST_DIM
                                                    (AST_PROP
                                                        (AST_VAR))
                                                    (AST_PROP
                                                        (AST_VAR))))))
                                    (AST_IF
                                        (AST_IF_ELEM
                                            (AST_UNARY_OP
                                                (AST_ISSET
                                                    (AST_DIM
                                                        (AST_PROP
                                                            (AST_VAR))
                                                        (AST_VAR))))
                                            (
                                                (AST_ASSIGN
                                                    (AST_DIM
                                                        (AST_PROP
                                                            (AST_VAR))
                                                        (AST_VAR))
                                                    (AST_ARRAY)))))
                                    (AST_ASSIGN
                                        (AST_DIM
                                            (AST_DIM
                                                (AST_PROP
                                                    (AST_VAR))
                                                (AST_VAR))
                                            (AST_PROP
                                                (AST_VAR)))
                                        (AST_PROP
                                            (AST_VAR))))))))
                (AST_FOREACH
                    (AST_PROP
                        (AST_VAR))
                    (AST_VAR)
                    (AST_VAR)
                    (
                        (AST_CALL
                            (
                                (AST_DIM
                                    (AST_PROP
                                        (AST_VAR))
                                    (AST_VAR))))))
                (AST_ASSIGN
                    (AST_PROP
                        (AST_VAR))
                    (AST_CALL
                        (
                            (AST_CALL
                                (
                                    (AST_VAR))))))
                (AST_FOREACH
                    (AST_PROP
                        (AST_VAR))
                    (AST_VAR)
                    (AST_VAR)
                    (
                        (AST_ASSIGN
                            (AST_PROP
                                (AST_VAR))
                            (AST_DIM
                                (AST_VAR)
                                (AST_VAR)))
                        (AST_ASSIGN
                            (AST_PROP
                                (AST_VAR))
                            (AST_PROP
                                (AST_PROP
                                    (AST_VAR))))
                        (AST_ASSIGN
                            (AST_PROP
                                (AST_PROP
                                    (AST_VAR)))
                            (AST_METHOD_CALL
                                (AST_VAR)
                                (
                                    (AST_VAR))))
                        (AST_METHOD_CALL
                            (AST_VAR)
                            (
                                (AST_PROP
                                    (AST_VAR))))
                        (AST_IF
                            (AST_IF_ELEM
                                (AST_PROP
                                    (AST_DIM
                                        (AST_VAR)
                                        (AST_VAR)))
                                (
                                    (AST_GLOBAL
                                        (AST_VAR))
                                    (AST_ECHO
                                        (AST_METHOD_CALL
                                            (AST_VAR)
                                            (
                                                (AST_CALL
                                                    (
                                                        (SCALAR)
                                                        (SCALAR)
                                                        (AST_PROP
                                                            (AST_DIM
                                                                (AST_PROP
                                                                    (AST_VAR))
                                                                (AST_VAR)))))))))))
                        (AST_IF
                            (AST_IF_ELEM
                                (AST_PROP
                                    (AST_PROP
                                        (AST_VAR)))
                                (
                                    (AST_CALL
                                        (
                                            (AST_PROP
                                                (AST_PROP
                                                    (AST_VAR)))
                                            (AST_CONST)))
                                    (AST_ASSIGN
                                        (AST_PROP
                                            (AST_PROP
                                                (AST_VAR)))
                                        (AST_CALL
                                            (
                                                (SCALAR)
                                                (AST_PROP
                                                    (AST_PROP
                                                        (AST_VAR))))))))
                            (AST_IF_ELEM
                                (NULL)
                                (
                                    (AST_ASSIGN
                                        (AST_PROP
                                            (AST_PROP
                                                (AST_VAR)))
                                        (SCALAR)))))))
                (AST_CALL
                    (
                        (AST_PROP
                            (AST_VAR))))
                (AST_WHILE
                    (AST_ASSIGN
                        (AST_ARRAY
                            (AST_ARRAY_ELEM
                                (AST_VAR)
                                (NULL))
                            (AST_ARRAY_ELEM
                                (AST_VAR)
                                (NULL)))
                        (AST_CALL
                            (
                                (AST_PROP
                                    (AST_VAR)))))
                    (
                        (AST_ASSIGN
                            (AST_VAR)
                            (AST_CALL
                                (
                                    (AST_PROP
                                        (AST_VAR)))))
                        (AST_ASSIGN
                            (AST_PROP
                                (AST_PROP
                                    (AST_VAR)))
                            (AST_PROP
                                (AST_VAR)))
                        (AST_ASSIGN
                            (AST_PROP
                                (AST_PROP
                                    (AST_VAR)))
                            (AST_PROP
                                (AST_VAR)))
                        (AST_ASSIGN
                            (AST_PROP
                                (AST_PROP
                                    (AST_VAR)))
                            (AST_METHOD_CALL
                                (AST_VAR)
                                (
                                    (AST_VAR))))
                        (AST_METHOD_CALL
                            (AST_VAR)
                            (
                                (AST_PROP
                                    (AST_VAR))))
                        (AST_IF
                            (AST_IF_ELEM
                                (AST_BINARY_OP
                                    (AST_PROP
                                        (AST_VAR))
                                    (SCALAR))
                                (
                                    (AST_ASSIGN
                                        (AST_VAR)
                                        (AST_BINARY_OP
                                            (AST_BINARY_OP
                                                (AST_PROP
                                                    (AST_VAR))
                                                (SCALAR))
                                            (AST_PROP
                                                (AST_VAR))))
                                    (AST_IF
                                        (AST_IF_ELEM
                                            (AST_BINARY_OP
                                                (AST_VAR)
                                                (AST_BINARY_OP
                                                    (AST_PROP
                                                        (AST_VAR))
                                                    (SCALAR)))
                                            (
                                                (AST_ASSIGN
                                                    (AST_VAR)
                                                    (AST_BINARY_OP
                                                        (AST_BINARY_OP
                                                            (AST_PROP
                                                                (AST_VAR))
                                                            (SCALAR))
                                                        (AST_PROP
                                                            (AST_VAR))))
                                                (AST_IF
                                                    (AST_IF_ELEM
                                                        (AST_BINARY_OP
                                                            (AST_VAR)
                                                            (AST_VAR))
                                                        (
                                                            (AST_CONTINUE
                                                                (NULL))))))))
                                    (AST_IF
                                        (AST_IF_ELEM
                                            (AST_ISSET
                                                (AST_DIM
                                                    (AST_PROP
                                                        (AST_VAR))
                                                    (AST_VAR)))
                                            (
                                                (AST_ASSIGN
                                                    (AST_PROP
                                                        (AST_PROP
                                                            (AST_VAR)))
                                                    (AST_CALL
                                                        (
                                                            (SCALAR)
                                                            (AST_DIM
                                                                (AST_PROP
                                                                    (AST_VAR))
                                                                (AST_VAR)))))))))))))
                (AST_FOREACH
                    (AST_VAR)
                    (AST_VAR)
                    (NULL)
                    (
                        (AST_METHOD_CALL
                            (AST_VAR)
                            (
                                (AST_VAR)
                                (AST_PROP
                                    (AST_DIM
                                        (AST_PROP
                                            (AST_VAR))
                                        (AST_PROP
                                            (AST_VAR))))
                                (AST_VAR)
                                (AST_VAR)))
                        (AST_IF
                            (AST_IF_ELEM
                                (AST_BINARY_OP
                                    (AST_PROP
                                        (AST_DIM
                                            (AST_PROP
                                                (AST_VAR))
                                            (AST_PROP
                                                (AST_VAR))))
                                    (SCALAR))
                                (
                                    (AST_METHOD_CALL
                                        (AST_VAR)
                                        (
                                            (AST_VAR)
                                            (AST_PROP
                                                (AST_DIM
                                                    (AST_PROP
                                                        (AST_VAR))
                                                    (AST_PROP
                                                        (AST_VAR))))
                                            (AST_VAR)
                                            (AST_VAR))))))))
                (AST_ASSIGN
                    (AST_VAR)
                    (SCALAR))
                (AST_FOREACH
                    (AST_PROP
                        (AST_VAR))
                    (AST_VAR)
                    (AST_VAR)
                    (
                        (AST_METHOD_CALL
                            (AST_VAR)
                            (
                                (AST_PROP
                                    (AST_VAR))))
                        (AST_ASSIGN_OP
                            (AST_PROP
                                (AST_VAR))
                            (AST_PROP
                                (AST_PROP
                                    (AST_VAR))))
                        (AST_IF
                            (AST_IF_ELEM
                                (AST_BINARY_OP
                                    (AST_PROP
                                        (AST_PROP
                                            (AST_VAR)))
                                    (SCALAR))
                                (
                                    (AST_ASSIGN_OP
                                        (AST_VAR)
                                        (AST_CALL
                                            (
                                                (AST_PROP
                                                    (AST_PROP
                                                        (AST_VAR))))))
                                    (AST_ASSIGN
                                        (AST_PROP
                                            (AST_PROP
                                                (AST_VAR)))
                                        (SCALAR))))
                            (AST_IF_ELEM
                                (NULL)
                                (
                                    (AST_ASSIGN
                                        (AST_PROP
                                            (AST_PROP
                                                (AST_VAR)))
                                        (SCALAR)))))))
                (AST_FOREACH
                    (AST_PROP
                        (AST_VAR))
                    (AST_VAR)
                    (NULL)
                    (
                        (AST_METHOD_CALL
                            (AST_VAR)
                            (
                                (AST_PROP
                                    (AST_VAR))))))
                (AST_FOREACH
                    (AST_PROP
                        (AST_VAR))
                    (AST_VAR)
                    (NULL)
                    (
                        (AST_IF
                            (AST_IF_ELEM
                                (AST_VAR)
                                (
                                    (AST_IF
                                        (AST_IF_ELEM
                                            (AST_PROP
                                                (AST_PROP
                                                    (AST_VAR)))
                                            (
                                                (AST_ASSIGN
                                                    (AST_PROP
                                                        (AST_PROP
                                                            (AST_VAR)))
                                                    (AST_CONST))))
                                        (AST_IF_ELEM
                                            (NULL)
                                            (
                                                (AST_ASSIGN
                                                    (AST_PROP
                                                        (AST_PROP
                                                            (AST_VAR)))
                                                    (AST_BINARY_OP
                                                        (AST_BINARY_OP
                                                            (SCALAR)
                                                            (AST_CALL
                                                                (
                                                                    (AST_PROP
                                                                        (AST_PROP
                                                                            (AST_VAR))))))
                                                        (AST_VAR))))))))
                            (AST_IF_ELEM
                                (NULL)
                                (
                                    (AST_ASSIGN
                                        (AST_PROP
                                            (AST_PROP
                                                (AST_VAR)))
                                        (AST_CONST)))))))
                (AST_METHOD_CALL
                    (AST_VAR)
                    (
                        (AST_VAR)))))))||||||||