private static void processGppMethodCalls(final PsiClass targetClass, final PsiMethod originalTarget, final Processor<PsiReference> originalProcessor, SearchScope scope, SearchRequestCollector originalCollector, @NotNull PsiMethod currentTarget) {
    final SearchScope gppScope = getGppScope(targetClass.getProject()).intersectWith(scope);
    final ReadActionProcessor<PsiReference> gppCallProcessor = new ReadActionProcessor<PsiReference>() {

        @Override
        public boolean processInReadAction(PsiReference psiReference) {
            if (psiReference instanceof GrReferenceElement) {
                final PsiElement parent = ((GrReferenceElement) psiReference).getParent();
                if (parent instanceof GrCall) {
                    final GrArgumentList argList = ((GrCall) parent).getArgumentList();
                    if (argList != null) {
                        boolean checkedTypedContext = false;
                        for (GrExpression argument : argList.getExpressionArguments()) {
                            if (argument instanceof GrListOrMap && !((GrListOrMap) argument).isMap()) {
                                if (!checkedTypedContext) {
                                    if (!GppTypeConverter.hasTypedContext(parent)) {
                                        return true;
                                    }
                                    checkedTypedContext = true;
                                }
                                for (PsiType psiType : GroovyExpectedTypesProvider.getDefaultExpectedTypes(argument)) {
                                    if (psiType instanceof PsiClassType && targetClass.getManager().areElementsEquivalent(targetClass, ((PsiClassType) psiType).resolve()) && !checkListInstantiation(originalTarget, originalProcessor, (GrListOrMap) argument, (PsiClassType) psiType)) {
                                        return false;
                                    }
                                }
                            }
                        }
                    }
                }
            }
            return true;
        }
    };
    if (currentTarget.isConstructor()) {
        processConstructorUsages(currentTarget, gppScope, gppCallProcessor, originalCollector, false);
    } else {
        MethodReferencesSearch.searchOptimized(currentTarget, gppScope, true, originalCollector, gppCallProcessor);
    }
}||||||||private static void processGppMethodCalls(final PsiClass targetClass, SearchScope scope, SearchRequestCollector originalCollector, @NotNull PsiMethod currentTarget, final boolean mapsNeeded, final PairProcessor<GrListOrMap, PsiClassType> literalProcessor) {
    final SearchScope gppScope = getGppScope(targetClass.getProject()).intersectWith(scope);
    final ReadActionProcessor<PsiReference> gppCallProcessor = new ReadActionProcessor<PsiReference>() {

        @Override
        public boolean processInReadAction(PsiReference psiReference) {
            if (psiReference instanceof GrReferenceElement) {
                final PsiElement parent = ((GrReferenceElement) psiReference).getParent();
                if (parent instanceof GrCall) {
                    final GrArgumentList argList = ((GrCall) parent).getArgumentList();
                    if (argList != null) {
                        boolean checkedTypedContext = false;
                        for (GrExpression argument : argList.getExpressionArguments()) {
                            if (argument instanceof GrListOrMap && (((GrListOrMap) argument).isMap() == mapsNeeded)) {
                                if (!checkedTypedContext) {
                                    if (!GppTypeConverter.hasTypedContext(parent)) {
                                        return true;
                                    }
                                    checkedTypedContext = true;
                                }
                                for (PsiType psiType : GroovyExpectedTypesProvider.getDefaultExpectedTypes(argument)) {
                                    if (psiType instanceof PsiClassType && targetClass.getManager().areElementsEquivalent(targetClass, ((PsiClassType) psiType).resolve()) && !literalProcessor.process((GrListOrMap) argument, (PsiClassType) psiType)) {
                                        return false;
                                    }
                                }
                            }
                        }
                    }
                }
            }
            return true;
        }
    };
    if (currentTarget.isConstructor()) {
        processConstructorUsages(currentTarget, gppScope, gppCallProcessor, originalCollector, false);
    } else {
        MethodReferencesSearch.searchOptimized(currentTarget, gppScope, true, originalCollector, gppCallProcessor);
    }
}||||||||(MethodDeclaration
	(BlockStmt
		(ExpressionStmt
			(VariableDeclarationExpr
				(VariableDeclarator
					(MethodCallExpr
						NameExpr
							SimpleName
						SimpleName
						(MethodCallExpr
							(MethodCallExpr
								SimpleName
								NameExpr
									SimpleName
							)
							SimpleName
						)
					)
					SimpleName
					(ClassOrInterfaceType
						SimpleName
					)
				)
			)
		)
		(ExpressionStmt
			(VariableDeclarationExpr
				(VariableDeclarator
					(ObjectCreationExpr
						(MethodDeclaration
							(BlockStmt
								(IfStmt
									(InstanceOfExpr
										NameExpr
											SimpleName
										(ClassOrInterfaceType
											SimpleName
										)
									)
									(BlockStmt
										(ExpressionStmt
											(VariableDeclarationExpr
												(VariableDeclarator
													(MethodCallExpr
														SimpleName
														(EnclosedExpr
															(CastExpr
																NameExpr
																	SimpleName
																(ClassOrInterfaceType
																	SimpleName
																)
															)
														)
													)
													SimpleName
													(ClassOrInterfaceType
														SimpleName
													)
												)
											)
										)
										(IfStmt
											(InstanceOfExpr
												NameExpr
													SimpleName
												(ClassOrInterfaceType
													SimpleName
												)
											)
											(BlockStmt
												(ExpressionStmt
													(VariableDeclarationExpr
														(VariableDeclarator
															(MethodCallExpr
																SimpleName
																(EnclosedExpr
																	(CastExpr
																		NameExpr
																			SimpleName
																		(ClassOrInterfaceType
																			SimpleName
																		)
																	)
																)
															)
															SimpleName
															(ClassOrInterfaceType
																SimpleName
															)
														)
													)
												)
												(IfStmt
													(BinaryExpr
														NameExpr
															SimpleName
														NullLiteralExpr
													)
													(BlockStmt
														(ExpressionStmt
															(VariableDeclarationExpr
																(VariableDeclarator
																	(BooleanLiteralExpr
																	)
																	SimpleName
																	(PrimitiveType
																	)
																)
															)
														)
														(ForeachStmt
															(BlockStmt
																(IfStmt
																	(BinaryExpr
																		(InstanceOfExpr
																			NameExpr
																				SimpleName
																			(ClassOrInterfaceType
																				SimpleName
																			)
																		)
																		(UnaryExpr
																			(MethodCallExpr
																				SimpleName
																				(EnclosedExpr
																					(CastExpr
																						NameExpr
																							SimpleName
																						(ClassOrInterfaceType
																							SimpleName
																						)
																					)
																				)
																			)
																		)
																	)
																	(BlockStmt
																		(IfStmt
																			(UnaryExpr
																				NameExpr
																					SimpleName
																			)
																			(BlockStmt
																				(IfStmt
																					(UnaryExpr
																						(MethodCallExpr
																							NameExpr
																								SimpleName
																							SimpleName
																							NameExpr
																								SimpleName
																						)
																					)
																					(BlockStmt
																						(ReturnStmt
																							(BooleanLiteralExpr
																							)
																						)
																					)
																				)
																				(ExpressionStmt
																					(AssignExpr
																						NameExpr
																							SimpleName
																						(BooleanLiteralExpr
																						)
																					)
																				)
																			)
																		)
																		(ForeachStmt
																			(BlockStmt
																				(IfStmt
																					(BinaryExpr
																						(BinaryExpr
																							(InstanceOfExpr
																								NameExpr
																									SimpleName
																								(ClassOrInterfaceType
																									SimpleName
																								)
																							)
																							(MethodCallExpr
																								NameExpr
																									SimpleName
																								(MethodCallExpr
																									SimpleName
																									(EnclosedExpr
																										(CastExpr
																											NameExpr
																												SimpleName
																											(ClassOrInterfaceType
																												SimpleName
																											)
																										)
																									)
																								)
																								SimpleName
																								(MethodCallExpr
																									SimpleName
																									NameExpr
																										SimpleName
																								)
																							)
																						)
																						(UnaryExpr
																							(MethodCallExpr
																								NameExpr
																									SimpleName
																								NameExpr
																									SimpleName
																								(CastExpr
																									NameExpr
																										SimpleName
																									(ClassOrInterfaceType
																										SimpleName
																									)
																								)
																								(CastExpr
																									NameExpr
																										SimpleName
																									(ClassOrInterfaceType
																										SimpleName
																									)
																								)
																								SimpleName
																							)
																						)
																					)
																					(BlockStmt
																						(ReturnStmt
																							(BooleanLiteralExpr
																							)
																						)
																					)
																				)
																			)
																			(MethodCallExpr
																				NameExpr
																					SimpleName
																				SimpleName
																				NameExpr
																					SimpleName
																			)
																			(VariableDeclarationExpr
																				(VariableDeclarator
																					SimpleName
																					(ClassOrInterfaceType
																						SimpleName
																					)
																				)
																			)
																		)
																	)
																)
															)
															(MethodCallExpr
																SimpleName
																NameExpr
																	SimpleName
															)
															(VariableDeclarationExpr
																(VariableDeclarator
																	SimpleName
																	(ClassOrInterfaceType
																		SimpleName
																	)
																)
															)
														)
													)
												)
											)
										)
									)
								)
								(ReturnStmt
									(BooleanLiteralExpr
									)
								)
							)
							(PrimitiveType
							)
							SimpleName
							(Parameter
								SimpleName
								(ClassOrInterfaceType
									SimpleName
								)
							)
							(MarkerAnnotationExpr
								Name
							)
						)
						(ClassOrInterfaceType
							SimpleName
							(ClassOrInterfaceType
								SimpleName
							)
						)
					)
					SimpleName
					(ClassOrInterfaceType
						SimpleName
						(ClassOrInterfaceType
							SimpleName
						)
					)
				)
			)
		)
		(IfStmt
			(MethodCallExpr
				SimpleName
				NameExpr
					SimpleName
			)
			(BlockStmt
				(ExpressionStmt
					(MethodCallExpr
						NameExpr
							SimpleName
						NameExpr
							SimpleName
						(BooleanLiteralExpr
						)
						NameExpr
							SimpleName
						NameExpr
							SimpleName
						SimpleName
						NameExpr
							SimpleName
					)
				)
			)
			(BlockStmt
				(ExpressionStmt
					(MethodCallExpr
						NameExpr
							SimpleName
						NameExpr
							SimpleName
						NameExpr
							SimpleName
						NameExpr
							SimpleName
						(BooleanLiteralExpr
						)
						SimpleName
					)
				)
			)
		)
	)
	(VoidType
	)
	SimpleName
	(Parameter
		SimpleName
		(ClassOrInterfaceType
			SimpleName
		)
	)
	(Parameter
		SimpleName
		(ClassOrInterfaceType
			SimpleName
		)
	)
	(Parameter
		SimpleName
		(ClassOrInterfaceType
			SimpleName
			(ClassOrInterfaceType
				SimpleName
			)
		)
	)
	(Parameter
		SimpleName
		(ClassOrInterfaceType
			SimpleName
		)
	)
	(Parameter
		SimpleName
		(ClassOrInterfaceType
			SimpleName
		)
	)
	(Parameter
		(MarkerAnnotationExpr
			Name
		)
		SimpleName
		(ClassOrInterfaceType
			SimpleName
		)
	)
)
||||||||(MethodDeclaration
	(BlockStmt
		(ExpressionStmt
			(VariableDeclarationExpr
				(VariableDeclarator
					(MethodCallExpr
						NameExpr
							SimpleName
						SimpleName
						(MethodCallExpr
							(MethodCallExpr
								SimpleName
								NameExpr
									SimpleName
							)
							SimpleName
						)
					)
					SimpleName
					(ClassOrInterfaceType
						SimpleName
					)
				)
			)
		)
		(ExpressionStmt
			(VariableDeclarationExpr
				(VariableDeclarator
					(ObjectCreationExpr
						(MethodDeclaration
							(BlockStmt
								(IfStmt
									(InstanceOfExpr
										NameExpr
											SimpleName
										(ClassOrInterfaceType
											SimpleName
										)
									)
									(BlockStmt
										(ExpressionStmt
											(VariableDeclarationExpr
												(VariableDeclarator
													(MethodCallExpr
														SimpleName
														(EnclosedExpr
															(CastExpr
																NameExpr
																	SimpleName
																(ClassOrInterfaceType
																	SimpleName
																)
															)
														)
													)
													SimpleName
													(ClassOrInterfaceType
														SimpleName
													)
												)
											)
										)
										(IfStmt
											(InstanceOfExpr
												NameExpr
													SimpleName
												(ClassOrInterfaceType
													SimpleName
												)
											)
											(BlockStmt
												(ExpressionStmt
													(VariableDeclarationExpr
														(VariableDeclarator
															(MethodCallExpr
																SimpleName
																(EnclosedExpr
																	(CastExpr
																		NameExpr
																			SimpleName
																		(ClassOrInterfaceType
																			SimpleName
																		)
																	)
																)
															)
															SimpleName
															(ClassOrInterfaceType
																SimpleName
															)
														)
													)
												)
												(IfStmt
													(BinaryExpr
														NameExpr
															SimpleName
														NullLiteralExpr
													)
													(BlockStmt
														(ExpressionStmt
															(VariableDeclarationExpr
																(VariableDeclarator
																	(BooleanLiteralExpr
																	)
																	SimpleName
																	(PrimitiveType
																	)
																)
															)
														)
														(ForeachStmt
															(BlockStmt
																(IfStmt
																	(BinaryExpr
																		(InstanceOfExpr
																			NameExpr
																				SimpleName
																			(ClassOrInterfaceType
																				SimpleName
																			)
																		)
																		(EnclosedExpr
																			(BinaryExpr
																				(MethodCallExpr
																					SimpleName
																					(EnclosedExpr
																						(CastExpr
																							NameExpr
																								SimpleName
																							(ClassOrInterfaceType
																								SimpleName
																							)
																						)
																					)
																				)
																				NameExpr
																					SimpleName
																			)
																		)
																	)
																	(BlockStmt
																		(IfStmt
																			(UnaryExpr
																				NameExpr
																					SimpleName
																			)
																			(BlockStmt
																				(IfStmt
																					(UnaryExpr
																						(MethodCallExpr
																							NameExpr
																								SimpleName
																							SimpleName
																							NameExpr
																								SimpleName
																						)
																					)
																					(BlockStmt
																						(ReturnStmt
																							(BooleanLiteralExpr
																							)
																						)
																					)
																				)
																				(ExpressionStmt
																					(AssignExpr
																						NameExpr
																							SimpleName
																						(BooleanLiteralExpr
																						)
																					)
																				)
																			)
																		)
																		(ForeachStmt
																			(BlockStmt
																				(IfStmt
																					(BinaryExpr
																						(BinaryExpr
																							(InstanceOfExpr
																								NameExpr
																									SimpleName
																								(ClassOrInterfaceType
																									SimpleName
																								)
																							)
																							(MethodCallExpr
																								NameExpr
																									SimpleName
																								(MethodCallExpr
																									SimpleName
																									(EnclosedExpr
																										(CastExpr
																											NameExpr
																												SimpleName
																											(ClassOrInterfaceType
																												SimpleName
																											)
																										)
																									)
																								)
																								SimpleName
																								(MethodCallExpr
																									SimpleName
																									NameExpr
																										SimpleName
																								)
																							)
																						)
																						(UnaryExpr
																							(MethodCallExpr
																								(CastExpr
																									NameExpr
																										SimpleName
																									(ClassOrInterfaceType
																										SimpleName
																									)
																								)
																								(CastExpr
																									NameExpr
																										SimpleName
																									(ClassOrInterfaceType
																										SimpleName
																									)
																								)
																								SimpleName
																								NameExpr
																									SimpleName
																							)
																						)
																					)
																					(BlockStmt
																						(ReturnStmt
																							(BooleanLiteralExpr
																							)
																						)
																					)
																				)
																			)
																			(MethodCallExpr
																				NameExpr
																					SimpleName
																				SimpleName
																				NameExpr
																					SimpleName
																			)
																			(VariableDeclarationExpr
																				(VariableDeclarator
																					SimpleName
																					(ClassOrInterfaceType
																						SimpleName
																					)
																				)
																			)
																		)
																	)
																)
															)
															(MethodCallExpr
																SimpleName
																NameExpr
																	SimpleName
															)
															(VariableDeclarationExpr
																(VariableDeclarator
																	SimpleName
																	(ClassOrInterfaceType
																		SimpleName
																	)
																)
															)
														)
													)
												)
											)
										)
									)
								)
								(ReturnStmt
									(BooleanLiteralExpr
									)
								)
							)
							(PrimitiveType
							)
							SimpleName
							(Parameter
								SimpleName
								(ClassOrInterfaceType
									SimpleName
								)
							)
							(MarkerAnnotationExpr
								Name
							)
						)
						(ClassOrInterfaceType
							SimpleName
							(ClassOrInterfaceType
								SimpleName
							)
						)
					)
					SimpleName
					(ClassOrInterfaceType
						SimpleName
						(ClassOrInterfaceType
							SimpleName
						)
					)
				)
			)
		)
		(IfStmt
			(MethodCallExpr
				SimpleName
				NameExpr
					SimpleName
			)
			(BlockStmt
				(ExpressionStmt
					(MethodCallExpr
						NameExpr
							SimpleName
						NameExpr
							SimpleName
						(BooleanLiteralExpr
						)
						NameExpr
							SimpleName
						NameExpr
							SimpleName
						SimpleName
						NameExpr
							SimpleName
					)
				)
			)
			(BlockStmt
				(ExpressionStmt
					(MethodCallExpr
						NameExpr
							SimpleName
						NameExpr
							SimpleName
						NameExpr
							SimpleName
						NameExpr
							SimpleName
						(BooleanLiteralExpr
						)
						SimpleName
					)
				)
			)
		)
	)
	(VoidType
	)
	SimpleName
	(Parameter
		SimpleName
		(ClassOrInterfaceType
			SimpleName
		)
	)
	(Parameter
		SimpleName
		(ClassOrInterfaceType
			SimpleName
		)
	)
	(Parameter
		SimpleName
		(ClassOrInterfaceType
			SimpleName
		)
	)
	(Parameter
		(MarkerAnnotationExpr
			Name
		)
		SimpleName
		(ClassOrInterfaceType
			SimpleName
		)
	)
	(Parameter
		SimpleName
		(PrimitiveType
		)
	)
	(Parameter
		SimpleName
		(ClassOrInterfaceType
			SimpleName
			(ClassOrInterfaceType
				SimpleName
			)
			(ClassOrInterfaceType
				SimpleName
			)
		)
	)
)

