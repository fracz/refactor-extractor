@Test
public void shouldHandleFragmentedMessage() throws Throwable {
    // Given
    when(factory.apply(ch, true)).thenReturn(protocol);
    available.put(1, factory);
    ProtocolChooser chooser = new ProtocolChooser(available, true);
    // When
    HandshakeOutcome firstOutcome = chooser.handleVersionHandshakeChunk(wrappedBuffer(new byte[] { (byte) 0x60, (byte) 0x60 }), ch);
    // When
    HandshakeOutcome secondOutcome = chooser.handleVersionHandshakeChunk(wrappedBuffer(new byte[] { (byte) 0xB0, (byte) 0x17 }), ch);
    HandshakeOutcome thirdOutcome = chooser.handleVersionHandshakeChunk(wrappedBuffer(new byte[] { 0, 0, 0, 0, 0, 0, 0 }), ch);
    HandshakeOutcome fourthOutcome = chooser.handleVersionHandshakeChunk(wrappedBuffer(new byte[] { 1, 0, 0, 0, 0, 0, 0, 0, 0 }), ch);
    // Then
    assertThat(firstOutcome, equalTo(PARTIAL_HANDSHAKE));
    assertThat(secondOutcome, equalTo(PARTIAL_HANDSHAKE));
    assertThat(thirdOutcome, equalTo(PARTIAL_HANDSHAKE));
    assertThat(fourthOutcome, equalTo(PROTOCOL_CHOSEN));
    assertThat(chooser.chosenProtocol(), equalTo(protocol));
}||||||||@Test
public void shouldHandleFragmentedMessage() throws Throwable {
    // Given
    when(factory.apply(ch, true)).thenReturn(protocol);
    available.put(1L, factory);
    ProtocolChooser chooser = new ProtocolChooser(available, false, true);
    // When
    HandshakeOutcome firstOutcome = chooser.handleVersionHandshakeChunk(wrappedBuffer(new byte[] { (byte) 0x60, (byte) 0x60 }), ch);
    // When
    HandshakeOutcome secondOutcome = chooser.handleVersionHandshakeChunk(wrappedBuffer(new byte[] { (byte) 0xB0, (byte) 0x17 }), ch);
    HandshakeOutcome thirdOutcome = chooser.handleVersionHandshakeChunk(wrappedBuffer(new byte[] { 0, 0, 0, 0, 0, 0, 0 }), ch);
    HandshakeOutcome fourthOutcome = chooser.handleVersionHandshakeChunk(wrappedBuffer(new byte[] { 1, 0, 0, 0, 0, 0, 0, 0, 0 }), ch);
    // Then
    assertThat(firstOutcome, equalTo(PARTIAL_HANDSHAKE));
    assertThat(secondOutcome, equalTo(PARTIAL_HANDSHAKE));
    assertThat(thirdOutcome, equalTo(PARTIAL_HANDSHAKE));
    assertThat(fourthOutcome, equalTo(PROTOCOL_CHOSEN));
    assertThat(chooser.chosenProtocol(), equalTo(protocol));
}||||||||(MethodDeclaration
	(BlockStmt
		(ExpressionStmt
			(MethodCallExpr
				NameExpr
					SimpleName
				SimpleName
				(MethodCallExpr
					(MethodCallExpr
						NameExpr
							SimpleName
						(BooleanLiteralExpr
						)
						SimpleName
						NameExpr
							SimpleName
					)
					SimpleName
				)
			)
			LineComment
		)
		(ExpressionStmt
			(MethodCallExpr
				(IntegerLiteralExpr
				)
				NameExpr
					SimpleName
				SimpleName
				NameExpr
					SimpleName
			)
		)
		(ExpressionStmt
			(VariableDeclarationExpr
				(VariableDeclarator
					(ObjectCreationExpr
						NameExpr
							SimpleName
						(BooleanLiteralExpr
						)
						(ClassOrInterfaceType
							SimpleName
						)
					)
					SimpleName
					(ClassOrInterfaceType
						SimpleName
					)
				)
			)
		)
		(ExpressionStmt
			(VariableDeclarationExpr
				(VariableDeclarator
					(MethodCallExpr
						(MethodCallExpr
							(ArrayCreationExpr
								(PrimitiveType
								)
								(ArrayInitializerExpr
									(CastExpr
										(IntegerLiteralExpr
										)
										(PrimitiveType
										)
									)
									(CastExpr
										(IntegerLiteralExpr
										)
										(PrimitiveType
										)
									)
								)
								(ArrayCreationLevel
								)
							)
							SimpleName
						)
						NameExpr
							SimpleName
						SimpleName
						NameExpr
							SimpleName
					)
					SimpleName
					(ClassOrInterfaceType
						SimpleName
					)
				)
			)
			LineComment
		)
		(ExpressionStmt
			(VariableDeclarationExpr
				(VariableDeclarator
					(MethodCallExpr
						(MethodCallExpr
							(ArrayCreationExpr
								(PrimitiveType
								)
								(ArrayInitializerExpr
									(CastExpr
										(IntegerLiteralExpr
										)
										(PrimitiveType
										)
									)
									(CastExpr
										(IntegerLiteralExpr
										)
										(PrimitiveType
										)
									)
								)
								(ArrayCreationLevel
								)
							)
							SimpleName
						)
						NameExpr
							SimpleName
						SimpleName
						NameExpr
							SimpleName
					)
					SimpleName
					(ClassOrInterfaceType
						SimpleName
					)
				)
			)
			LineComment
		)
		(ExpressionStmt
			(VariableDeclarationExpr
				(VariableDeclarator
					(MethodCallExpr
						(MethodCallExpr
							(ArrayCreationExpr
								(PrimitiveType
								)
								(ArrayInitializerExpr
									(IntegerLiteralExpr
									)
									(IntegerLiteralExpr
									)
									(IntegerLiteralExpr
									)
									(IntegerLiteralExpr
									)
									(IntegerLiteralExpr
									)
									(IntegerLiteralExpr
									)
									(IntegerLiteralExpr
									)
								)
								(ArrayCreationLevel
								)
							)
							SimpleName
						)
						NameExpr
							SimpleName
						SimpleName
						NameExpr
							SimpleName
					)
					SimpleName
					(ClassOrInterfaceType
						SimpleName
					)
				)
			)
		)
		(ExpressionStmt
			(VariableDeclarationExpr
				(VariableDeclarator
					(MethodCallExpr
						(MethodCallExpr
							(ArrayCreationExpr
								(PrimitiveType
								)
								(ArrayInitializerExpr
									(IntegerLiteralExpr
									)
									(IntegerLiteralExpr
									)
									(IntegerLiteralExpr
									)
									(IntegerLiteralExpr
									)
									(IntegerLiteralExpr
									)
									(IntegerLiteralExpr
									)
									(IntegerLiteralExpr
									)
									(IntegerLiteralExpr
									)
									(IntegerLiteralExpr
									)
								)
								(ArrayCreationLevel
								)
							)
							SimpleName
						)
						NameExpr
							SimpleName
						SimpleName
						NameExpr
							SimpleName
					)
					SimpleName
					(ClassOrInterfaceType
						SimpleName
					)
				)
			)
		)
		(ExpressionStmt
			(MethodCallExpr
				NameExpr
					SimpleName
				(MethodCallExpr
					NameExpr
						SimpleName
					SimpleName
				)
				SimpleName
			)
			LineComment
		)
		(ExpressionStmt
			(MethodCallExpr
				NameExpr
					SimpleName
				(MethodCallExpr
					NameExpr
						SimpleName
					SimpleName
				)
				SimpleName
			)
		)
		(ExpressionStmt
			(MethodCallExpr
				NameExpr
					SimpleName
				(MethodCallExpr
					NameExpr
						SimpleName
					SimpleName
				)
				SimpleName
			)
		)
		(ExpressionStmt
			(MethodCallExpr
				NameExpr
					SimpleName
				(MethodCallExpr
					NameExpr
						SimpleName
					SimpleName
				)
				SimpleName
			)
		)
		(ExpressionStmt
			(MethodCallExpr
				(MethodCallExpr
					SimpleName
					NameExpr
						SimpleName
				)
				(MethodCallExpr
					NameExpr
						SimpleName
					SimpleName
				)
				SimpleName
			)
		)
	)
	(VoidType
	)
	SimpleName
	(ClassOrInterfaceType
		SimpleName
	)
	(MarkerAnnotationExpr
		Name
	)
)
||||||||(MethodDeclaration
	(BlockStmt
		(ExpressionStmt
			(MethodCallExpr
				NameExpr
					SimpleName
				SimpleName
				(MethodCallExpr
					(MethodCallExpr
						NameExpr
							SimpleName
						(BooleanLiteralExpr
						)
						SimpleName
						NameExpr
							SimpleName
					)
					SimpleName
				)
			)
			LineComment
		)
		(ExpressionStmt
			(MethodCallExpr
				(LongLiteralExpr
				)
				NameExpr
					SimpleName
				SimpleName
				NameExpr
					SimpleName
			)
		)
		(ExpressionStmt
			(VariableDeclarationExpr
				(VariableDeclarator
					(ObjectCreationExpr
						NameExpr
							SimpleName
						(BooleanLiteralExpr
						)
						(BooleanLiteralExpr
						)
						(ClassOrInterfaceType
							SimpleName
						)
					)
					SimpleName
					(ClassOrInterfaceType
						SimpleName
					)
				)
			)
		)
		(ExpressionStmt
			(VariableDeclarationExpr
				(VariableDeclarator
					(MethodCallExpr
						(MethodCallExpr
							(ArrayCreationExpr
								(PrimitiveType
								)
								(ArrayInitializerExpr
									(CastExpr
										(IntegerLiteralExpr
										)
										(PrimitiveType
										)
									)
									(CastExpr
										(IntegerLiteralExpr
										)
										(PrimitiveType
										)
									)
								)
								(ArrayCreationLevel
								)
							)
							SimpleName
						)
						NameExpr
							SimpleName
						SimpleName
						NameExpr
							SimpleName
					)
					SimpleName
					(ClassOrInterfaceType
						SimpleName
					)
				)
			)
			LineComment
		)
		(ExpressionStmt
			(VariableDeclarationExpr
				(VariableDeclarator
					(MethodCallExpr
						(MethodCallExpr
							(ArrayCreationExpr
								(PrimitiveType
								)
								(ArrayInitializerExpr
									(CastExpr
										(IntegerLiteralExpr
										)
										(PrimitiveType
										)
									)
									(CastExpr
										(IntegerLiteralExpr
										)
										(PrimitiveType
										)
									)
								)
								(ArrayCreationLevel
								)
							)
							SimpleName
						)
						NameExpr
							SimpleName
						SimpleName
						NameExpr
							SimpleName
					)
					SimpleName
					(ClassOrInterfaceType
						SimpleName
					)
				)
			)
			LineComment
		)
		(ExpressionStmt
			(VariableDeclarationExpr
				(VariableDeclarator
					(MethodCallExpr
						(MethodCallExpr
							(ArrayCreationExpr
								(PrimitiveType
								)
								(ArrayInitializerExpr
									(IntegerLiteralExpr
									)
									(IntegerLiteralExpr
									)
									(IntegerLiteralExpr
									)
									(IntegerLiteralExpr
									)
									(IntegerLiteralExpr
									)
									(IntegerLiteralExpr
									)
									(IntegerLiteralExpr
									)
								)
								(ArrayCreationLevel
								)
							)
							SimpleName
						)
						NameExpr
							SimpleName
						SimpleName
						NameExpr
							SimpleName
					)
					SimpleName
					(ClassOrInterfaceType
						SimpleName
					)
				)
			)
		)
		(ExpressionStmt
			(VariableDeclarationExpr
				(VariableDeclarator
					(MethodCallExpr
						(MethodCallExpr
							(ArrayCreationExpr
								(PrimitiveType
								)
								(ArrayInitializerExpr
									(IntegerLiteralExpr
									)
									(IntegerLiteralExpr
									)
									(IntegerLiteralExpr
									)
									(IntegerLiteralExpr
									)
									(IntegerLiteralExpr
									)
									(IntegerLiteralExpr
									)
									(IntegerLiteralExpr
									)
									(IntegerLiteralExpr
									)
									(IntegerLiteralExpr
									)
								)
								(ArrayCreationLevel
								)
							)
							SimpleName
						)
						NameExpr
							SimpleName
						SimpleName
						NameExpr
							SimpleName
					)
					SimpleName
					(ClassOrInterfaceType
						SimpleName
					)
				)
			)
		)
		(ExpressionStmt
			(MethodCallExpr
				NameExpr
					SimpleName
				(MethodCallExpr
					NameExpr
						SimpleName
					SimpleName
				)
				SimpleName
			)
			LineComment
		)
		(ExpressionStmt
			(MethodCallExpr
				NameExpr
					SimpleName
				(MethodCallExpr
					NameExpr
						SimpleName
					SimpleName
				)
				SimpleName
			)
		)
		(ExpressionStmt
			(MethodCallExpr
				NameExpr
					SimpleName
				(MethodCallExpr
					NameExpr
						SimpleName
					SimpleName
				)
				SimpleName
			)
		)
		(ExpressionStmt
			(MethodCallExpr
				NameExpr
					SimpleName
				(MethodCallExpr
					NameExpr
						SimpleName
					SimpleName
				)
				SimpleName
			)
		)
		(ExpressionStmt
			(MethodCallExpr
				(MethodCallExpr
					SimpleName
					NameExpr
						SimpleName
				)
				(MethodCallExpr
					NameExpr
						SimpleName
					SimpleName
				)
				SimpleName
			)
		)
	)
	(VoidType
	)
	SimpleName
	(ClassOrInterfaceType
		SimpleName
	)
	(MarkerAnnotationExpr
		Name
	)
)

