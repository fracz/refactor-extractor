public void onSuspend(final AtmosphereResourceEvent<HttpServletRequest, HttpServletResponse> event) {
    final HttpServletRequest request = event.getResource().getRequest();
    if (!isAtmosphereTransport(request)) {
        event.getResource().resume();
        return;
    }
    // we need a listener which we attach to our items
    stateChangeListener = new StateChangeListener() {

        private volatile Boolean fired = false;

        public void stateUpdated(Item item, State state) {
        }

        public void stateChanged(Item item, State oldState, State newState) {
            synchronized (fired) {
                if (!fired || !isResumingTransport(request)) {
                    fired = true;
                    // a change happened, so we are done and send the response!
                    try {
                        // this is a workaround for the fact that there are usually many events being sent when a group receives a command
                        // (e.g. "All off"). By waiting a moment, we can increase the chance to return all those updated values in our response
                        Thread.sleep(200);
                    } catch (InterruptedException e) {
                    }
                    event.getResource().getBroadcaster().broadcast(getResponseObject(event));
                }
            // else do nothing as we have already sent the update
            }
        }
    };
    registerStateChangeListenerOnRelevantItems(request, stateChangeListener);
}||||||||public void onSuspend(final AtmosphereResourceEvent<HttpServletRequest, HttpServletResponse> event) {
    final HttpServletRequest request = event.getResource().getRequest();
    // we need a listener which we attach to our items
    stateChangeListener = new StateChangeListener() {

        private volatile Boolean fired = false;

        public void stateUpdated(Item item, State state) {
        }

        public void stateChanged(Item item, State oldState, State newState) {
            synchronized (fired) {
                if (!fired || !isResumingTransport(request)) {
                    fired = true;
                    // a change happened, so we are done and send the response!
                    try {
                        // this is a workaround for the fact that there are usually many events being sent when a group receives a command
                        // (e.g. "All off"). By waiting a moment, we can increase the chance to return all those updated values in our response
                        Thread.sleep(200);
                    } catch (InterruptedException e) {
                    }
                    event.getResource().getBroadcaster().broadcast(getResponseObject(event));
                }
            // else do nothing as we have already sent the update
            }
        }
    };
    registerStateChangeListenerOnRelevantItems(request, stateChangeListener);
}||||||||(MethodDeclaration
	(BlockStmt
		(ExpressionStmt
			(VariableDeclarationExpr
				(VariableDeclarator
					(MethodCallExpr
						SimpleName
						(MethodCallExpr
							SimpleName
							NameExpr
								SimpleName
						)
					)
					SimpleName
					(ClassOrInterfaceType
						SimpleName
					)
				)
			)
		)
		(IfStmt
			(UnaryExpr
				(MethodCallExpr
					NameExpr
						SimpleName
					SimpleName
				)
			)
			(BlockStmt
				(ExpressionStmt
					(MethodCallExpr
						SimpleName
						(MethodCallExpr
							SimpleName
							NameExpr
								SimpleName
						)
					)
				)
				(ReturnStmt
				)
			)
		)
		(ExpressionStmt
			(AssignExpr
				NameExpr
					SimpleName
				(ObjectCreationExpr
					(FieldDeclaration
						(VariableDeclarator
							(BooleanLiteralExpr
							)
							SimpleName
							(ClassOrInterfaceType
								SimpleName
							)
						)
					)
					(MethodDeclaration
						(BlockStmt
						)
						(VoidType
						)
						SimpleName
						(Parameter
							SimpleName
							(ClassOrInterfaceType
								SimpleName
							)
						)
						(Parameter
							SimpleName
							(ClassOrInterfaceType
								SimpleName
							)
						)
					)
					(MethodDeclaration
						(BlockStmt
							(SynchronizedStmt
								(BlockStmt
									(IfStmt
										(BinaryExpr
											(UnaryExpr
												NameExpr
													SimpleName
											)
											(UnaryExpr
												(MethodCallExpr
													NameExpr
														SimpleName
													SimpleName
												)
											)
										)
										(BlockStmt
											(ExpressionStmt
												(AssignExpr
													NameExpr
														SimpleName
													(BooleanLiteralExpr
													)
												)
											)
											(TryStmt
												(CatchClause
													(BlockStmt
													)
													(Parameter
														SimpleName
														(ClassOrInterfaceType
															SimpleName
														)
													)
												)
												(BlockStmt
													(ExpressionStmt
														(MethodCallExpr
															(IntegerLiteralExpr
															)
															SimpleName
															NameExpr
																SimpleName
														)
														LineComment
													)
												)
												LineComment
											)
											(ExpressionStmt
												(MethodCallExpr
													(MethodCallExpr
														NameExpr
															SimpleName
														SimpleName
													)
													SimpleName
													(MethodCallExpr
														SimpleName
														(MethodCallExpr
															SimpleName
															NameExpr
																SimpleName
														)
													)
												)
											)
										)
									)
								)
								NameExpr
									SimpleName
							)
						)
						(VoidType
						)
						SimpleName
						(Parameter
							SimpleName
							(ClassOrInterfaceType
								SimpleName
							)
						)
						(Parameter
							SimpleName
							(ClassOrInterfaceType
								SimpleName
							)
						)
						(Parameter
							SimpleName
							(ClassOrInterfaceType
								SimpleName
							)
						)
					)
					(ClassOrInterfaceType
						SimpleName
					)
				)
			)
			LineComment
		)
		(ExpressionStmt
			(MethodCallExpr
				NameExpr
					SimpleName
				NameExpr
					SimpleName
				SimpleName
			)
		)
	)
	(VoidType
	)
	SimpleName
	(Parameter
		SimpleName
		(ClassOrInterfaceType
			SimpleName
			(ClassOrInterfaceType
				SimpleName
			)
			(ClassOrInterfaceType
				SimpleName
			)
		)
	)
)
||||||||(MethodDeclaration
	(BlockStmt
		(ExpressionStmt
			(VariableDeclarationExpr
				(VariableDeclarator
					(MethodCallExpr
						SimpleName
						(MethodCallExpr
							SimpleName
							NameExpr
								SimpleName
						)
					)
					SimpleName
					(ClassOrInterfaceType
						SimpleName
					)
				)
			)
		)
		(ExpressionStmt
			(AssignExpr
				NameExpr
					SimpleName
				(ObjectCreationExpr
					(FieldDeclaration
						(VariableDeclarator
							(BooleanLiteralExpr
							)
							SimpleName
							(ClassOrInterfaceType
								SimpleName
							)
						)
					)
					(MethodDeclaration
						(BlockStmt
						)
						(VoidType
						)
						SimpleName
						(Parameter
							SimpleName
							(ClassOrInterfaceType
								SimpleName
							)
						)
						(Parameter
							SimpleName
							(ClassOrInterfaceType
								SimpleName
							)
						)
					)
					(MethodDeclaration
						(BlockStmt
							(SynchronizedStmt
								(BlockStmt
									(IfStmt
										(BinaryExpr
											(UnaryExpr
												NameExpr
													SimpleName
											)
											(UnaryExpr
												(MethodCallExpr
													NameExpr
														SimpleName
													SimpleName
												)
											)
										)
										(BlockStmt
											(ExpressionStmt
												(AssignExpr
													NameExpr
														SimpleName
													(BooleanLiteralExpr
													)
												)
											)
											(TryStmt
												(CatchClause
													(BlockStmt
													)
													(Parameter
														SimpleName
														(ClassOrInterfaceType
															SimpleName
														)
													)
												)
												(BlockStmt
													(ExpressionStmt
														(MethodCallExpr
															(IntegerLiteralExpr
															)
															SimpleName
															NameExpr
																SimpleName
														)
														LineComment
													)
												)
												LineComment
											)
											(ExpressionStmt
												(MethodCallExpr
													(MethodCallExpr
														NameExpr
															SimpleName
														SimpleName
													)
													SimpleName
													(MethodCallExpr
														SimpleName
														(MethodCallExpr
															SimpleName
															NameExpr
																SimpleName
														)
													)
												)
											)
										)
									)
								)
								NameExpr
									SimpleName
							)
						)
						(VoidType
						)
						SimpleName
						(Parameter
							SimpleName
							(ClassOrInterfaceType
								SimpleName
							)
						)
						(Parameter
							SimpleName
							(ClassOrInterfaceType
								SimpleName
							)
						)
						(Parameter
							SimpleName
							(ClassOrInterfaceType
								SimpleName
							)
						)
					)
					(ClassOrInterfaceType
						SimpleName
					)
				)
			)
			LineComment
		)
		(ExpressionStmt
			(MethodCallExpr
				NameExpr
					SimpleName
				NameExpr
					SimpleName
				SimpleName
			)
		)
	)
	(VoidType
	)
	SimpleName
	(Parameter
		SimpleName
		(ClassOrInterfaceType
			SimpleName
			(ClassOrInterfaceType
				SimpleName
			)
			(ClassOrInterfaceType
				SimpleName
			)
		)
	)
)

