@Test
public void testNgramHighlightingWithBrokenPositions() throws IOException {
    assertAcked(prepareCreate("test").addMapping("test", jsonBuilder().startObject().startObject("test").startObject("properties").startObject("name").startObject("fields").startObject("autocomplete").field("type", "string").field("analyzer", "autocomplete").field("search_analyzer", "search_autocomplete").field("term_vector", "with_positions_offsets").endObject().startObject("name").field("type", "string").endObject().endObject().field("type", "multi_field").endObject().endObject().endObject()).setSettings(settingsBuilder().put(indexSettings()).put("analysis.tokenizer.autocomplete.max_gram", 20).put("analysis.tokenizer.autocomplete.min_gram", 1).put("analysis.tokenizer.autocomplete.token_chars", "letter,digit").put("analysis.tokenizer.autocomplete.type", "nGram").put("analysis.filter.wordDelimiter.type", "word_delimiter").putArray("analysis.filter.wordDelimiter.type_table", "& => ALPHANUM", "| => ALPHANUM", "! => ALPHANUM", "? => ALPHANUM", ". => ALPHANUM", "- => ALPHANUM", "# => ALPHANUM", "% => ALPHANUM", "+ => ALPHANUM", ", => ALPHANUM", "~ => ALPHANUM", ": => ALPHANUM", "/ => ALPHANUM", "^ => ALPHANUM", "$ => ALPHANUM", "@ => ALPHANUM", ") => ALPHANUM", "( => ALPHANUM", "] => ALPHANUM", "[ => ALPHANUM", "} => ALPHANUM", "{ => ALPHANUM").put("analysis.filter.wordDelimiter.type.split_on_numerics", false).put("analysis.filter.wordDelimiter.generate_word_parts", true).put("analysis.filter.wordDelimiter.generate_number_parts", false).put("analysis.filter.wordDelimiter.catenate_words", true).put("analysis.filter.wordDelimiter.catenate_numbers", true).put("analysis.filter.wordDelimiter.catenate_all", false).put("analysis.analyzer.autocomplete.tokenizer", "autocomplete").putArray("analysis.analyzer.autocomplete.filter", "lowercase", "wordDelimiter").put("analysis.analyzer.search_autocomplete.tokenizer", "whitespace").putArray("analysis.analyzer.search_autocomplete.filter", "lowercase", "wordDelimiter")));
    ensureYellow();
    client().prepareIndex("test", "test", "1").setSource("name", "ARCOTEL Hotels Deutschland").get();
    refresh();
    SearchResponse search = client().prepareSearch("test").setTypes("test").setQuery(matchQuery("name.autocomplete", "deut tel").operator(Operator.OR)).highlighter(new HighlightBuilder().field("name.autocomplete")).execute().actionGet();
    assertHighlight(search, 0, "name.autocomplete", 0, equalTo("ARCO<em>TEL</em> Ho<em>tel</em>s <em>Deut</em>schland"));
}||||||||public void testNgramHighlightingWithBrokenPositions() throws IOException {
    assertAcked(prepareCreate("test").addMapping("test", jsonBuilder().startObject().startObject("test").startObject("properties").startObject("name").startObject("fields").startObject("autocomplete").field("type", "string").field("analyzer", "autocomplete").field("search_analyzer", "search_autocomplete").field("term_vector", "with_positions_offsets").endObject().startObject("name").field("type", "string").endObject().endObject().field("type", "multi_field").endObject().endObject().endObject()).setSettings(settingsBuilder().put(indexSettings()).put("analysis.tokenizer.autocomplete.max_gram", 20).put("analysis.tokenizer.autocomplete.min_gram", 1).put("analysis.tokenizer.autocomplete.token_chars", "letter,digit").put("analysis.tokenizer.autocomplete.type", "nGram").put("analysis.filter.wordDelimiter.type", "word_delimiter").putArray("analysis.filter.wordDelimiter.type_table", "& => ALPHANUM", "| => ALPHANUM", "! => ALPHANUM", "? => ALPHANUM", ". => ALPHANUM", "- => ALPHANUM", "# => ALPHANUM", "% => ALPHANUM", "+ => ALPHANUM", ", => ALPHANUM", "~ => ALPHANUM", ": => ALPHANUM", "/ => ALPHANUM", "^ => ALPHANUM", "$ => ALPHANUM", "@ => ALPHANUM", ") => ALPHANUM", "( => ALPHANUM", "] => ALPHANUM", "[ => ALPHANUM", "} => ALPHANUM", "{ => ALPHANUM").put("analysis.filter.wordDelimiter.type.split_on_numerics", false).put("analysis.filter.wordDelimiter.generate_word_parts", true).put("analysis.filter.wordDelimiter.generate_number_parts", false).put("analysis.filter.wordDelimiter.catenate_words", true).put("analysis.filter.wordDelimiter.catenate_numbers", true).put("analysis.filter.wordDelimiter.catenate_all", false).put("analysis.analyzer.autocomplete.tokenizer", "autocomplete").putArray("analysis.analyzer.autocomplete.filter", "lowercase", "wordDelimiter").put("analysis.analyzer.search_autocomplete.tokenizer", "whitespace").putArray("analysis.analyzer.search_autocomplete.filter", "lowercase", "wordDelimiter")));
    ensureYellow();
    client().prepareIndex("test", "test", "1").setSource("name", "ARCOTEL Hotels Deutschland").get();
    refresh();
    SearchResponse search = client().prepareSearch("test").setTypes("test").setQuery(matchQuery("name.autocomplete", "deut tel").operator(Operator.OR)).highlighter(new HighlightBuilder().field("name.autocomplete")).execute().actionGet();
    assertHighlight(search, 0, "name.autocomplete", 0, equalTo("ARCO<em>TEL</em> Ho<em>tel</em>s <em>Deut</em>schland"));
}||||||||(MethodDeclaration
	(BlockStmt
		(ExpressionStmt
			(MethodCallExpr
				(MethodCallExpr
					(MethodCallExpr
						StringLiteralExpr
						StringLiteralExpr
						StringLiteralExpr
						SimpleName
						(MethodCallExpr
							StringLiteralExpr
							StringLiteralExpr
							SimpleName
							(MethodCallExpr
								StringLiteralExpr
								StringLiteralExpr
								StringLiteralExpr
								SimpleName
								(MethodCallExpr
									StringLiteralExpr
									StringLiteralExpr
									SimpleName
									(MethodCallExpr
										StringLiteralExpr
										(BooleanLiteralExpr
										)
										SimpleName
										(MethodCallExpr
											StringLiteralExpr
											(BooleanLiteralExpr
											)
											SimpleName
											(MethodCallExpr
												StringLiteralExpr
												(BooleanLiteralExpr
												)
												SimpleName
												(MethodCallExpr
													StringLiteralExpr
													(BooleanLiteralExpr
													)
													SimpleName
													(MethodCallExpr
														StringLiteralExpr
														(BooleanLiteralExpr
														)
														SimpleName
														(MethodCallExpr
															StringLiteralExpr
															(BooleanLiteralExpr
															)
															SimpleName
															(MethodCallExpr
																StringLiteralExpr
																StringLiteralExpr
																StringLiteralExpr
																StringLiteralExpr
																StringLiteralExpr
																StringLiteralExpr
																StringLiteralExpr
																StringLiteralExpr
																StringLiteralExpr
																StringLiteralExpr
																StringLiteralExpr
																StringLiteralExpr
																StringLiteralExpr
																StringLiteralExpr
																StringLiteralExpr
																StringLiteralExpr
																StringLiteralExpr
																StringLiteralExpr
																StringLiteralExpr
																StringLiteralExpr
																StringLiteralExpr
																StringLiteralExpr
																StringLiteralExpr
																SimpleName
																(MethodCallExpr
																	StringLiteralExpr
																	StringLiteralExpr
																	SimpleName
																	(MethodCallExpr
																		StringLiteralExpr
																		StringLiteralExpr
																		SimpleName
																		(MethodCallExpr
																			StringLiteralExpr
																			StringLiteralExpr
																			SimpleName
																			(MethodCallExpr
																				StringLiteralExpr
																				(IntegerLiteralExpr
																				)
																				SimpleName
																				(MethodCallExpr
																					StringLiteralExpr
																					(IntegerLiteralExpr
																					)
																					SimpleName
																					(MethodCallExpr
																						(MethodCallExpr
																							SimpleName
																						)
																						SimpleName
																						(MethodCallExpr
																							SimpleName
																						)
																					)
																				)
																			)
																		)
																	)
																)
															)
														)
													)
												)
											)
										)
									)
								)
							)
						)
					)
					SimpleName
					(MethodCallExpr
						StringLiteralExpr
						(MethodCallExpr
							SimpleName
							(MethodCallExpr
								SimpleName
								(MethodCallExpr
									SimpleName
									(MethodCallExpr
										StringLiteralExpr
										StringLiteralExpr
										SimpleName
										(MethodCallExpr
											SimpleName
											(MethodCallExpr
												SimpleName
												(MethodCallExpr
													StringLiteralExpr
													StringLiteralExpr
													SimpleName
													(MethodCallExpr
														StringLiteralExpr
														SimpleName
														(MethodCallExpr
															SimpleName
															(MethodCallExpr
																StringLiteralExpr
																StringLiteralExpr
																SimpleName
																(MethodCallExpr
																	StringLiteralExpr
																	StringLiteralExpr
																	SimpleName
																	(MethodCallExpr
																		StringLiteralExpr
																		StringLiteralExpr
																		SimpleName
																		(MethodCallExpr
																			StringLiteralExpr
																			StringLiteralExpr
																			SimpleName
																			(MethodCallExpr
																				StringLiteralExpr
																				SimpleName
																				(MethodCallExpr
																					StringLiteralExpr
																					SimpleName
																					(MethodCallExpr
																						StringLiteralExpr
																						SimpleName
																						(MethodCallExpr
																							StringLiteralExpr
																							SimpleName
																							(MethodCallExpr
																								StringLiteralExpr
																								SimpleName
																								(MethodCallExpr
																									SimpleName
																									(MethodCallExpr
																										SimpleName
																									)
																								)
																							)
																						)
																					)
																				)
																			)
																		)
																	)
																)
															)
														)
													)
												)
											)
										)
									)
								)
							)
						)
						SimpleName
						(MethodCallExpr
							StringLiteralExpr
							SimpleName
						)
					)
				)
				SimpleName
			)
		)
		(ExpressionStmt
			(MethodCallExpr
				SimpleName
			)
		)
		(ExpressionStmt
			(MethodCallExpr
				SimpleName
				(MethodCallExpr
					StringLiteralExpr
					StringLiteralExpr
					SimpleName
					(MethodCallExpr
						StringLiteralExpr
						StringLiteralExpr
						StringLiteralExpr
						SimpleName
						(MethodCallExpr
							SimpleName
						)
					)
				)
			)
		)
		(ExpressionStmt
			(MethodCallExpr
				SimpleName
			)
		)
		(ExpressionStmt
			(VariableDeclarationExpr
				(VariableDeclarator
					(MethodCallExpr
						SimpleName
						(MethodCallExpr
							SimpleName
							(MethodCallExpr
								(MethodCallExpr
									StringLiteralExpr
									SimpleName
									(ObjectCreationExpr
										(ClassOrInterfaceType
											SimpleName
										)
									)
								)
								SimpleName
								(MethodCallExpr
									(MethodCallExpr
										(FieldAccessExpr
											SimpleName
											NameExpr
												SimpleName
										)
										SimpleName
										(MethodCallExpr
											StringLiteralExpr
											StringLiteralExpr
											SimpleName
										)
									)
									SimpleName
									(MethodCallExpr
										StringLiteralExpr
										SimpleName
										(MethodCallExpr
											StringLiteralExpr
											SimpleName
											(MethodCallExpr
												SimpleName
											)
										)
									)
								)
							)
						)
					)
					SimpleName
					(ClassOrInterfaceType
						SimpleName
					)
				)
			)
		)
		(ExpressionStmt
			(MethodCallExpr
				NameExpr
					SimpleName
				(IntegerLiteralExpr
				)
				StringLiteralExpr
				(IntegerLiteralExpr
				)
				(MethodCallExpr
					StringLiteralExpr
					SimpleName
				)
				SimpleName
			)
		)
	)
	(VoidType
	)
	SimpleName
	(ClassOrInterfaceType
		SimpleName
	)
	(MarkerAnnotationExpr
		Name
	)
)
||||||||(MethodDeclaration
	(BlockStmt
		(ExpressionStmt
			(MethodCallExpr
				(MethodCallExpr
					(MethodCallExpr
						StringLiteralExpr
						StringLiteralExpr
						StringLiteralExpr
						SimpleName
						(MethodCallExpr
							StringLiteralExpr
							StringLiteralExpr
							SimpleName
							(MethodCallExpr
								StringLiteralExpr
								StringLiteralExpr
								StringLiteralExpr
								SimpleName
								(MethodCallExpr
									StringLiteralExpr
									StringLiteralExpr
									SimpleName
									(MethodCallExpr
										StringLiteralExpr
										(BooleanLiteralExpr
										)
										SimpleName
										(MethodCallExpr
											StringLiteralExpr
											(BooleanLiteralExpr
											)
											SimpleName
											(MethodCallExpr
												StringLiteralExpr
												(BooleanLiteralExpr
												)
												SimpleName
												(MethodCallExpr
													StringLiteralExpr
													(BooleanLiteralExpr
													)
													SimpleName
													(MethodCallExpr
														StringLiteralExpr
														(BooleanLiteralExpr
														)
														SimpleName
														(MethodCallExpr
															StringLiteralExpr
															(BooleanLiteralExpr
															)
															SimpleName
															(MethodCallExpr
																StringLiteralExpr
																StringLiteralExpr
																StringLiteralExpr
																StringLiteralExpr
																StringLiteralExpr
																StringLiteralExpr
																StringLiteralExpr
																StringLiteralExpr
																StringLiteralExpr
																StringLiteralExpr
																StringLiteralExpr
																StringLiteralExpr
																StringLiteralExpr
																StringLiteralExpr
																StringLiteralExpr
																StringLiteralExpr
																StringLiteralExpr
																StringLiteralExpr
																StringLiteralExpr
																StringLiteralExpr
																StringLiteralExpr
																StringLiteralExpr
																StringLiteralExpr
																SimpleName
																(MethodCallExpr
																	StringLiteralExpr
																	StringLiteralExpr
																	SimpleName
																	(MethodCallExpr
																		StringLiteralExpr
																		StringLiteralExpr
																		SimpleName
																		(MethodCallExpr
																			StringLiteralExpr
																			StringLiteralExpr
																			SimpleName
																			(MethodCallExpr
																				StringLiteralExpr
																				(IntegerLiteralExpr
																				)
																				SimpleName
																				(MethodCallExpr
																					StringLiteralExpr
																					(IntegerLiteralExpr
																					)
																					SimpleName
																					(MethodCallExpr
																						(MethodCallExpr
																							SimpleName
																						)
																						SimpleName
																						(MethodCallExpr
																							SimpleName
																						)
																					)
																				)
																			)
																		)
																	)
																)
															)
														)
													)
												)
											)
										)
									)
								)
							)
						)
					)
					SimpleName
					(MethodCallExpr
						StringLiteralExpr
						(MethodCallExpr
							SimpleName
							(MethodCallExpr
								SimpleName
								(MethodCallExpr
									SimpleName
									(MethodCallExpr
										StringLiteralExpr
										StringLiteralExpr
										SimpleName
										(MethodCallExpr
											SimpleName
											(MethodCallExpr
												SimpleName
												(MethodCallExpr
													StringLiteralExpr
													StringLiteralExpr
													SimpleName
													(MethodCallExpr
														StringLiteralExpr
														SimpleName
														(MethodCallExpr
															SimpleName
															(MethodCallExpr
																StringLiteralExpr
																StringLiteralExpr
																SimpleName
																(MethodCallExpr
																	StringLiteralExpr
																	StringLiteralExpr
																	SimpleName
																	(MethodCallExpr
																		StringLiteralExpr
																		StringLiteralExpr
																		SimpleName
																		(MethodCallExpr
																			StringLiteralExpr
																			StringLiteralExpr
																			SimpleName
																			(MethodCallExpr
																				StringLiteralExpr
																				SimpleName
																				(MethodCallExpr
																					StringLiteralExpr
																					SimpleName
																					(MethodCallExpr
																						StringLiteralExpr
																						SimpleName
																						(MethodCallExpr
																							StringLiteralExpr
																							SimpleName
																							(MethodCallExpr
																								StringLiteralExpr
																								SimpleName
																								(MethodCallExpr
																									SimpleName
																									(MethodCallExpr
																										SimpleName
																									)
																								)
																							)
																						)
																					)
																				)
																			)
																		)
																	)
																)
															)
														)
													)
												)
											)
										)
									)
								)
							)
						)
						SimpleName
						(MethodCallExpr
							StringLiteralExpr
							SimpleName
						)
					)
				)
				SimpleName
			)
		)
		(ExpressionStmt
			(MethodCallExpr
				SimpleName
			)
		)
		(ExpressionStmt
			(MethodCallExpr
				SimpleName
				(MethodCallExpr
					StringLiteralExpr
					StringLiteralExpr
					SimpleName
					(MethodCallExpr
						StringLiteralExpr
						StringLiteralExpr
						StringLiteralExpr
						SimpleName
						(MethodCallExpr
							SimpleName
						)
					)
				)
			)
		)
		(ExpressionStmt
			(MethodCallExpr
				SimpleName
			)
		)
		(ExpressionStmt
			(VariableDeclarationExpr
				(VariableDeclarator
					(MethodCallExpr
						SimpleName
						(MethodCallExpr
							SimpleName
							(MethodCallExpr
								(MethodCallExpr
									StringLiteralExpr
									SimpleName
									(ObjectCreationExpr
										(ClassOrInterfaceType
											SimpleName
										)
									)
								)
								SimpleName
								(MethodCallExpr
									(MethodCallExpr
										(FieldAccessExpr
											SimpleName
											NameExpr
												SimpleName
										)
										SimpleName
										(MethodCallExpr
											StringLiteralExpr
											StringLiteralExpr
											SimpleName
										)
									)
									SimpleName
									(MethodCallExpr
										StringLiteralExpr
										SimpleName
										(MethodCallExpr
											StringLiteralExpr
											SimpleName
											(MethodCallExpr
												SimpleName
											)
										)
									)
								)
							)
						)
					)
					SimpleName
					(ClassOrInterfaceType
						SimpleName
					)
				)
			)
		)
		(ExpressionStmt
			(MethodCallExpr
				NameExpr
					SimpleName
				(IntegerLiteralExpr
				)
				StringLiteralExpr
				(IntegerLiteralExpr
				)
				(MethodCallExpr
					StringLiteralExpr
					SimpleName
				)
				SimpleName
			)
		)
	)
	(VoidType
	)
	SimpleName
	(ClassOrInterfaceType
		SimpleName
	)
)

