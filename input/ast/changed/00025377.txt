    public function login() {

        if (!empty($_POST['user_name']) && !empty($_POST['user_password'])) {

            // get user's data
            // (we check if the password fits the password_hash via password_verify() some lines below)
            $sth = $this->db->prepare("SELECT user_id,
                                              user_name,
                                              user_email,
                                              user_password_hash,
                                              user_active,
                                              user_account_type,
                                              user_failed_logins,
                                              user_last_failed_login
                                       FROM users
                                       WHERE user_name = :user_name ;");
            $sth->execute(array(':user_name' => $_POST['user_name']));

            $count =  $sth->rowCount();
            if ($count == 1) {

                // fetch one row (we only have one result)
                $result = $sth->fetch();

                if ( ($result->user_failed_logins >= 2) && ($result->user_last_failed_login > (time()-30)) ) {

                    $this->errors[] = FEEDBACK_PASSWORD_WRONG_3_TIMES;
                    return false;

                } else {

                    if (password_verify($_POST['user_password'], $result->user_password_hash)) {

                        if ($result->user_active == 1) {

                            // login
                            Session::init();
                            Session::set('user_logged_in', true);
                            Session::set('user_id', $result->user_id);
                            Session::set('user_name', $result->user_name);
                            Session::set('user_email', $result->user_email);
                            Session::set('user_account_type', $result->user_account_type);

                            Session::set('user_avatar_file', $this->getUserAvatarFilePath());

                            // call the setGravatarImageUrl() method which writes gravatar urls into the session
                            $this->setGravatarImageUrl($result->user_email);

                            // reset the failed login counter for that user
                            $sth = $this->db->prepare("UPDATE users SET user_failed_logins = 0, user_last_failed_login = NULL WHERE user_id = :user_id AND user_failed_logins != 0");
                            $sth->execute(array(':user_id' => $result->user_id));

                            // if user has check the "remember me" checkbox, then write cookie
                            if (isset($_POST['user_rememberme'])) {

                                // generate 64 char random string
                                $random_token_string = hash('sha256', mt_rand());

                                $sth = $this->db->prepare("UPDATE users SET user_rememberme_token = :user_rememberme_token WHERE user_id = :user_id");
                                $sth->execute(array(':user_rememberme_token' => $random_token_string, ':user_id' => $result->user_id));

                                // generate cookie string that consists of userid, randomstring and combined hash of both
                                $cookie_string_first_part = $result->user_id . ':' . $random_token_string;
                                $cookie_string_hash = hash('sha256', $cookie_string_first_part);
                                $cookie_string = $cookie_string_first_part . ':' . $cookie_string_hash;

                                // set cookie
                                setcookie('rememberme', $cookie_string, time() + COOKIE_RUNTIME, "/", COOKIE_DOMAIN);
                            }

                            return true;

                        } else {

                            $this->errors[] = FEEDBACK_ACCOUNT_NOT_ACTIVATED_YET;
                            return false;
                        }

                    } else {

                        // increment the failed login counter for that user
                        $sth = $this->db->prepare("UPDATE users "
                                . "SET user_failed_logins = user_failed_logins+1, user_last_failed_login = :user_last_failed_login "
                                . "WHERE user_name = :user_name");
                        $sth->execute(array(':user_name' => $_POST['user_name'], ':user_last_failed_login' => time() ));

                        $this->errors[] = FEEDBACK_PASSWORD_WRONG;
                        return false;
                    }

                }

            } else {

                $this->errors[] = FEEDBACK_USER_DOES_NOT_EXIST;
                return false;
            }

        } elseif (empty($_POST['user_name'])) {

            $this->errors[] = FEEDBACK_USERNAME_FIELD_EMPTY;

        } elseif (empty($_POST['user_password'])) {

            $this->errors[] = FEEDBACK_PASSWORD_FIELD_EMPTY;
        }

    }


||||||||    public function login()
    {
        if (!empty($_POST['user_name']) && !empty($_POST['user_password'])) {

            // get user's data
            // (we check if the password fits the password_hash via password_verify() some lines below)
            $sth = $this->db->prepare("SELECT user_id,
                                              user_name,
                                              user_email,
                                              user_password_hash,
                                              user_active,
                                              user_account_type,
                                              user_failed_logins,
                                              user_last_failed_login
                                       FROM users
                                       WHERE user_name = :user_name ;");
            $sth->execute(array(':user_name' => $_POST['user_name']));

            $count =  $sth->rowCount();
            if ($count == 1) {

                // fetch one row (we only have one result)
                $result = $sth->fetch();

                if ( ($result->user_failed_logins >= 2) && ($result->user_last_failed_login > (time()-30)) ) {

                    $this->errors[] = FEEDBACK_PASSWORD_WRONG_3_TIMES;
                    return false;

                } else {

                    if (password_verify($_POST['user_password'], $result->user_password_hash)) {

                        if ($result->user_active == 1) {

                            // login
                            Session::init();
                            Session::set('user_logged_in', true);
                            Session::set('user_id', $result->user_id);
                            Session::set('user_name', $result->user_name);
                            Session::set('user_email', $result->user_email);
                            Session::set('user_account_type', $result->user_account_type);

                            Session::set('user_avatar_file', $this->getUserAvatarFilePath());

                            // call the setGravatarImageUrl() method which writes gravatar urls into the session
                            $this->setGravatarImageUrl($result->user_email);

                            // reset the failed login counter for that user
                            $sth = $this->db->prepare("UPDATE users SET user_failed_logins = 0, user_last_failed_login = NULL WHERE user_id = :user_id AND user_failed_logins != 0");
                            $sth->execute(array(':user_id' => $result->user_id));

                            // if user has check the "remember me" checkbox, then write cookie
                            if (isset($_POST['user_rememberme'])) {

                                // generate 64 char random string
                                $random_token_string = hash('sha256', mt_rand());

                                $sth = $this->db->prepare("UPDATE users SET user_rememberme_token = :user_rememberme_token WHERE user_id = :user_id");
                                $sth->execute(array(':user_rememberme_token' => $random_token_string, ':user_id' => $result->user_id));

                                // generate cookie string that consists of userid, randomstring and combined hash of both
                                $cookie_string_first_part = $result->user_id . ':' . $random_token_string;
                                $cookie_string_hash = hash('sha256', $cookie_string_first_part);
                                $cookie_string = $cookie_string_first_part . ':' . $cookie_string_hash;

                                // set cookie
                                setcookie('rememberme', $cookie_string, time() + COOKIE_RUNTIME, "/", COOKIE_DOMAIN);
                            }

                            return true;

                        } else {

                            $this->errors[] = FEEDBACK_ACCOUNT_NOT_ACTIVATED_YET;
                            return false;
                        }

                    } else {

                        // increment the failed login counter for that user
                        $sth = $this->db->prepare("UPDATE users "
                                . "SET user_failed_logins = user_failed_logins+1, user_last_failed_login = :user_last_failed_login "
                                . "WHERE user_name = :user_name");
                        $sth->execute(array(':user_name' => $_POST['user_name'], ':user_last_failed_login' => time() ));

                        $this->errors[] = FEEDBACK_PASSWORD_WRONG;
                        return false;
                    }

                }

            } else {

                $this->errors[] = FEEDBACK_USER_DOES_NOT_EXIST;
                return false;
            }

        } elseif (empty($_POST['user_name'])) {

            $this->errors[] = FEEDBACK_USERNAME_FIELD_EMPTY;

        } elseif (empty($_POST['user_password'])) {

            $this->errors[] = FEEDBACK_PASSWORD_FIELD_EMPTY;
        }

    }

    /**
     * performs the login via cookie
     * TODO: hardcore refactoring
     * @return bool success state
     */
||||||||NO_DOC_COMMENTNO_RETURN_TYPE
(
    (AST_IF
        (AST_IF_ELEM
            (AST_BINARY_OP
                (AST_UNARY_OP
                    (AST_EMPTY
                        (AST_DIM
                            (AST_VAR)
                            (SCALAR))))
                (AST_UNARY_OP
                    (AST_EMPTY
                        (AST_DIM
                            (AST_VAR)
                            (SCALAR)))))
            (
                (AST_ASSIGN
                    (AST_VAR)
                    (AST_METHOD_CALL
                        (AST_PROP
                            (AST_VAR))
                        (
                            (SCALAR))))
                (AST_METHOD_CALL
                    (AST_VAR)
                    (
                        (AST_ARRAY
                            (AST_ARRAY_ELEM
                                (AST_DIM
                                    (AST_VAR)
                                    (SCALAR))
                                (SCALAR)))))
                (AST_ASSIGN
                    (AST_VAR)
                    (AST_METHOD_CALL
                        (AST_VAR)))
                (AST_IF
                    (AST_IF_ELEM
                        (AST_BINARY_OP
                            (AST_VAR)
                            (SCALAR))
                        (
                            (AST_ASSIGN
                                (AST_VAR)
                                (AST_METHOD_CALL
                                    (AST_VAR)))
                            (AST_IF
                                (AST_IF_ELEM
                                    (AST_BINARY_OP
                                        (AST_BINARY_OP
                                            (AST_PROP
                                                (AST_VAR))
                                            (SCALAR))
                                        (AST_BINARY_OP
                                            (AST_PROP
                                                (AST_VAR))
                                            (AST_BINARY_OP
                                                (AST_CALL)
                                                (SCALAR))))
                                    (
                                        (AST_ASSIGN
                                            (AST_DIM
                                                (AST_PROP
                                                    (AST_VAR))
                                                (NULL))
                                            (AST_CONST))
                                        (AST_RETURN
                                            (AST_CONST))))
                                (AST_IF_ELEM
                                    (NULL)
                                    (
                                        (AST_IF
                                            (AST_IF_ELEM
                                                (AST_CALL
                                                    (
                                                        (AST_DIM
                                                            (AST_VAR)
                                                            (SCALAR))
                                                        (AST_PROP
                                                            (AST_VAR))))
                                                (
                                                    (AST_IF
                                                        (AST_IF_ELEM
                                                            (AST_BINARY_OP
                                                                (AST_PROP
                                                                    (AST_VAR))
                                                                (SCALAR))
                                                            (
                                                                (AST_STATIC_CALL)
                                                                (AST_STATIC_CALL
                                                                    (
                                                                        (SCALAR)
                                                                        (AST_CONST)))
                                                                (AST_STATIC_CALL
                                                                    (
                                                                        (SCALAR)
                                                                        (AST_PROP
                                                                            (AST_VAR))))
                                                                (AST_STATIC_CALL
                                                                    (
                                                                        (SCALAR)
                                                                        (AST_PROP
                                                                            (AST_VAR))))
                                                                (AST_STATIC_CALL
                                                                    (
                                                                        (SCALAR)
                                                                        (AST_PROP
                                                                            (AST_VAR))))
                                                                (AST_STATIC_CALL
                                                                    (
                                                                        (SCALAR)
                                                                        (AST_PROP
                                                                            (AST_VAR))))
                                                                (AST_STATIC_CALL
                                                                    (
                                                                        (SCALAR)
                                                                        (AST_METHOD_CALL
                                                                            (AST_VAR))))
                                                                (AST_METHOD_CALL
                                                                    (AST_VAR)
                                                                    (
                                                                        (AST_PROP
                                                                            (AST_VAR))))
                                                                (AST_ASSIGN
                                                                    (AST_VAR)
                                                                    (AST_METHOD_CALL
                                                                        (AST_PROP
                                                                            (AST_VAR))
                                                                        (
                                                                            (SCALAR))))
                                                                (AST_METHOD_CALL
                                                                    (AST_VAR)
                                                                    (
                                                                        (AST_ARRAY
                                                                            (AST_ARRAY_ELEM
                                                                                (AST_PROP
                                                                                    (AST_VAR))
                                                                                (SCALAR)))))
                                                                (AST_IF
                                                                    (AST_IF_ELEM
                                                                        (AST_ISSET
                                                                            (AST_DIM
                                                                                (AST_VAR)
                                                                                (SCALAR)))
                                                                        (
                                                                            (AST_ASSIGN
                                                                                (AST_VAR)
                                                                                (AST_CALL
                                                                                    (
                                                                                        (SCALAR)
                                                                                        (AST_CALL))))
                                                                            (AST_ASSIGN
                                                                                (AST_VAR)
                                                                                (AST_METHOD_CALL
                                                                                    (AST_PROP
                                                                                        (AST_VAR))
                                                                                    (
                                                                                        (SCALAR))))
                                                                            (AST_METHOD_CALL
                                                                                (AST_VAR)
                                                                                (
                                                                                    (AST_ARRAY
                                                                                        (AST_ARRAY_ELEM
                                                                                            (AST_VAR)
                                                                                            (SCALAR))
                                                                                        (AST_ARRAY_ELEM
                                                                                            (AST_PROP
                                                                                                (AST_VAR))
                                                                                            (SCALAR)))))
                                                                            (AST_ASSIGN
                                                                                (AST_VAR)
                                                                                (AST_BINARY_OP
                                                                                    (AST_BINARY_OP
                                                                                        (AST_PROP
                                                                                            (AST_VAR))
                                                                                        (SCALAR))
                                                                                    (AST_VAR)))
                                                                            (AST_ASSIGN
                                                                                (AST_VAR)
                                                                                (AST_CALL
                                                                                    (
                                                                                        (SCALAR)
                                                                                        (AST_VAR))))
                                                                            (AST_ASSIGN
                                                                                (AST_VAR)
                                                                                (AST_BINARY_OP
                                                                                    (AST_BINARY_OP
                                                                                        (AST_VAR)
                                                                                        (SCALAR))
                                                                                    (AST_VAR)))
                                                                            (AST_CALL
                                                                                (
                                                                                    (SCALAR)
                                                                                    (AST_VAR)
                                                                                    (AST_BINARY_OP
                                                                                        (AST_CALL)
                                                                                        (AST_CONST))
                                                                                    (SCALAR)
                                                                                    (AST_CONST))))))
                                                                (AST_RETURN
                                                                    (AST_CONST))))
                                                        (AST_IF_ELEM
                                                            (NULL)
                                                            (
                                                                (AST_ASSIGN
                                                                    (AST_DIM
                                                                        (AST_PROP
                                                                            (AST_VAR))
                                                                        (NULL))
                                                                    (AST_CONST))
                                                                (AST_RETURN
                                                                    (AST_CONST)))))))
                                            (AST_IF_ELEM
                                                (NULL)
                                                (
                                                    (AST_ASSIGN
                                                        (AST_VAR)
                                                        (AST_METHOD_CALL
                                                            (AST_PROP
                                                                (AST_VAR))
                                                            (
                                                                (AST_BINARY_OP
                                                                    (AST_BINARY_OP
                                                                        (SCALAR)
                                                                        (SCALAR))
                                                                    (SCALAR)))))
                                                    (AST_METHOD_CALL
                                                        (AST_VAR)
                                                        (
                                                            (AST_ARRAY
                                                                (AST_ARRAY_ELEM
                                                                    (AST_DIM
                                                                        (AST_VAR)
                                                                        (SCALAR))
                                                                    (SCALAR))
                                                                (AST_ARRAY_ELEM
                                                                    (AST_CALL)
                                                                    (SCALAR)))))
                                                    (AST_ASSIGN
                                                        (AST_DIM
                                                            (AST_PROP
                                                                (AST_VAR))
                                                            (NULL))
                                                        (AST_CONST))
                                                    (AST_RETURN
                                                        (AST_CONST))))))))))
                    (AST_IF_ELEM
                        (NULL)
                        (
                            (AST_ASSIGN
                                (AST_DIM
                                    (AST_PROP
                                        (AST_VAR))
                                    (NULL))
                                (AST_CONST))
                            (AST_RETURN
                                (AST_CONST)))))))
        (AST_IF_ELEM
            (AST_EMPTY
                (AST_DIM
                    (AST_VAR)
                    (SCALAR)))
            (
                (AST_ASSIGN
                    (AST_DIM
                        (AST_PROP
                            (AST_VAR))
                        (NULL))
                    (AST_CONST))))
        (AST_IF_ELEM
            (AST_EMPTY
                (AST_DIM
                    (AST_VAR)
                    (SCALAR)))
            (
                (AST_ASSIGN
                    (AST_DIM
                        (AST_PROP
                            (AST_VAR))
                        (NULL))
                    (AST_CONST))))))||||||||HAS_DOC_COMMENTNO_RETURN_TYPE
(
    (AST_IF
        (AST_IF_ELEM
            (AST_BINARY_OP
                (AST_UNARY_OP
                    (AST_EMPTY
                        (AST_DIM
                            (AST_VAR)
                            (SCALAR))))
                (AST_UNARY_OP
                    (AST_EMPTY
                        (AST_DIM
                            (AST_VAR)
                            (SCALAR)))))
            (
                (AST_ASSIGN
                    (AST_VAR)
                    (AST_METHOD_CALL
                        (AST_PROP
                            (AST_VAR))
                        (
                            (SCALAR))))
                (AST_METHOD_CALL
                    (AST_VAR)
                    (
                        (AST_ARRAY
                            (AST_ARRAY_ELEM
                                (AST_DIM
                                    (AST_VAR)
                                    (SCALAR))
                                (SCALAR)))))
                (AST_ASSIGN
                    (AST_VAR)
                    (AST_METHOD_CALL
                        (AST_VAR)))
                (AST_IF
                    (AST_IF_ELEM
                        (AST_BINARY_OP
                            (AST_VAR)
                            (SCALAR))
                        (
                            (AST_ASSIGN
                                (AST_VAR)
                                (AST_METHOD_CALL
                                    (AST_VAR)))
                            (AST_IF
                                (AST_IF_ELEM
                                    (AST_BINARY_OP
                                        (AST_BINARY_OP
                                            (AST_PROP
                                                (AST_VAR))
                                            (SCALAR))
                                        (AST_BINARY_OP
                                            (AST_PROP
                                                (AST_VAR))
                                            (AST_BINARY_OP
                                                (AST_CALL)
                                                (SCALAR))))
                                    (
                                        (AST_ASSIGN
                                            (AST_DIM
                                                (AST_PROP
                                                    (AST_VAR))
                                                (NULL))
                                            (AST_CONST))
                                        (AST_RETURN
                                            (AST_CONST))))
                                (AST_IF_ELEM
                                    (NULL)
                                    (
                                        (AST_IF
                                            (AST_IF_ELEM
                                                (AST_CALL
                                                    (
                                                        (AST_DIM
                                                            (AST_VAR)
                                                            (SCALAR))
                                                        (AST_PROP
                                                            (AST_VAR))))
                                                (
                                                    (AST_IF
                                                        (AST_IF_ELEM
                                                            (AST_BINARY_OP
                                                                (AST_PROP
                                                                    (AST_VAR))
                                                                (SCALAR))
                                                            (
                                                                (AST_STATIC_CALL)
                                                                (AST_STATIC_CALL
                                                                    (
                                                                        (SCALAR)
                                                                        (AST_CONST)))
                                                                (AST_STATIC_CALL
                                                                    (
                                                                        (SCALAR)
                                                                        (AST_PROP
                                                                            (AST_VAR))))
                                                                (AST_STATIC_CALL
                                                                    (
                                                                        (SCALAR)
                                                                        (AST_PROP
                                                                            (AST_VAR))))
                                                                (AST_STATIC_CALL
                                                                    (
                                                                        (SCALAR)
                                                                        (AST_PROP
                                                                            (AST_VAR))))
                                                                (AST_STATIC_CALL
                                                                    (
                                                                        (SCALAR)
                                                                        (AST_PROP
                                                                            (AST_VAR))))
                                                                (AST_STATIC_CALL
                                                                    (
                                                                        (SCALAR)
                                                                        (AST_METHOD_CALL
                                                                            (AST_VAR))))
                                                                (AST_METHOD_CALL
                                                                    (AST_VAR)
                                                                    (
                                                                        (AST_PROP
                                                                            (AST_VAR))))
                                                                (AST_ASSIGN
                                                                    (AST_VAR)
                                                                    (AST_METHOD_CALL
                                                                        (AST_PROP
                                                                            (AST_VAR))
                                                                        (
                                                                            (SCALAR))))
                                                                (AST_METHOD_CALL
                                                                    (AST_VAR)
                                                                    (
                                                                        (AST_ARRAY
                                                                            (AST_ARRAY_ELEM
                                                                                (AST_PROP
                                                                                    (AST_VAR))
                                                                                (SCALAR)))))
                                                                (AST_IF
                                                                    (AST_IF_ELEM
                                                                        (AST_ISSET
                                                                            (AST_DIM
                                                                                (AST_VAR)
                                                                                (SCALAR)))
                                                                        (
                                                                            (AST_ASSIGN
                                                                                (AST_VAR)
                                                                                (AST_CALL
                                                                                    (
                                                                                        (SCALAR)
                                                                                        (AST_CALL))))
                                                                            (AST_ASSIGN
                                                                                (AST_VAR)
                                                                                (AST_METHOD_CALL
                                                                                    (AST_PROP
                                                                                        (AST_VAR))
                                                                                    (
                                                                                        (SCALAR))))
                                                                            (AST_METHOD_CALL
                                                                                (AST_VAR)
                                                                                (
                                                                                    (AST_ARRAY
                                                                                        (AST_ARRAY_ELEM
                                                                                            (AST_VAR)
                                                                                            (SCALAR))
                                                                                        (AST_ARRAY_ELEM
                                                                                            (AST_PROP
                                                                                                (AST_VAR))
                                                                                            (SCALAR)))))
                                                                            (AST_ASSIGN
                                                                                (AST_VAR)
                                                                                (AST_BINARY_OP
                                                                                    (AST_BINARY_OP
                                                                                        (AST_PROP
                                                                                            (AST_VAR))
                                                                                        (SCALAR))
                                                                                    (AST_VAR)))
                                                                            (AST_ASSIGN
                                                                                (AST_VAR)
                                                                                (AST_CALL
                                                                                    (
                                                                                        (SCALAR)
                                                                                        (AST_VAR))))
                                                                            (AST_ASSIGN
                                                                                (AST_VAR)
                                                                                (AST_BINARY_OP
                                                                                    (AST_BINARY_OP
                                                                                        (AST_VAR)
                                                                                        (SCALAR))
                                                                                    (AST_VAR)))
                                                                            (AST_CALL
                                                                                (
                                                                                    (SCALAR)
                                                                                    (AST_VAR)
                                                                                    (AST_BINARY_OP
                                                                                        (AST_CALL)
                                                                                        (AST_CONST))
                                                                                    (SCALAR)
                                                                                    (AST_CONST))))))
                                                                (AST_RETURN
                                                                    (AST_CONST))))
                                                        (AST_IF_ELEM
                                                            (NULL)
                                                            (
                                                                (AST_ASSIGN
                                                                    (AST_DIM
                                                                        (AST_PROP
                                                                            (AST_VAR))
                                                                        (NULL))
                                                                    (AST_CONST))
                                                                (AST_RETURN
                                                                    (AST_CONST)))))))
                                            (AST_IF_ELEM
                                                (NULL)
                                                (
                                                    (AST_ASSIGN
                                                        (AST_VAR)
                                                        (AST_METHOD_CALL
                                                            (AST_PROP
                                                                (AST_VAR))
                                                            (
                                                                (AST_BINARY_OP
                                                                    (AST_BINARY_OP
                                                                        (SCALAR)
                                                                        (SCALAR))
                                                                    (SCALAR)))))
                                                    (AST_METHOD_CALL
                                                        (AST_VAR)
                                                        (
                                                            (AST_ARRAY
                                                                (AST_ARRAY_ELEM
                                                                    (AST_DIM
                                                                        (AST_VAR)
                                                                        (SCALAR))
                                                                    (SCALAR))
                                                                (AST_ARRAY_ELEM
                                                                    (AST_CALL)
                                                                    (SCALAR)))))
                                                    (AST_ASSIGN
                                                        (AST_DIM
                                                            (AST_PROP
                                                                (AST_VAR))
                                                            (NULL))
                                                        (AST_CONST))
                                                    (AST_RETURN
                                                        (AST_CONST))))))))))
                    (AST_IF_ELEM
                        (NULL)
                        (
                            (AST_ASSIGN
                                (AST_DIM
                                    (AST_PROP
                                        (AST_VAR))
                                    (NULL))
                                (AST_CONST))
                            (AST_RETURN
                                (AST_CONST)))))))
        (AST_IF_ELEM
            (AST_EMPTY
                (AST_DIM
                    (AST_VAR)
                    (SCALAR)))
            (
                (AST_ASSIGN
                    (AST_DIM
                        (AST_PROP
                            (AST_VAR))
                        (NULL))
                    (AST_CONST))))
        (AST_IF_ELEM
            (AST_EMPTY
                (AST_DIM
                    (AST_VAR)
                    (SCALAR)))
            (
                (AST_ASSIGN
                    (AST_DIM
                        (AST_PROP
                            (AST_VAR))
                        (NULL))
                    (AST_CONST))))))