  protected function executeChecks() {
    if (!$this->shouldUseElasticSearchEngine()) {
      return;
    }

    $engine = new PhabricatorElasticFulltextStorageEngine();

    $index_exists = null;
    $index_sane = null;
    try {
      $index_exists = $engine->indexExists();
      if ($index_exists) {
        $index_sane = $engine->indexIsSane();
      }
    } catch (Exception $ex) {
      $summary = pht('Elasticsearch is not reachable as configured.');
      $message = pht(
        'Elasticsearch is configured (with the %s setting) but Phabricator '.
        'encountered an exception when trying to test the index.'.
        "\n\n".
        '%s',
        phutil_tag('tt', array(), 'search.elastic.host'),
        phutil_tag('pre', array(), $ex->getMessage()));

      $this->newIssue('elastic.misconfigured')
        ->setName(pht('Elasticsearch Misconfigured'))
        ->setSummary($summary)
        ->setMessage($message)
        ->addRelatedPhabricatorConfig('search.elastic.host');
      return;
    }

    if (!$index_exists) {
      $summary = pht(
        'You enabled Elasticsearch but the index does not exist.');

      $message = pht(
        'You likely enabled search.elastic.host without creating the '.
        'index. Run `./bin/search init` to correct the index.');

      $this
        ->newIssue('elastic.missing-index')
        ->setName(pht('Elasticsearch index Not Found'))
        ->setSummary($summary)
        ->setMessage($message)
        ->addRelatedPhabricatorConfig('search.elastic.host');
    } else if (!$index_sane) {
      $summary = pht(
        'Elasticsearch index exists but needs correction.');

      $message = pht(
        'Either the Phabricator schema for Elasticsearch has changed '.
        'or Elasticsearch created the index automatically. Run '.
        '`./bin/search init` to correct the index.');

      $this
        ->newIssue('elastic.broken-index')
        ->setName(pht('Elasticsearch index Incorrect'))
        ->setSummary($summary)
        ->setMessage($message);
    }
  }

||||||||  protected function executeChecks() {
    $services = PhabricatorSearchService::getAllServices();

    foreach ($services as $service) {
      try {
        $host = $service->getAnyHostForRole('read');
      } catch (PhabricatorClusterNoHostForRoleException $e) {
        // ignore the error
        continue;
      }
      if ($host instanceof PhabricatorElasticSearchHost) {
        $index_exists = null;
        $index_sane = null;
        try {
          $engine = $host->getEngine();
          $index_exists = $engine->indexExists();
          if ($index_exists) {
            $index_sane = $engine->indexIsSane();
          }
        } catch (Exception $ex) {
          $summary = pht('Elasticsearch is not reachable as configured.');
          $message = pht(
            'Elasticsearch is configured (with the %s setting) but Phabricator'.
            ' encountered an exception when trying to test the index.'.
            "\n\n".
            '%s',
            phutil_tag('tt', array(), 'cluster.search'),
            phutil_tag('pre', array(), $ex->getMessage()));

          $this->newIssue('elastic.misconfigured')
            ->setName(pht('Elasticsearch Misconfigured'))
            ->setSummary($summary)
            ->setMessage($message)
            ->addRelatedPhabricatorConfig('cluster.search');
          return;
        }

        if (!$index_exists) {
          $summary = pht(
            'You enabled Elasticsearch but the index does not exist.');

          $message = pht(
            'You likely enabled cluster.search without creating the '.
            'index. Run `./bin/search init` to correct the index.');

          $this
            ->newIssue('elastic.missing-index')
            ->setName(pht('Elasticsearch index Not Found'))
            ->setSummary($summary)
            ->setMessage($message)
            ->addRelatedPhabricatorConfig('cluster.search');
        } else if (!$index_sane) {
          $summary = pht(
            'Elasticsearch index exists but needs correction.');

          $message = pht(
            'Either the Phabricator schema for Elasticsearch has changed '.
            'or Elasticsearch created the index automatically. Run '.
            '`./bin/search init` to correct the index.');

          $this
            ->newIssue('elastic.broken-index')
            ->setName(pht('Elasticsearch index Incorrect'))
            ->setSummary($summary)
            ->setMessage($message);
        }
      }
    }
  }


}||||||||NO_DOC_COMMENTNO_RETURN_TYPE
(
    (AST_IF
        (AST_IF_ELEM
            (AST_UNARY_OP
                (AST_METHOD_CALL
                    (AST_VAR)))
            (
                (AST_RETURN
                    (NULL)))))
    (AST_ASSIGN
        (AST_VAR)
        (AST_NEW))
    (AST_ASSIGN
        (AST_VAR)
        (AST_CONST))
    (AST_ASSIGN
        (AST_VAR)
        (AST_CONST))
    (AST_TRY
        (
            (AST_ASSIGN
                (AST_VAR)
                (AST_METHOD_CALL
                    (AST_VAR)))
            (AST_IF
                (AST_IF_ELEM
                    (AST_VAR)
                    (
                        (AST_ASSIGN
                            (AST_VAR)
                            (AST_METHOD_CALL
                                (AST_VAR)))))))
        (AST_CATCH_LIST
            (AST_CATCH
                (AST_NAME_LIST)
                (AST_VAR)
                (
                    (AST_ASSIGN
                        (AST_VAR)
                        (AST_CALL
                            (
                                (SCALAR))))
                    (AST_ASSIGN
                        (AST_VAR)
                        (AST_CALL
                            (
                                (AST_BINARY_OP
                                    (AST_BINARY_OP
                                        (AST_BINARY_OP
                                            (SCALAR)
                                            (SCALAR))
                                        (SCALAR))
                                    (SCALAR))
                                (AST_CALL
                                    (
                                        (SCALAR)
                                        (AST_ARRAY)
                                        (SCALAR)))
                                (AST_CALL
                                    (
                                        (SCALAR)
                                        (AST_ARRAY)
                                        (AST_METHOD_CALL
                                            (AST_VAR)))))))
                    (AST_METHOD_CALL
                        (AST_METHOD_CALL
                            (AST_METHOD_CALL
                                (AST_METHOD_CALL
                                    (AST_METHOD_CALL
                                        (AST_VAR)
                                        (
                                            (SCALAR)))
                                    (
                                        (AST_CALL
                                            (
                                                (SCALAR)))))
                                (
                                    (AST_VAR)))
                            (
                                (AST_VAR)))
                        (
                            (SCALAR)))
                    (AST_RETURN
                        (NULL)))))
        (NULL))
    (AST_IF
        (AST_IF_ELEM
            (AST_UNARY_OP
                (AST_VAR))
            (
                (AST_ASSIGN
                    (AST_VAR)
                    (AST_CALL
                        (
                            (SCALAR))))
                (AST_ASSIGN
                    (AST_VAR)
                    (AST_CALL
                        (
                            (AST_BINARY_OP
                                (SCALAR)
                                (SCALAR)))))
                (AST_METHOD_CALL
                    (AST_METHOD_CALL
                        (AST_METHOD_CALL
                            (AST_METHOD_CALL
                                (AST_METHOD_CALL
                                    (AST_VAR)
                                    (
                                        (SCALAR)))
                                (
                                    (AST_CALL
                                        (
                                            (SCALAR)))))
                            (
                                (AST_VAR)))
                        (
                            (AST_VAR)))
                    (
                        (SCALAR)))))
        (AST_IF_ELEM
            (NULL)
            (
                (AST_IF
                    (AST_IF_ELEM
                        (AST_UNARY_OP
                            (AST_VAR))
                        (
                            (AST_ASSIGN
                                (AST_VAR)
                                (AST_CALL
                                    (
                                        (SCALAR))))
                            (AST_ASSIGN
                                (AST_VAR)
                                (AST_CALL
                                    (
                                        (AST_BINARY_OP
                                            (AST_BINARY_OP
                                                (SCALAR)
                                                (SCALAR))
                                            (SCALAR)))))
                            (AST_METHOD_CALL
                                (AST_METHOD_CALL
                                    (AST_METHOD_CALL
                                        (AST_METHOD_CALL
                                            (AST_VAR)
                                            (
                                                (SCALAR)))
                                        (
                                            (AST_CALL
                                                (
                                                    (SCALAR)))))
                                    (
                                        (AST_VAR)))
                                (
                                    (AST_VAR))))))))))||||||||NO_DOC_COMMENTNO_RETURN_TYPE
(
    (AST_ASSIGN
        (AST_VAR)
        (AST_STATIC_CALL))
    (AST_FOREACH
        (AST_VAR)
        (AST_VAR)
        (NULL)
        (
            (AST_TRY
                (
                    (AST_ASSIGN
                        (AST_VAR)
                        (AST_METHOD_CALL
                            (AST_VAR)
                            (
                                (SCALAR)))))
                (AST_CATCH_LIST
                    (AST_CATCH
                        (AST_NAME_LIST)
                        (AST_VAR)
                        (
                            (AST_CONTINUE
                                (NULL)))))
                (NULL))
            (AST_IF
                (AST_IF_ELEM
                    (AST_INSTANCEOF
                        (AST_VAR))
                    (
                        (AST_ASSIGN
                            (AST_VAR)
                            (AST_CONST))
                        (AST_ASSIGN
                            (AST_VAR)
                            (AST_CONST))
                        (AST_TRY
                            (
                                (AST_ASSIGN
                                    (AST_VAR)
                                    (AST_METHOD_CALL
                                        (AST_VAR)))
                                (AST_ASSIGN
                                    (AST_VAR)
                                    (AST_METHOD_CALL
                                        (AST_VAR)))
                                (AST_IF
                                    (AST_IF_ELEM
                                        (AST_VAR)
                                        (
                                            (AST_ASSIGN
                                                (AST_VAR)
                                                (AST_METHOD_CALL
                                                    (AST_VAR)))))))
                            (AST_CATCH_LIST
                                (AST_CATCH
                                    (AST_NAME_LIST)
                                    (AST_VAR)
                                    (
                                        (AST_ASSIGN
                                            (AST_VAR)
                                            (AST_CALL
                                                (
                                                    (SCALAR))))
                                        (AST_ASSIGN
                                            (AST_VAR)
                                            (AST_CALL
                                                (
                                                    (AST_BINARY_OP
                                                        (AST_BINARY_OP
                                                            (AST_BINARY_OP
                                                                (SCALAR)
                                                                (SCALAR))
                                                            (SCALAR))
                                                        (SCALAR))
                                                    (AST_CALL
                                                        (
                                                            (SCALAR)
                                                            (AST_ARRAY)
                                                            (SCALAR)))
                                                    (AST_CALL
                                                        (
                                                            (SCALAR)
                                                            (AST_ARRAY)
                                                            (AST_METHOD_CALL
                                                                (AST_VAR)))))))
                                        (AST_METHOD_CALL
                                            (AST_METHOD_CALL
                                                (AST_METHOD_CALL
                                                    (AST_METHOD_CALL
                                                        (AST_METHOD_CALL
                                                            (AST_VAR)
                                                            (
                                                                (SCALAR)))
                                                        (
                                                            (AST_CALL
                                                                (
                                                                    (SCALAR)))))
                                                    (
                                                        (AST_VAR)))
                                                (
                                                    (AST_VAR)))
                                            (
                                                (SCALAR)))
                                        (AST_RETURN
                                            (NULL)))))
                            (NULL))
                        (AST_IF
                            (AST_IF_ELEM
                                (AST_UNARY_OP
                                    (AST_VAR))
                                (
                                    (AST_ASSIGN
                                        (AST_VAR)
                                        (AST_CALL
                                            (
                                                (SCALAR))))
                                    (AST_ASSIGN
                                        (AST_VAR)
                                        (AST_CALL
                                            (
                                                (AST_BINARY_OP
                                                    (SCALAR)
                                                    (SCALAR)))))
                                    (AST_METHOD_CALL
                                        (AST_METHOD_CALL
                                            (AST_METHOD_CALL
                                                (AST_METHOD_CALL
                                                    (AST_METHOD_CALL
                                                        (AST_VAR)
                                                        (
                                                            (SCALAR)))
                                                    (
                                                        (AST_CALL
                                                            (
                                                                (SCALAR)))))
                                                (
                                                    (AST_VAR)))
                                            (
                                                (AST_VAR)))
                                        (
                                            (SCALAR)))))
                            (AST_IF_ELEM
                                (NULL)
                                (
                                    (AST_IF
                                        (AST_IF_ELEM
                                            (AST_UNARY_OP
                                                (AST_VAR))
                                            (
                                                (AST_ASSIGN
                                                    (AST_VAR)
                                                    (AST_CALL
                                                        (
                                                            (SCALAR))))
                                                (AST_ASSIGN
                                                    (AST_VAR)
                                                    (AST_CALL
                                                        (
                                                            (AST_BINARY_OP
                                                                (AST_BINARY_OP
                                                                    (SCALAR)
                                                                    (SCALAR))
                                                                (SCALAR)))))
                                                (AST_METHOD_CALL
                                                    (AST_METHOD_CALL
                                                        (AST_METHOD_CALL
                                                            (AST_METHOD_CALL
                                                                (AST_VAR)
                                                                (
                                                                    (SCALAR)))
                                                            (
                                                                (AST_CALL
                                                                    (
                                                                        (SCALAR)))))
                                                        (
                                                            (AST_VAR)))
                                                    (
                                                        (AST_VAR)))))))))))))))