@SuppressWarnings("unchecked")
@Test
public void testIt() throws Exception {
    // Given
    int masterId = -1;
    int meId = -1;
    String storeDir = "dir";
    // I have a log with a transaction in the middle missing a "DONE" record
    Pair<File, Integer> broken = createBrokenLogFile(storeDir);
    File brokenLogFile = broken.first();
    Integer brokenTxIdentifier = broken.other();
    // And I've read the log header on that broken file
    FileChannel brokenLog = fs.get().open(brokenLogFile, "rw");
    ByteBuffer buffer = allocate(9 + Xid.MAXGTRIDSIZE + Xid.MAXBQUALSIZE * 10);
    readLogHeader(buffer, brokenLog, true);
    // And I have an awesome partial transaction copier
    PartialTransactionCopier copier = new PartialTransactionCopier(buffer, new CommandFactory(), StringLogger.DEV_NULL, new LogExtractor.LogPositionCache(), null, createXidMapWithOneStartEntry(masterId, /*txId=*/
    brokenTxIdentifier));
    // When
    File newLogFile = new File("new.log");
    copier.copy(brokenLog, createNewLogWithHeader(newLogFile), 1);
    // Then
    assertThat(logEntries(fs.get(), newLogFile), containsExactly(startEntry(brokenTxIdentifier, masterId, meId), nodeCommandEntry(brokenTxIdentifier, /*nodeId=*/
    2), onePhaseCommitEntry(brokenTxIdentifier, /*txid=*/
    brokenTxIdentifier), startEntry(4, masterId, meId), nodeCommandEntry(4, /*nodeId=*/
    3), onePhaseCommitEntry(4, /*txid=*/
    4), doneEntry(4), startEntry(5, masterId, meId), nodeCommandEntry(5, /*nodeId=*/
    4), onePhaseCommitEntry(5, /*txid=*/
    5), doneEntry(5)));
}||||||||@SuppressWarnings("unchecked")
@Test
public void testIt() throws Exception {
    // Given
    int masterId = -1;
    int meId = -1;
    String storeDir = "dir";
    // I have a log with a transaction in the middle missing a "DONE" record
    Pair<File, Integer> broken = createBrokenLogFile(storeDir);
    File brokenLogFile = broken.first();
    Integer brokenTxIdentifier = broken.other();
    // And I've read the log header on that broken file
    FileChannel brokenLog = fs.get().open(brokenLogFile, "rw");
    ByteBuffer buffer = allocate(9 + Xid.MAXGTRIDSIZE + Xid.MAXBQUALSIZE * 10);
    readLogHeader(buffer, brokenLog, true);
    // And I have an awesome partial transaction copier
    PartialTransactionCopier copier = new PartialTransactionCopier(buffer, new CommandFactory(), StringLogger.DEV_NULL, new LogExtractor.LogPositionCache(), null, createXidMapWithOneStartEntry(masterId, /*txId=*/
    brokenTxIdentifier));
    // When
    File newLogFile = new File("new.log");
    copier.copy(brokenLog, createNewLogWithHeader(newLogFile), 1);
    // Then
    assertThat(logEntries(fs.get(), newLogFile), containsExactly(startEntry(brokenTxIdentifier, masterId, meId), nodeCommandEntry(brokenTxIdentifier, /*nodeId=*/
    2), // but does not increment the tx id.
    onePhaseCommitEntry(brokenTxIdentifier, /*txid=*/
    3), startEntry(5, masterId, meId), nodeCommandEntry(5, /*nodeId=*/
    3), onePhaseCommitEntry(5, /*txid=*/
    4), doneEntry(5), startEntry(6, masterId, meId), nodeCommandEntry(6, /*nodeId=*/
    4), onePhaseCommitEntry(6, /*txid=*/
    5), doneEntry(6)));
}||||||||(MethodDeclaration
	(BlockStmt
		(ExpressionStmt
			(VariableDeclarationExpr
				(VariableDeclarator
					(UnaryExpr
						(IntegerLiteralExpr
						)
					)
					SimpleName
					(PrimitiveType
					)
				)
			)
			LineComment
		)
		(ExpressionStmt
			(VariableDeclarationExpr
				(VariableDeclarator
					(UnaryExpr
						(IntegerLiteralExpr
						)
					)
					SimpleName
					(PrimitiveType
					)
				)
			)
		)
		(ExpressionStmt
			(VariableDeclarationExpr
				(VariableDeclarator
					StringLiteralExpr
					SimpleName
					(ClassOrInterfaceType
						SimpleName
					)
				)
			)
		)
		(ExpressionStmt
			(VariableDeclarationExpr
				(VariableDeclarator
					(MethodCallExpr
						NameExpr
							SimpleName
						SimpleName
					)
					SimpleName
					(ClassOrInterfaceType
						SimpleName
						(ClassOrInterfaceType
							SimpleName
						)
						(ClassOrInterfaceType
							SimpleName
						)
					)
				)
			)
			LineComment
		)
		(ExpressionStmt
			(VariableDeclarationExpr
				(VariableDeclarator
					(MethodCallExpr
						SimpleName
						NameExpr
							SimpleName
					)
					SimpleName
					(ClassOrInterfaceType
						SimpleName
					)
				)
			)
		)
		(ExpressionStmt
			(VariableDeclarationExpr
				(VariableDeclarator
					(MethodCallExpr
						SimpleName
						NameExpr
							SimpleName
					)
					SimpleName
					(ClassOrInterfaceType
						SimpleName
					)
				)
			)
		)
		(ExpressionStmt
			(VariableDeclarationExpr
				(VariableDeclarator
					(MethodCallExpr
						NameExpr
							SimpleName
						StringLiteralExpr
						SimpleName
						(MethodCallExpr
							SimpleName
							NameExpr
								SimpleName
						)
					)
					SimpleName
					(ClassOrInterfaceType
						SimpleName
					)
				)
			)
			LineComment
		)
		(ExpressionStmt
			(VariableDeclarationExpr
				(VariableDeclarator
					(MethodCallExpr
						(BinaryExpr
							(BinaryExpr
								(IntegerLiteralExpr
								)
								(FieldAccessExpr
									SimpleName
									NameExpr
										SimpleName
								)
							)
							(BinaryExpr
								(FieldAccessExpr
									SimpleName
									NameExpr
										SimpleName
								)
								(IntegerLiteralExpr
								)
							)
						)
						SimpleName
					)
					SimpleName
					(ClassOrInterfaceType
						SimpleName
					)
				)
			)
		)
		(ExpressionStmt
			(MethodCallExpr
				NameExpr
					SimpleName
				NameExpr
					SimpleName
				(BooleanLiteralExpr
				)
				SimpleName
			)
		)
		(ExpressionStmt
			(VariableDeclarationExpr
				(VariableDeclarator
					(ObjectCreationExpr
						NameExpr
							SimpleName
						(ObjectCreationExpr
							(ClassOrInterfaceType
								SimpleName
							)
						)
						(FieldAccessExpr
							SimpleName
							NameExpr
								SimpleName
						)
						(ObjectCreationExpr
							(ClassOrInterfaceType
								SimpleName
								(ClassOrInterfaceType
									SimpleName
								)
							)
						)
						NullLiteralExpr
						(MethodCallExpr
							NameExpr
								SimpleName
							NameExpr
								SimpleName
								(BlockComment
								)
							SimpleName
						)
						(ClassOrInterfaceType
							SimpleName
						)
					)
					SimpleName
					(ClassOrInterfaceType
						SimpleName
					)
				)
			)
			LineComment
		)
		(ExpressionStmt
			(VariableDeclarationExpr
				(VariableDeclarator
					(ObjectCreationExpr
						StringLiteralExpr
						(ClassOrInterfaceType
							SimpleName
						)
					)
					SimpleName
					(ClassOrInterfaceType
						SimpleName
					)
				)
			)
			LineComment
		)
		(ExpressionStmt
			(MethodCallExpr
				NameExpr
					SimpleName
				(MethodCallExpr
					NameExpr
						SimpleName
					SimpleName
				)
				(IntegerLiteralExpr
				)
				SimpleName
				NameExpr
					SimpleName
			)
		)
		(ExpressionStmt
			(MethodCallExpr
				(MethodCallExpr
					(MethodCallExpr
						SimpleName
						NameExpr
							SimpleName
					)
					NameExpr
						SimpleName
					SimpleName
				)
				(MethodCallExpr
					(MethodCallExpr
						NameExpr
							SimpleName
						NameExpr
							SimpleName
						NameExpr
							SimpleName
						SimpleName
					)
					(MethodCallExpr
						NameExpr
							SimpleName
						(IntegerLiteralExpr
							(BlockComment
							)
						)
						SimpleName
					)
					(MethodCallExpr
						NameExpr
							SimpleName
						NameExpr
							SimpleName
							(BlockComment
							)
						SimpleName
					)
					(MethodCallExpr
						(IntegerLiteralExpr
						)
						NameExpr
							SimpleName
						NameExpr
							SimpleName
						SimpleName
					)
					(MethodCallExpr
						(IntegerLiteralExpr
						)
						(IntegerLiteralExpr
							(BlockComment
							)
						)
						SimpleName
					)
					(MethodCallExpr
						(IntegerLiteralExpr
						)
						(IntegerLiteralExpr
							(BlockComment
							)
						)
						SimpleName
					)
					(MethodCallExpr
						(IntegerLiteralExpr
						)
						SimpleName
					)
					(MethodCallExpr
						(IntegerLiteralExpr
						)
						NameExpr
							SimpleName
						NameExpr
							SimpleName
						SimpleName
					)
					(MethodCallExpr
						(IntegerLiteralExpr
						)
						(IntegerLiteralExpr
							(BlockComment
							)
						)
						SimpleName
					)
					(MethodCallExpr
						(IntegerLiteralExpr
						)
						(IntegerLiteralExpr
							(BlockComment
							)
						)
						SimpleName
					)
					(MethodCallExpr
						(IntegerLiteralExpr
						)
						SimpleName
					)
					SimpleName
				)
				SimpleName
			)
			LineComment
		)
	)
	(VoidType
	)
	SimpleName
	(ClassOrInterfaceType
		SimpleName
	)
	(SingleMemberAnnotationExpr
		StringLiteralExpr
		Name
	)
	(MarkerAnnotationExpr
		Name
	)
)
||||||||(MethodDeclaration
	(BlockStmt
		(ExpressionStmt
			(VariableDeclarationExpr
				(VariableDeclarator
					(UnaryExpr
						(IntegerLiteralExpr
						)
					)
					SimpleName
					(PrimitiveType
					)
				)
			)
			LineComment
		)
		(ExpressionStmt
			(VariableDeclarationExpr
				(VariableDeclarator
					(UnaryExpr
						(IntegerLiteralExpr
						)
					)
					SimpleName
					(PrimitiveType
					)
				)
			)
		)
		(ExpressionStmt
			(VariableDeclarationExpr
				(VariableDeclarator
					StringLiteralExpr
					SimpleName
					(ClassOrInterfaceType
						SimpleName
					)
				)
			)
		)
		(ExpressionStmt
			(VariableDeclarationExpr
				(VariableDeclarator
					(MethodCallExpr
						NameExpr
							SimpleName
						SimpleName
					)
					SimpleName
					(ClassOrInterfaceType
						SimpleName
						(ClassOrInterfaceType
							SimpleName
						)
						(ClassOrInterfaceType
							SimpleName
						)
					)
				)
			)
			LineComment
		)
		(ExpressionStmt
			(VariableDeclarationExpr
				(VariableDeclarator
					(MethodCallExpr
						SimpleName
						NameExpr
							SimpleName
					)
					SimpleName
					(ClassOrInterfaceType
						SimpleName
					)
				)
			)
		)
		(ExpressionStmt
			(VariableDeclarationExpr
				(VariableDeclarator
					(MethodCallExpr
						SimpleName
						NameExpr
							SimpleName
					)
					SimpleName
					(ClassOrInterfaceType
						SimpleName
					)
				)
			)
		)
		(ExpressionStmt
			(VariableDeclarationExpr
				(VariableDeclarator
					(MethodCallExpr
						NameExpr
							SimpleName
						StringLiteralExpr
						SimpleName
						(MethodCallExpr
							SimpleName
							NameExpr
								SimpleName
						)
					)
					SimpleName
					(ClassOrInterfaceType
						SimpleName
					)
				)
			)
			LineComment
		)
		(ExpressionStmt
			(VariableDeclarationExpr
				(VariableDeclarator
					(MethodCallExpr
						(BinaryExpr
							(BinaryExpr
								(IntegerLiteralExpr
								)
								(FieldAccessExpr
									SimpleName
									NameExpr
										SimpleName
								)
							)
							(BinaryExpr
								(FieldAccessExpr
									SimpleName
									NameExpr
										SimpleName
								)
								(IntegerLiteralExpr
								)
							)
						)
						SimpleName
					)
					SimpleName
					(ClassOrInterfaceType
						SimpleName
					)
				)
			)
		)
		(ExpressionStmt
			(MethodCallExpr
				NameExpr
					SimpleName
				NameExpr
					SimpleName
				(BooleanLiteralExpr
				)
				SimpleName
			)
		)
		(ExpressionStmt
			(VariableDeclarationExpr
				(VariableDeclarator
					(ObjectCreationExpr
						NameExpr
							SimpleName
						(ObjectCreationExpr
							(ClassOrInterfaceType
								SimpleName
							)
						)
						(FieldAccessExpr
							SimpleName
							NameExpr
								SimpleName
						)
						(ObjectCreationExpr
							(ClassOrInterfaceType
								SimpleName
								(ClassOrInterfaceType
									SimpleName
								)
							)
						)
						NullLiteralExpr
						(MethodCallExpr
							NameExpr
								SimpleName
							NameExpr
								SimpleName
								(BlockComment
								)
							SimpleName
						)
						(ClassOrInterfaceType
							SimpleName
						)
					)
					SimpleName
					(ClassOrInterfaceType
						SimpleName
					)
				)
			)
			LineComment
		)
		(ExpressionStmt
			(VariableDeclarationExpr
				(VariableDeclarator
					(ObjectCreationExpr
						StringLiteralExpr
						(ClassOrInterfaceType
							SimpleName
						)
					)
					SimpleName
					(ClassOrInterfaceType
						SimpleName
					)
				)
			)
			LineComment
		)
		(ExpressionStmt
			(MethodCallExpr
				NameExpr
					SimpleName
				(MethodCallExpr
					NameExpr
						SimpleName
					SimpleName
				)
				(IntegerLiteralExpr
				)
				SimpleName
				NameExpr
					SimpleName
			)
		)
		(ExpressionStmt
			(MethodCallExpr
				(MethodCallExpr
					(MethodCallExpr
						SimpleName
						NameExpr
							SimpleName
					)
					NameExpr
						SimpleName
					SimpleName
				)
				(MethodCallExpr
					(MethodCallExpr
						NameExpr
							SimpleName
						NameExpr
							SimpleName
						NameExpr
							SimpleName
						SimpleName
					)
					(MethodCallExpr
						NameExpr
							SimpleName
						(IntegerLiteralExpr
							(BlockComment
							)
						)
						SimpleName
					)
					(MethodCallExpr
						NameExpr
							SimpleName
						(IntegerLiteralExpr
							(BlockComment
							)
						)
						SimpleName
						LineComment
					)
					(MethodCallExpr
						(IntegerLiteralExpr
						)
						NameExpr
							SimpleName
						NameExpr
							SimpleName
						SimpleName
					)
					(MethodCallExpr
						(IntegerLiteralExpr
						)
						(IntegerLiteralExpr
							(BlockComment
							)
						)
						SimpleName
					)
					(MethodCallExpr
						(IntegerLiteralExpr
						)
						(IntegerLiteralExpr
							(BlockComment
							)
						)
						SimpleName
					)
					(MethodCallExpr
						(IntegerLiteralExpr
						)
						SimpleName
					)
					(MethodCallExpr
						(IntegerLiteralExpr
						)
						NameExpr
							SimpleName
						NameExpr
							SimpleName
						SimpleName
					)
					(MethodCallExpr
						(IntegerLiteralExpr
						)
						(IntegerLiteralExpr
							(BlockComment
							)
						)
						SimpleName
					)
					(MethodCallExpr
						(IntegerLiteralExpr
						)
						(IntegerLiteralExpr
							(BlockComment
							)
						)
						SimpleName
					)
					(MethodCallExpr
						(IntegerLiteralExpr
						)
						SimpleName
					)
					SimpleName
				)
				SimpleName
			)
			LineComment
		)
	)
	(VoidType
	)
	SimpleName
	(ClassOrInterfaceType
		SimpleName
	)
	(SingleMemberAnnotationExpr
		StringLiteralExpr
		Name
	)
	(MarkerAnnotationExpr
		Name
	)
)

